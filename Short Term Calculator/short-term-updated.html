<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>UTAH REIA - SHORT-TERM Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script defer="" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBv5v5ZA_pJvv_jT_ERUuXAQbG0xBqOWRY&amp;libraries=places">
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root{ --blue:#1a2a4f; --gold:#D4AF37; --green:#2E8B57; --muted:#666; --card-bg:#fff; --page-bg:#f6f7f8; --radius:14px; --maxw:1200px; }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--page-bg);color:#111}
    .wrap{max-width:var(--maxw);margin:18px auto;padding:20px;border-radius:12px;background:#fff;box-shadow:0 20px 60px rgba(10,20,30,0.06)}
    .top{display:flex;align-items:center;gap:16px;justify-content:center;margin-bottom:6px}
    .top img{height:68px}
    h1{color:var(--blue);font-size:20px;margin:6px 0 2px;text-align:center}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:12px}
    .card{background:var(--card-bg);padding:16px;border-radius:12px;margin-bottom:12px;box-shadow:0 8px 30px rgba(0,0,0,0.03)}
    @media(max-width:480px){.card{padding:12px;margin-bottom:10px;border-radius:8px}}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1 1 220px;min-width:140px;margin-bottom:10px}
    label{display:block;font-weight:600;color:var(--blue);margin-bottom:6px;font-size:13px}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e7e7e7;font-size:14px}
    @media(max-width:480px){label{font-size:12px}input[type="text"],input[type="number"],select,textarea{padding:12px;font-size:16px;border-radius:6px}}
    textarea{min-height:64px}
    .muted{color:var(--muted);font-size:13px}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap}
    .btn{background:var(--green);color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn.secondary{background:#eaeaea;color:var(--blue)}
    .pencil{cursor:pointer;border:1px solid #eee;padding:6px;border-radius:8px;background:#fff;display:inline-flex;align-items:center;gap:8px}
    .editor{display:none;margin-top:10px;padding:12px;border-radius:10px;background:#fbfbfb;border:1px solid #f0f0f0}
    @media(max-width:480px){.editor{padding:10px;margin-top:8px}}
    .editor .item{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .editor .item input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #e6e6e6}
    .editor .item .small-input{width:110px;padding:8px;border-radius:6px;border:1px solid #e6e6e6}
    .editor .item select{width:150px;padding:8px;border-radius:6px;border:1px solid #e6e6e6}
    .editor .small{font-size:13px;color:var(--muted)}
    .editor .row-actions{margin-top:10px;display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .total-display{font-weight:700;font-size:16px}
    .results{margin-top:12px;padding:14px;border-radius:10px;background:linear-gradient(180deg,rgba(26,42,79,0.95),rgba(26,42,79,0.95));color:#fff}
    .results .line{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .chart-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.05)}
    .chart-card h4{margin:0 0 8px;font-size:14px}
    @media(max-width:900px){.row{flex-direction:column}.charts{grid-template-columns:1fr}}
    @media(max-width:768px){.wrap{padding:14px;margin:12px}.top img{height:52px}h1{font-size:18px}.subtitle{font-size:13px}.btn{font-size:14px}label{font-size:12px}input[type="text"],input[type="number"],select,textarea{padding:10px;font-size:15px}}
    @media(max-width:480px){.wrap{padding:12px;margin:8px}.field{flex:1 1 100%;min-width:100%}.row{gap:8px;flex-direction:column}.editor .item{flex-direction:column;align-items:stretch;gap:6px}.editor .item input,.editor .item select{width:100%}.editor .item .small-input{width:100%}.btn{padding:12px;width:100%;font-size:16px}.nav{flex-direction:column;gap:8px}.chart-card{padding:8px}.chart-card h4{font-size:13px}input[type="text"],input[type="number"],select,textarea{padding:12px;font-size:16px}.loan-card{flex-direction:column;align-items:stretch}.loan-info{font-size:12px}.loan-actions{width:100%;flex-direction:column}.editor .row-actions{flex-direction:column}.pencil{width:100%;justify-content:space-between}.small-ghost{width:100%;padding:10px}}
    .icon-btn{background:none;border:0;padding:6px;border-radius:8px;cursor:pointer}
    .small-ghost{background:#fff;border:1px solid #ddd;padding:7px;border-radius:8px}
    .step { display: none; opacity: 0; transition: opacity 240ms ease; }
    .step.active { display: block; opacity: 1; }
    .step-ind { color: var(--green); font-weight: 800; text-align: center; margin-bottom: 8px; }
    .small-note{font-size:13px;color:var(--muted)}
    .subheading{font-weight:700;margin:6px 0 8px;color:var(--blue)}
    .link-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .click-here { background:var(--blue); color:#fff; padding:6px 10px; border-radius:8px; text-decoration:none; font-weight:700; display:inline-block; }
    .switch { position:relative; display:inline-block; width:56px; height:30px; }
    .switch input { display:none; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ccc; transition:.2s; border-radius:999px; }
    .slider:before { position:absolute; content:""; height:22px; width:22px; left:4px; top:4px; background:white; transition:.2s; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
    input:checked + .slider { background:var(--green); }
    input:checked + .slider:before { transform:translateX(26px); }
    .toggle-label { display:inline-flex; gap:8px; align-items:center; font-weight:600; color:var(--blue); }
    .muted-small { color:var(--muted); font-size:12px; }
    .loan-list { margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .loan-card { background:#f8fafb; padding:10px; border-radius:8px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .loan-info { font-size:13px; color:#333 }
    .loan-actions { display:flex; gap:8px; align-items:center }
    .radio{display:flex;align-items:center;gap:8px;font-size:13px;opacity:.95}
    .radio input{accent-color:var(--gold)}
    .after-vacancy-wrapper{display:inline-flex;align-items:center;gap:6px;margin-left:8px;font-size:11px}
    .finish-analysis-notice{background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:12px;border-radius:8px;margin:16px 0;text-align:center;font-weight:600}
</style>
</head>
<body>
<div class="wrap" id="gateWrap">
<div class="top"><img alt="UTAH REIA logo" src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png"/></div>
<h1 style="text-align:center;color:var(--blue);margin-top:12px;">Short-Term Calculator Access</h1>
<div class="subtitle" style="margin-bottom:16px;">Enter your phone number to unlock the calculator.</div>
<div class="card">
<div class="field"><label>Phone Number</label><input id="gatePhone" inputmode="tel" placeholder="(801) 555-1234" style="font-size:16px;padding:12px" type="tel"/></div>
<div class="field"><button class="btn" id="gateSubmitBtn" style="width:100%;margin-top:8px;" type="button">Unlock Calculator</button></div>
<div class="muted-small" id="gateMessage" style="margin-top:8px;min-height:18px;color:#b00020;text-align:center;"></div>
</div>
<div style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px">For UTAH REIA members only. Need access? Contact us.</div>
</div>
<div class="wrap" id="calcWrap" style="display:none">
<div class="top"><img alt="UTAH REIA logo" src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png"/></div>
<h1>UTAH REIA SHORT TERM CALCULATOR</h1>
<div class="subtitle">Step-by-step analysis for Short Term or Coliving (BRRRR) investments.</div>
<div id="trialReminder" style="display:none;background:#fffbe6;border:1px solid #ffe58f;color:#ad6800;padding:10px;margin:10px 0 18px 0;font-weight:bold;text-align:center;border-radius:8px;font-size:15px;"></div>
<div class="card">
<div class="step-ind" id="stepIndicator">Step 1 of 13</div>
</div>
<div id="stepsArea">
<div class="card step active" data-step="1">
  <div class="muted">Property Information</div>
  <div class="row">
    <div class="field"><label>Street address</label><input id="street" placeholder="Start typing address..." type="text"/></div>
    <div class="field"><label>City</label><input id="city" placeholder="City" type="text"/></div>
    <div class="field"><label>State</label><input id="state" placeholder="UT" type="text"/></div>
    <div class="field"><label>ZIP code</label><input id="zip" placeholder="ZIP" type="text"/></div>
  </div>
  <div class="field"><label>Optional: Features / Description</label><textarea id="features" placeholder="3 bed / 2 bath..."></textarea></div>
</div>
<div class="card step" data-step="2">
  <div class="muted">Purchase Price, & ARV</div>
  <div class="row">
    <div class="field"><label>Purchase Price</label><input id="purchasePrice" placeholder="$240,000" type="text"/></div>
    <div class="field" id="arvFieldWrap">
      <label>After Repair Value (ARV)</label>
      <input id="arv" inputmode="numeric" placeholder="$350,000" type="text"/>
    </div>
  </div>
  <div class="field" style="margin-top:8px;max-width:350px">
    <label class="toggle-label">I intend to make repairs
      <label class="switch"><input id="rehabBypassToggle" type="checkbox"/><span class="slider"></span></label>
    </label>
    <div class="muted-small">Turn ON if you are making repairs. Leave OFF to skip the rehab steps.</div>
  </div>
</div>
<div class="card step" data-step="3">
  <div class="muted">Rehab Costs</div>
  <div class="row" style="margin-bottom:8px">
    <div class="field"><label>Rehab Costs (Total)</label><input id="repairs" placeholder="$40,000" type="text"/></div>
    <div class="field" style="align-self:end">
      <label class="toggle-label">Manual only
        <label class="switch"><input id="rehabManualToggle" type="checkbox"/><span class="slider"></span></label>
      </label>
      <div class="muted-small" style="margin-top:6px">Default: OFF (Use itemized items)</div>
    </div>
  </div>
  <button class="pencil" onclick="toggleEditor('rehab')" type="button">âœï¸ Edit Rehab Breakdown</button>
  <div aria-hidden="true" class="editor" id="editor-rehab">
    <div style="margin-bottom:8px"><div class="subheading">Itemized Rehab Costs</div></div>
    <div class="item"><input class="item-label" value="Exterior Stucco Repair"/><input class="item-value small-input" data-kind="fixed" value="1750"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="New North/East Side Fence"/><input class="item-value small-input" data-kind="fixed" value="2800"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1 - New Windows"/><input class="item-value small-input" data-kind="fixed" value="1800"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1 - Master Bath Shower"/><input class="item-value small-input" data-kind="fixed" value="2500"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 2 - Stairwell Repair"/><input class="item-value small-input" data-kind="fixed" value="2200"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1/2 - Full Interior Paint"/><input class="item-value small-input" data-kind="fixed" value="1750"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1/2 - New Carpet"/><input class="item-value small-input" data-kind="fixed" value="2500"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1/2 - New Fixtures"/><input class="item-value small-input" data-kind="fixed" value="750"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1/2 - New Appliances"/><input class="item-value small-input" data-kind="fixed" value="1800"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Unit 1/2 - New Water Heaters"/><input class="item-value small-input" data-kind="fixed" value="2000"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Landscaping"/><input class="item-value small-input" data-kind="fixed" value="350"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Trash Removal"/><input class="item-value small-input" data-kind="fixed" value="750"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div id="rehab-add-area"></div>
    <div style="margin-top:8px;"><button class="btn" onclick="addItem('rehab')" type="button">+ Add Item</button></div>
    <div class="row-actions">
      <div class="total-display">Rehab Total: <span id="rehabEditorTotal">$0</span></div>
      <div style="display:flex;gap:8px"><button class="btn secondary" onclick="cancelEditor('rehab')" type="button">Cancel</button><button class="btn" onclick="saveEditor('rehab')" type="button">Save</button></div>
    </div>
  </div>
  <div id="rehabBreakdown" style="margin-top:6px;font-size:13px;color:#666"></div>
</div>
<div class="card step" data-step="4">
<div class="muted">Financing</div>
<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
<label class="toggle-label">Use Financing<label class="switch"><input checked="" id="useFinancing" type="checkbox"/><span class="slider"></span></label></label>
<div style="margin-top:10px;margin-bottom:15px;"><a class="btn" href="https://retorocapitalinvestments.com/funding" style="background:#001F3F;color:#fff;" target="_blank">Get a Loan</a></div>
</div>
<div id="financingArea">
<div style="display:flex;gap:12px;flex-wrap:wrap">
<div class="field"><label>Loan Label</label><input id="newLoanLabel" placeholder="Hard Money" type="text"/></div>
<div class="field"><label>Based On</label><select id="newLoanTarget"><option selected value="purchase">% Purchase</option><option value="purchase_rehab">% Purchase + Rehab</option><option value="rehab">% of Rehab</option><option value="arv">% ARV</option><option value="custom">Custom $</option></select></div>
<div class="field" id="newLoanCustomAmountWrap" style="display:none"><label>Amount</label><input id="newLoanCustomAmount" placeholder="$0" type="text"/></div>
<div class="field" id="dpPurchaseWrap"><label>Purchase Down %</label><input id="newLoanPriceDownPct" type="number" value="10"/></div>
<div class="field" id="dpRehabWrap"><label>Rehab Down %</label><input id="newLoanRehabDownPct" type="number" value="10"/></div>
<div class="field" id="dpSingleWrap" style="display:none"><label>Down Payment %</label><input id="newLoanDownPct" type="number" value="10"/></div>
<div class="field"><label>Rate (%)</label><input id="newLoanRate" type="number" value="12"/></div>
<div class="field"><label>Term (mo)</label><input id="newLoanTerm" type="number" value="6"/></div>
<div class="field"><label>Type</label><select id="newLoanType"><option>Interest-Only</option><option>Amortized</option></select></div>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" id="previewLoanBtn" style="background:#001F3F;color:#fff" type="button">Preview Loan</button>
<button class="btn" id="addLoanBtn" type="button">Add This Loan</button>
</div>
<div id="loanPreview" style="margin-top:10px;padding:10px;background:#f0f8ff;border-radius:8px;display:none"><strong>Preview:</strong><div id="loanPreviewContent"></div></div>
<div class="loan-list" id="loanList"></div>
<div style="margin-top:12px;font-weight:700">Total Initial Financing: <span id="computedLoanAmount">$0</span></div>
</div>
</div>
<div class="card step" data-step="5">
<div class="muted">Purchase Cost</div>
<div class="row" style="margin-bottom:8px">
<div class="field"><label>Purchase Cost (manual)</label><input id="purchaseClosing" placeholder="$3,000" type="text"/></div>
<div class="field" style="align-self:end"><label class="toggle-label">Manual only<label class="switch"><input id="purchaseManualToggle" type="checkbox"/><span class="slider"></span></label></label><div class="muted-small" style="margin-top:6px">Default: OFF</div></div>
</div>
<button class="pencil" onclick="toggleEditor('purchase')" type="button">âœï¸ Edit Breakdown</button>
<div aria-hidden="true" class="editor" id="editor-purchase">
<div style="margin-bottom:8px"><div class="subheading">Itemized Purchase Costs</div></div>
<div class="item"><input class="item-label" value="Home Inspection"/><input class="item-value small-input" data-kind="fixed" value="400"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div class="item"><input class="item-label" value="Loan Points"/><input class="item-value small-input" data-kind="pct_loan" value="2"/><select class="item-kind"><option value="fixed">Fixed</option><option selected value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div class="item"><input class="item-label" value="Closing Costs"/><input class="item-value small-input" data-kind="fixed" value="2000"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option></select><select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div id="purchase-add-area"></div>
<div style="margin-top:8px;"><button class="btn" onclick="addItem('purchase')" type="button">+ Add Item</button></div>
<div class="row-actions"><div class="total-display">Total Upfront: <span id="purchaseEditorTotal">$0</span></div><div style="display:flex;gap:8px"><button class="btn secondary" onclick="cancelEditor('purchase')" type="button">Cancel</button><button class="btn" onclick="saveEditor('purchase')" type="button">Save</button></div></div>
</div>
<div id="purchaseBreakdown" style="margin-top:6px;font-size:13px;color:#666"></div>
</div>
<div class="card step" data-step="6">
<div class="muted">Refinance / Financing</div>
<div class="subheading">New Loan Terms</div>
<div class="row">
<div class="field"><label>LTV (% of ARV)</label><input id="refiLtv" type="number" value="75"/></div>
<div class="field"><label>Interest Rate (%)</label><input id="refiRate" type="number" value="7.0"/></div>
<div class="field"><label>Amortization (Years)</label><input id="refiTerm" type="number" value="30"/></div>
</div><div class="row">
<div class="field" style="flex:2">
<label>Refinance Type</label>
<div class="toggle" style="display:flex;gap:10px;flex-wrap:wrap">
<label class="radio"><input name="refiType" type="radio" value="cashout"/> Cash-Out</label>
<label class="radio"><input checked="" name="refiType" type="radio" value="rateterm"/> Rate & Term</label>
</div>
</div>
<div class="field" style="align-self:end">
<label class="toggle-label">Include PMI
Â  <label class="switch"><input id="includePmiToggle" type="checkbox"/><span class="slider"></span></label>
</label>
<div class="muted-small" style="margin-top:6px">PMI applies to the refi loan when enabled.</div>
</div>
<div class="field" id="pmiPctWrap" style="display:none">
<label>PMI Rate (%)</label>
<input id="pmiPct" type="number" value="0.75" step="0.01"/>
</div>
</div>
</div>
<div class="card step" data-step="7">
<div class="muted">Refinance Costs</div>
<div class="row">
<div class="field"><label>Refinance Costs</label><input id="refiClosingCosts" placeholder="$4,000" type="text"/></div>
<div class="field" style="align-self:end">
<label class="toggle-label">Manual Only <label class="switch"><input id="refiManualToggle" type="checkbox"/><span class="slider"></span></label></label>
</div>
</div>
<button class="pencil" onclick="toggleEditor('refi')" type="button">âœï¸ Edit Itemized Refi Costs</button>
<div aria-hidden="true" class="editor" id="editor-refi">
<div style="margin-bottom:8px"><div class="subheading">Itemized Refinance Costs</div></div>
<div class="item"><input class="item-label" value="Appraisal"/><input class="item-value small-input" data-kind="fixed" value="750"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_arv">% of ARV</option></select><select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div class="item"><input class="item-label" value="Lender Fees"/><input class="item-value small-input" data-kind="fixed" value="1000"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_arv">% of ARV</option></select><select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div class="item"><input class="item-label" value="Closing Costs"/><input class="item-value small-input" data-kind="fixed" value="1500"/><select class="item-kind"><option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_arv">% of ARV</option></select><select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div id="refi-add-area"></div>
<div style="margin-top:8px;"><button class="btn" onclick="addItem('refi')" type="button">+ Add Item</button></div>
<div class="row-actions"><div class="total-display">Refi Total: <span id="refiEditorTotal">$0</span></div><div style="display:flex;gap:8px"><button class="btn secondary" onclick="cancelEditor('refi')" type="button">Cancel</button><button class="btn" onclick="saveEditor('refi')" type="button">Save</button></div></div>
</div>
<div id="refiBreakdown" style="margin-top:6px;font-size:13px;color:#666"></div>
</div>
<div class="card step" data-step="8">
<div class="muted">Rental Income</div>
<div class="row">
<div class="field"><label>Monthly Rent</label><input id="monthlyRent" placeholder="$2,000" type="text"/></div>
<div class="field"><label>Vacancy Rate (%)</label><input id="vacancy" type="number" value="50"/></div>
<div class="field">
<label>Other Income (Monthly)</label>
<input id="otherIncome" placeholder="$0" type="text">
<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:8px;flex-wrap:wrap;">
  <label class="toggle-label" style="margin-bottom:0;">
    <span>Itemize</span>
    <label class="switch"><input id="otherIncomeManualToggle" type="checkbox"/><span class="slider"></span></label>
  </label>
  <button class="pencil" id="editOtherIncomeBtn" style="display:none;" type="button">âœï¸ Edit Breakdown</button>
</div>
<div style="margin-top:6px;min-height:20px;">
  <span id="otherIncomeEditorTotalBox" style="display:none;font-weight:600;color:#2E8B57;font-size:14px;"></span>
</div>
<div class="muted-small" style="margin-top:4px">Enable to itemize other income. Disable to enter a total amount.</div>
</div>
<div class="field"><label>Annual Rent Increase (%)</label><input id="annualRentIncrease" type="number" value="3"/></div>
</div>
<div aria-hidden="true" class="editor" id="editor-otherIncome" style="margin-bottom:8px;">
<div style="margin-bottom:8px"><div class="subheading">Itemized Other Income</div></div>
<div class="item"><input class="item-label" value="Parking"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div class="item"><input class="item-label" value="Laundry"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div class="item"><input class="item-label" value="Storage Rental"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option value="fixed_month">$ (Per Month)</option><option selected value="fixed_year">$ (Per Year)</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
 <div class="item"><input class="item-label" value="Cleaning Fees"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
 <div class="item"><input class="item-label" value="Pet Fees"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
 <div class="item"><input class="item-label" value="Platform-based Income"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option></select><span class="small">Per Building</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
<div id="otherIncome-add-area"></div>
<div style="margin-top:8px;"><button class="btn" onclick="addItem('otherIncome')" type="button">+ Add Item</button></div>
<div class="row-actions"><div class="total-display">Other Income Total: <span id="otherIncomeEditorTotal">$0</span></div><div style="display:flex;gap:8px"><button class="btn secondary" onclick="cancelEditor('otherIncome')" type="button">Cancel</button><button class="btn" onclick="saveEditor('otherIncome')" type="button">Save</button></div></div>
</div>
<div id="otherIncomeBreakdown" style="margin-top:6px;font-size:13px;color:#666"></div>
</div>
<div class="card step" data-step="9">
<div class="muted">Operating Expenses, Annual Expense Increase</div>
<div class="row">
  <div class="field"><label>Monthly Expenses (Manual)</label><input id="operatingExpenses" placeholder="$500" type="text"/></div>
  <div class="field" style="align-self:end"><label class="toggle-label">Manual Only<label class="switch"><input id="operatingManualToggle" type="checkbox"/><span class="slider"></span></label></label></div>
</div>
<button class="pencil" onclick="toggleEditor('operating')" type="button">âœï¸ Edit Itemized OpEx</button>
<div aria-hidden="true" class="editor" id="editor-operating">
  <div style="margin-bottom:8px"><div class="subheading">Itemized Operating Expenses</div></div>
  <div class="item"><input class="item-label" value="Property Taxes"/><input class="item-value small-input" data-kind="fixed_month" value="3250"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
  <div class="item"><input class="item-label" value="Insurance"/><input class="item-value small-input" data-kind="fixed_month" value="750"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
  <div class="item"><input class="item-label" value="Property Management"/><input class="item-value small-input" data-kind="pct_rent" value="8"/><select class="item-type"><option value="fixed">$ Fixed</option><option selected value="percent">Percent</option></select><select class="item-kind"><option selected value="pct_rent">% of Rent</option><option value="pct_price">% of Price</option></select><span class="after-vacancy-wrapper" style="display:inline-flex;"><input type="checkbox" class="after-vacancy-check" checked/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
  <div class="item"><input class="item-label" value="Maintenance"/><input class="item-value small-input" data-kind="pct_rent" value="8"/><select class="item-type"><option value="fixed">$ Fixed</option><option selected value="percent">Percent</option></select><select class="item-kind"><option selected value="pct_rent">% of Rent</option><option value="pct_price">% of Price</option></select><span class="after-vacancy-wrapper" style="display:inline-flex;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
  <div class="item"><input class="item-label" value="Common Utilities"/><input class="item-value small-input" data-kind="fixed_month" value="75"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
  <div class="item"><input class="item-label" value="Landscaping"/><input class="item-value small-input" data-kind="fixed_month" value="50"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Platform Fees"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Consumables"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Utilities"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Internet"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Permits"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Turnover"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Reserves"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
   <div class="item"><input class="item-label" value="Furniture Replacement"/><input class="item-value small-input" data-kind="fixed_month" value="0"/><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
  <div id="operating-add-area"></div>
  <div style="margin-top:8px;"><button class="btn" onclick="addItem('operating')" type="button">+ Add Item</button></div>
  <div class="row-actions"><div class="total-display">OpEx Total: <span id="operatingEditorTotal">$0</span></div><div style="display:flex;gap:8px"><button class="btn secondary" onclick="cancelEditor('operating')" type="button">Cancel</button><button class="btn" onclick="saveEditor('operating')" type="button">Save</button></div></div>
</div>
<div id="operatingBreakdown" style="margin-top:6px;font-size:13px;color:#666"></div>
<div class="row" style="margin-top:10px"><div class="field"><label>Annual Expense Increase (%)</label><input id="annualExpenseIncrease" type="number" value="2"/></div></div>
</div>
<!-- Furnishing Step -->
<div class="card step" data-step="10">
  <div class="muted">Furnishing <span style="color:#2E8B57;font-weight:600">(STR-Specific)</span></div>
  <div class="row" style="margin-bottom:8px">
    <div class="field"><label>Furnishing Cost (manual)</label><input id="furnishingCost" placeholder="$0" type="text"/></div>
    <div class="field" style="align-self:end">
      <label class="toggle-label">Manual only
        <label class="switch"><input id="furnishingManualToggle" type="checkbox"/><span class="slider"></span></label>
      </label>
      <div class="muted-small" style="margin-top:6px">Default: OFF (Use itemized items)</div>
    </div>
  </div>
  <button class="pencil" onclick="toggleEditor('furnishing')" type="button">âœï¸ Edit Furnishing Breakdown</button>
  <div aria-hidden="true" class="editor" id="editor-furnishing">
    <div style="margin-bottom:8px"><div class="subheading">Itemized Furnishing Costs (STR-Specific)</div></div>
    <div class="item"><input class="item-label" value="Beds"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed">Fixed</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Sofas"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed">Fixed</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Linens"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed">Fixed</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Kitchenware"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed">Fixed</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="TVs"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed">Fixed</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div class="item"><input class="item-label" value="Decor"/><input class="item-value small-input" data-kind="fixed" value="0"/><select class="item-kind"><option selected value="fixed">Fixed</option></select><span class="small">Per Unit</span><button class="icon-btn" type="button">ğŸ—‘ï¸</button></div>
    <div id="furnishing-add-area"></div>
    <div style="margin-top:8px;"><button class="btn" onclick="addItem('furnishing')" type="button">+ Add Item</button></div>
    <div class="row-actions">
      <div class="total-display">Furnishing Total: <span id="furnishingEditorTotal">$0</span></div>
      <div style="display:flex;gap:8px"><button class="btn secondary" onclick="cancelEditor('furnishing')" type="button">Cancel</button><button class="btn" onclick="saveEditor('furnishing')" type="button">Save</button></div>
    </div>
  </div>
  <div id="furnishingBreakdown" style="margin-top:6px;font-size:13px;color:#666"></div>
  <div class="muted-small">Enter the total cost for furnishing the property (beds, furniture, etc), or use the itemized breakdown for STR-specific details.</div>
  </div>
  <div class="card step" data-step="11">
  <div class="muted">Appreciation &amp; Selling Costs</div>
  <div class="row">
  <div class="field"><label>Annual Appreciation (%)</label><input id="appreciation" type="number" value="3"/></div>
  <div class="field"><label>Future Selling Costs (%)</label><input id="sellingCostPct" type="number" value="6"/></div>
  </div>
  </div>
<div class="card step" data-step="12">
<div class="muted">Depreciation</div>
<div class="row">
<div class="field"><label>Depreciable Basis ($)</label><input id="depreciationBasis" placeholder="(Auto-calculated if empty)" type="text"/></div>
<div class="field"><label>Recovery Period (Years)</label><input id="depreciationYears" type="number" value="27.5"/></div>
</div>
<div class="muted-small">Leave Basis empty to use (Purchase + Purchase Costs + Rehab). Note: Furnishings are depreciated separately as 5-year personal property and are excluded from this basis.</div>
</div>
<div class="card step" data-step="13">
  <div class="muted">CapEx Reserve</div>
  <div class="row">
    <div class="field">
      <label>CapEx Type</label>
      <select id="capexType">
        <option value="pct_rent" selected>% of Rent</option>
        <option value="pct_price">% of Price</option>
        <option value="per_month">$ Per Month</option>
        <option value="per_year">$ Per Year</option>
      </select>
    </div>
    <div class="field">
      <label id="capexLabel">CapEx Reserve (% of Rent)</label>
      <input id="capexMonthly" placeholder="5" type="text"/>
    </div>
  </div>
  <div class="finish-analysis-notice">
âš ï¸ <strong>Important:</strong> Always click "Finish Analysis" after making any changes to the calculator to update your report.
  </div>
  <button class="btn" id="finishBtn" type="button" style="width:100%;margin-bottom:16px">ğŸ“Š Finish Analysis</button>
  <div id="reportContainer" style="margin-top:20px;">
    <p style="text-align:center;color:#666;">Your analysis report will appear here.</p>
  </div>
</div>
  <div class="nav" id="navButtonsFinish" style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;">
    <button class="btn secondary" id="prevBtnFinish" type="button">â† Back</button>
  </div>
</div>
  <div class="nav" id="navButtons" style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;">
    <button class="btn secondary" id="prevBtn" type="button" style="display:none">â† Back</button>
    <button class="btn" id="nextBtn" type="button">Next â†’</button>
  </div>
  <div id="footerText" style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px">Â© 2025 UTAH REIA - Estimates are educational only.</div>
  
</div>
<script>
    /* ---------- Config ---------- */

    // Unlock calculator logic
    window.addEventListener('DOMContentLoaded', function() {
      var gateBtn = document.getElementById('gateSubmitBtn');
      var gatePhone = document.getElementById('gatePhone');
      var gateWrap = document.getElementById('gateWrap');
      var calcWrap = document.getElementById('calcWrap');
      var gateMessage = document.getElementById('gateMessage');
      if (gateBtn && gatePhone && gateWrap && calcWrap) {
        gateBtn.addEventListener('click', function() {
          var phone = gatePhone.value.trim();
          // Simple phone validation (at least 7 digits)
          var digits = phone.replace(/\D/g, '');
          if (digits.length < 7) {
            if (gateMessage) gateMessage.textContent = 'Please enter a valid phone number.';
            return;
          }
          if (gateMessage) gateMessage.textContent = '';
          gateWrap.style.display = 'none';
          calcWrap.style.display = '';
          // Optionally, scroll to calculator
          try { calcWrap.scrollIntoView({behavior:'smooth',block:'start'}); } catch(e) {}
        });
      }
    });
    const editorState = {
      purchaseExtrasUpfront: 0, purchaseManualBase: 0, purchaseManualOnly: false,
      rehabExtras: 0, rehabManualBase: 0, rehabManualOnly: false,
      refiExtras: 0, refiManualBase: 0, refiManualOnly: false,
      operatingMonthlyBase: 0, operatingMonthlyExtras: 0, operatingManualOnly: false,
      otherIncomeExtras: 0, otherIncomeManualOnly: false,
      furnishingExtras: 0, furnishingManualOnly: false,
      purchaseExtrasRolled: 0, refiExtrasRolled: 0, financeExtrasUnassigned: 0
    };
    let loans = [];

    // Ensure at least a virtual loan exists if purchase price is being used as a loan
    function ensureVirtualLoanIfNeeded() {
      const price = unformatCurrency($('purchasePrice')?.value);
      const useFinancing = $('useFinancing')?.checked;
      // Only add if no loans exist, financing is enabled, and price is set
      if (useFinancing && loans.length === 0 && price > 0) {
        let virtualLoanAmount = price;
        let virtualLoanLabel = 'Purchase Price (No Loan Added)';
        loans.push({
          id: 'virtual',
          label: virtualLoanLabel,
          target: 'purchase',
          type: 'Interest-Only',
          rate: 0,
          term: 0,
          financed: virtualLoanAmount,
          baseFinanced: virtualLoanAmount
        });
      }
    }
    
    // ========== HELPER FUNCTIONS ==========
    function escapeHtml(s) { return s ? String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])) : ''; }
    
    function populateLoanOptions(selectEl) {
      if(!selectEl) return;
      let html = '<option value="">Select Loan</option>';
      loans.forEach(l => {
        html += `<option value="${l.id}">${escapeHtml(l.label)}</option>`;
      });
      selectEl.innerHTML = html;
    }
    
    // ========== WIRE FUNCTIONS ==========
    window.wireAllPurchaseAndRefiItems = function() {
      ['purchase', 'refi'].forEach(key => {
        const editor = $('editor-' + key);
        if(!editor) return;
        
        editor.querySelectorAll('.item').forEach(item => {
          const paySelect = item.querySelector('.item-pay');
          const loanTarget = item.querySelector('.item-loan-target');
          if(!paySelect || !loanTarget) return;
          
          const newPaySelect = paySelect.cloneNode(true);
          paySelect.replaceWith(newPaySelect);
          
          newPaySelect.addEventListener('change', function() {
            const currentLoanTarget = this.closest('.item').querySelector('.item-loan-target');
            if(this.value === 'roll') {
              currentLoanTarget.style.display = 'inline-block';
              populateLoanOptions(currentLoanTarget);
            } else {
              currentLoanTarget.style.display = 'none';
            }
          });
          
          if(newPaySelect.value === 'roll') {
            loanTarget.style.display = 'inline-block';
            populateLoanOptions(loanTarget);
          }
        });
      });
    };
    
    window.wireAllOperatingItems = function() {
      const operatingEditor = $('editor-operating');
      if(!operatingEditor) return;
      
      operatingEditor.querySelectorAll('.item').forEach(item => {
        const typeSelect = item.querySelector('.item-type');
        const kindSelect = item.querySelector('.item-kind');
        const afterVacWrapper = item.querySelector('.after-vacancy-wrapper');
        
        if(!typeSelect || !kindSelect || !afterVacWrapper) return;
        
        const newTypeSelect = typeSelect.cloneNode(true);
        typeSelect.replaceWith(newTypeSelect);
        const newKindSelect = kindSelect.cloneNode(true);
        kindSelect.replaceWith(newKindSelect);
        
        newTypeSelect.addEventListener('change', function() {
          const currentItem = this.closest('.item');
          const currentKindSelect = currentItem.querySelector('.item-kind');
          const currentAfterVacWrapper = currentItem.querySelector('.after-vacancy-wrapper');
          
          if(this.value === 'fixed') {
            currentKindSelect.innerHTML = '<option selected value="fixed_month">Per Month</option><option value="fixed_year">Per Year</option>';
            if(currentAfterVacWrapper) currentAfterVacWrapper.style.display = 'none';
          } else {
            currentKindSelect.innerHTML = '<option selected value="pct_rent">% of Rent</option><option value="pct_price">% of Price</option>';
            if(currentAfterVacWrapper) currentAfterVacWrapper.style.display = 'inline-flex';
          }
          recalcEditor('operating');
        });
        
        newKindSelect.addEventListener('change', function() {
          const currentItem = this.closest('.item');
          const currentTypeSelect = currentItem.querySelector('.item-type');
          const currentAfterVacWrapper = currentItem.querySelector('.after-vacancy-wrapper');
          
          if(currentAfterVacWrapper && currentTypeSelect.value === 'percent' && this.value === 'pct_rent') {
            currentAfterVacWrapper.style.display = 'inline-flex';
          } else if(currentAfterVacWrapper) {
            currentAfterVacWrapper.style.display = 'none';
          }
          recalcEditor('operating');
        });
        
        const afterVacCheck = afterVacWrapper.querySelector('.after-vacancy-check');
        if(afterVacCheck) {
          const newCheck = afterVacCheck.cloneNode(true);
          afterVacCheck.replaceWith(newCheck);
          newCheck.addEventListener('change', () => recalcEditor('operating'));
        }
        
        if(newTypeSelect.value === 'percent' && newKindSelect.value === 'pct_rent') {
          afterVacWrapper.style.display = 'inline-flex';
        } else {
          afterVacWrapper.style.display = 'none';
        }
      });
    };

    /* ---------- Helpers ---------- */
    const $ = id => document.getElementById(id);
    function unformatCurrency(str){ if(str===undefined||str===null)return 0; if(typeof str==='number')return str; str=String(str); if(!str)return 0; return Number(str.replace(/[^0-9.-]+/g,''))||0; }
    function formatCurrency(n){ if(isNaN(n))n=0; return '$'+Number(n).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:2}); }
    function debounce(fn,w){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),w);};}
    const _debouncedComputeAndRender = debounce(() => { if(typeof computeAndRender === 'function') computeAndRender(); }, 450);

    /* ---------- Initialization ---------- */
    window.addEventListener('load', ()=> {
                    // Show itemized total for Other Income
                    const otherIncomeToggleTotal = document.getElementById('otherIncomeManualToggle');
                    const otherIncomeTotalBox = document.getElementById('otherIncomeEditorTotalBox');
                    const otherIncomeEditorTotal = document.getElementById('otherIncomeEditorTotal');
                    if(otherIncomeToggleTotal && otherIncomeTotalBox && otherIncomeEditorTotal) {
                        function updateOtherIncomeTotalBox() {
                          if(otherIncomeToggleTotal.checked) {
                            otherIncomeTotalBox.style.display = 'inline-block';
                            otherIncomeTotalBox.textContent = 'Total: ' + otherIncomeEditorTotal.textContent;
                          } else {
                            otherIncomeTotalBox.style.display = 'none';
                          }
                        }
                        otherIncomeToggleTotal.addEventListener('change', updateOtherIncomeTotalBox);
                        // Also update when itemized total changes
                        const observer = new MutationObserver(updateOtherIncomeTotalBox);
                        observer.observe(otherIncomeEditorTotal, {childList:true});
                        updateOtherIncomeTotalBox();
                      }
              // Rehab bypass toggle logic
              const rehabBypass = $('rehabBypassToggle');
              const arvFieldWrap = $('arvFieldWrap');
              if(rehabBypass && arvFieldWrap) {
                function updateRehabBypassUI() {
                  if(rehabBypass.checked) {
                    arvFieldWrap.style.display = '';
                  } else {
                    arvFieldWrap.style.display = 'none';
                  }
                }
                rehabBypass.addEventListener('change', updateRehabBypassUI);
                updateRehabBypassUI();
              }
        ['repairs', 'purchaseClosing', 'refiClosingCosts', 'operatingExpenses', 'otherIncome', 'furnishingCost'].forEach(id => {
          const el = $(id);
          if(el) el.value = "";
        });

      ['purchase','rehab','refi','operating','otherIncome', 'furnishing'].forEach(key => {
        const toggle = $(key+'ManualToggle');
        if(toggle){
          toggle.checked = false;
          toggle.addEventListener('change', ()=>{ editorState[key+'ManualOnly'] = !!toggle.checked; updateVisibleTotals(); });
        }
      });
      
      // Initialize wire functions
      setTimeout(() => {
        wireAllPurchaseAndRefiItems();
        wireAllOperatingItems();
      }, 200);

      const uf = $('useFinancing');
      if(uf){
        uf.addEventListener('change', ()=>{
          $('financingArea').style.display = uf.checked ? 'block' : 'none';
          updateAggregatedLoanAmountDisplay(); updateVisibleTotals();
        });
      }

      const lt = $('newLoanTarget');
      if(lt){
        lt.addEventListener('change', ()=>{
          const t = lt.value;
          ['dpPurchaseWrap','dpRehabWrap','dpSingleWrap','newLoanCustomAmountWrap'].forEach(id=>$(id).style.display='none');
          if(t==='purchase_rehab') {
            $('dpPurchaseWrap').style.display='block';
            $('dpRehabWrap').style.display='block';
          } else if(t==='rehab') {
            $('dpRehabWrap').style.display='block';
          } else if(t==='purchase') {
            $('dpPurchaseWrap').style.display='block';
          } else if(t==='custom') {
            $('newLoanCustomAmountWrap').style.display='block';
          } else {
            $('dpSingleWrap').style.display='block';
          }
        });
        // Trigger change on load to set correct fields
        lt.dispatchEvent(new Event('change'));
      }

      if($('addLoanBtn')) $('addLoanBtn').addEventListener('click', addLoanFromInputs);
      if($('previewLoanBtn')) $('previewLoanBtn').addEventListener('click', calculateLoanPreview);

      attachEditorInit('editor-purchase'); attachEditorInit('editor-rehab'); attachEditorInit('editor-refi'); attachEditorInit('editor-operating'); attachEditorInit('editor-otherIncome'); attachEditorInit('editor-furnishing');

      document.querySelectorAll('input[type=text]').forEach(el => {
        if(el.id.toLowerCase().includes('price') || el.id.includes('Cost') || el.id.includes('Rent') || el.id.includes('repairs') || el.id.includes('Amount') || el.id==='arv') {
          el.addEventListener('focus', ()=> {
              const currentVal = unformatCurrency(el.value);
              el.value = currentVal === 0 ? "" : currentVal;
          });
          el.addEventListener('blur', ()=> { 
              const val = unformatCurrency(el.value);
              el.value = val === 0 ? "" : formatCurrency(val); 
              updateVisibleTotals(); 
          });
        }
      });
      
      document.querySelectorAll('input[name="refiType"]').forEach(el => el.addEventListener('change', ()=>{ recalcAllEditors(); updateVisibleTotals(); }));
      if($('includePmiToggle')) $('includePmiToggle').addEventListener('change', ()=>{ const w=$('pmiPctWrap'); if(w) w.style.display = $('includePmiToggle').checked ? 'block':'none'; recalcAllEditors(); updateVisibleTotals(); });
      if($('pmiPct')) $('pmiPct').addEventListener('input', ()=>{ recalcAllEditors(); updateVisibleTotals(); });

      const otherIncomeToggle = document.getElementById('otherIncomeManualToggle');
      const otherIncomeEditor = document.getElementById('editor-otherIncome');
      const editOtherIncomeBtn = document.getElementById('editOtherIncomeBtn');
      if(otherIncomeToggle && otherIncomeEditor && editOtherIncomeBtn) {
        otherIncomeToggle.addEventListener('change', () => {
             otherIncomeEditor.style.display = otherIncomeToggle.checked ? 'block' : 'none';
             editOtherIncomeBtn.style.display = otherIncomeToggle.checked ? 'inline-flex' : 'none';
        });
      }

      document.querySelectorAll('#calcWrap input, #calcWrap select').forEach(el => {
        el.addEventListener('change', ()=> { 
            recalcAllEditors(); 
            updateVisibleTotals(); 
            if($('reportContainer').innerHTML.includes('Analysis Summary')) _debouncedComputeAndRender(); 
        });
      });

      renderLoanList();
      updateVisibleTotals();

      // Add listeners to update loan list if purchase price, ARV, or financing changes
      const purchasePriceEl = $('purchasePrice');
      const arvEl = $('arv');
      const useFinancingEl = $('useFinancing');
      if (purchasePriceEl) purchasePriceEl.addEventListener('input', renderLoanList);
      if (arvEl) arvEl.addEventListener('input', renderLoanList);
      if (useFinancingEl) useFinancingEl.addEventListener('change', renderLoanList);
    });

    // CapEx type dropdown handler
if($('capexType')) {
  $('capexType').addEventListener('change', ()=>{
    const type = $('capexType').value;
    const label = $('capexLabel');
    const input = $('capexMonthly');
    switch(type) {
      case 'pct_rent':
        label.textContent = 'CapEx Reserve (% of Rent)';
        input.placeholder = '5';
        break;
      case 'pct_price':
        label.textContent = 'CapEx Reserve (% of Price)';
        input.placeholder = '0.5';
        break;
      case 'per_month':
        label.textContent = 'CapEx Reserve ($ per Month)';
        input.placeholder = '100';
        break;
      case 'per_year':
        label.textContent = 'CapEx Reserve ($ per Year)';
        input.placeholder = '1200';
        break;
    }
  });
}

    /* ---------- Navigation ---------- */
    const totalSteps = 13;
    let currentStep = 1;
    function showStep(n){
      currentStep = Math.max(1, Math.min(totalSteps, n));
      document.querySelectorAll('.step').forEach(el => el.classList.toggle('active', Number(el.dataset.step) === currentStep));
      $('stepIndicator').textContent = `Step ${currentStep} of ${totalSteps}`;
      
      if ($('navButtons')) $('navButtons').style.display = (currentStep === 13) ? 'none' : 'flex';
      if ($('navButtonsFinish')) $('navButtonsFinish').style.display = (currentStep === 13) ? 'flex' : 'none';
      if ($('prevBtn')) $('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-block';
      
      try{ $('calcWrap').scrollIntoView({behavior:'smooth',block:'start'}); }catch(e){}
    }
    
    $('prevBtn').addEventListener('click', function(e) {
      // Custom skip: on step 6, if rehab bypass is OFF, go back to step 2 not step 5
      if(currentStep === 6) {
        const rehabBypass = document.getElementById('rehabBypassToggle');
        if(rehabBypass && !rehabBypass.checked) {
          showStep(2);
          return;
        }
      }
      showStep(currentStep - 1);
    });
        // Custom next button logic for step 2
        const nextBtn = $('nextBtn');
        if(nextBtn) {
          nextBtn.addEventListener('click', function(e) {
            if(currentStep === 2) {
              const rehabBypass = $('rehabBypassToggle');
              if(rehabBypass && !rehabBypass.checked) {
                showStep(6);
                return;
              }
            }
            showStep(currentStep + 1);
          });
        }
    $('prevBtnFinish').addEventListener('click', ()=>showStep(currentStep-1));
    $('finishBtn').addEventListener('click', computeAndRender);

    /* ---------- Loan Logic ---------- */
    function addLoanFromInputs(){
      try{
        const label = $('newLoanLabel').value || 'Loan';
        const target = $('newLoanTarget').value;
        const type = $('newLoanType').value;
        const rate = Number($('newLoanRate').value)||0;
        const term = Number($('newLoanTerm').value)||0;
        const price = unformatCurrency($('purchasePrice').value);
        const rehab = unformatCurrency($('repairs').value) || editorState.rehabExtras || 0;
        let arv = unformatCurrency($('arv').value);
        // If ARV is blank or zero, default to purchase price
        if (!arv) arv = price;
        if(price === 0 && target.includes('purchase')){ alert('Please enter Purchase Price in Step 2 first.'); return; }
        let amt = 0;
        if(target==='purchase_rehab'){
          const priceDown = (Number($('newLoanPriceDownPct').value)||0)/100;
          const rehabDown = (Number($('newLoanRehabDownPct').value)||0)/100;
          amt = (price * (1 - priceDown)) + (rehab * (1 - rehabDown));
        } else if(target==='purchase'){
          amt = price * (1 - (Number($('newLoanPriceDownPct').value)||0)/100);
        } else if(target==='rehab'){
          amt = rehab * (1 - (Number($('newLoanRehabDownPct').value)||0)/100);
        } else if(target==='arv'){
          amt = arv * (1 - (Number($('newLoanDownPct').value)||0)/100);
        } else {
          amt = unformatCurrency($('newLoanCustomAmount').value);
        }
        loans.push({ id:Date.now(), label, target, type, rate, term, financed:amt, baseFinanced:amt });
        renderLoanList();
        $('newLoanLabel').value=''; $('newLoanCustomAmount').value='';
      }catch(e){ console.error(e); }
    }

    function calculateLoanPreview(){
      const target = $('newLoanTarget').value;
      const price = unformatCurrency($('purchasePrice').value);
      const rehab = unformatCurrency($('repairs').value) || editorState.rehabExtras || 0;
      let arv = unformatCurrency($('arv').value);
      // If ARV is blank or zero, default to purchase price
      if (!arv) arv = price;
      let amt = 0;
      if(target==='purchase_rehab'){
          const priceDown = (Number($('newLoanPriceDownPct').value)||0)/100;
          const rehabDown = (Number($('newLoanRehabDownPct').value)||0)/100;
          amt = (price * (1 - priceDown)) + (rehab * (1 - rehabDown));
      } else if(target==='purchase'){ amt = price * (1 - (Number($('newLoanPriceDownPct').value)||0)/100); }
      else if(target==='rehab'){ amt = rehab * (1 - (Number($('newLoanRehabDownPct').value)||0)/100); }
      else if(target==='arv'){ amt = arv * (1 - (Number($('newLoanDownPct').value)||0)/100); }
      else { amt = unformatCurrency($('newLoanCustomAmount').value); }
      $('loanPreview').style.display='block';
      $('loanPreviewContent').innerHTML = `Projected Amount: <strong>${formatCurrency(amt)}</strong>`;
    }

    function renderLoanList(){
      // Remove any previous virtual loan
      loans = loans.filter(l => l.id !== 'virtual');
      ensureVirtualLoanIfNeeded();
      $('loanList').innerHTML = loans.map(l=>`
        <div class="loan-card">
          <div class="loan-info"><strong>${escapeHtml(l.label)}</strong><div>${formatCurrency(l.financed)} @ ${l.rate}%</div></div>
          <div class="loan-actions">${l.id !== 'virtual' ? `<button type="button" class="btn secondary" onclick="removeLoan(${l.id})">Delete</button>` : ''}</div>
        </div>`).join('');
      updateAggregatedLoanAmountDisplay();
      wireAllPurchaseAndRefiItems();
    }

    window.removeLoan = function(id){ loans = loans.filter(l=>l.id!==id); renderLoanList(); };
    function computeAggregatedFinancedAmount(){ 
      let base = loans.reduce((a,b)=>a+b.financed,0);
      base += (editorState.purchaseExtrasRolled || 0);
      return base;
    }
    function updateAggregatedLoanAmountDisplay(){ if($('computedLoanAmount')) $('computedLoanAmount').textContent = formatCurrency(computeAggregatedFinancedAmount()); }

    /* ---------- Editors Logic ---------- */
    function toggleEditor(key){
      const el = $('editor-'+key);
      const isHidden = el.getAttribute('aria-hidden')==='true';
      el.style.display = isHidden ? 'block' : 'none';
      el.setAttribute('aria-hidden', !isHidden);
      if(isHidden) recalcEditor(key);
    }

    function addItem(key){
  const area = $(key+'-add-area');
  const div = document.createElement('div');
  div.className='item';
  div.dataset.itemId=Date.now();
  
  let kindOptions = '';
  let extraElements = '';
  
  if(key==='rehab'){ 
    kindOptions = `<option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option>`;
    extraElements = `<span class="small">Per Building</span>`;
  }
  else if(key==='purchase'){ 
    kindOptions = `<option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_price">% of Price</option>`;
    extraElements = `<select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select>`;
  }
  else if(key==='refi'){ 
    kindOptions = `<option selected value="fixed">Fixed</option><option value="pct_loan">% of Loan</option><option value="pct_arv">% of ARV</option>`;
    extraElements = `<select class="item-pay"><option selected value="upfront">Pay Upfront</option><option value="roll">Roll Into Loan</option></select><select class="item-loan-target" style="display:none;width:150px;"></select>`;
  }
  else if(key==='operating'){ 
    // Exact static HTML for new OpEx items
    div.innerHTML = `<input class="item-label" placeholder="Item"><input class="item-value small-input" value="0"><select class="item-type"><option selected value="fixed">$ Fixed</option><option value="percent">Percent</option></select><select class="item-kind"><option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option><option value="pct_rent">% of Rent</option><option value="pct_price">% of Price</option></select><span class="after-vacancy-wrapper" style="display:none;"><input type="checkbox" class="after-vacancy-check"/> After Vacancy</span><button type="button" class="icon-btn">ğŸ—‘ï¸</button>`;
    div.querySelector('.icon-btn').onclick = () => { div.remove(); recalcEditor(key); };
    div.querySelector('.item-value').oninput = () => recalcEditor(key);
    div.querySelector('.item-label').oninput = () => recalcEditor(key);
    div.querySelector('.item-type').onchange = () => recalcEditor(key);
    div.querySelector('.item-kind').onchange = () => recalcEditor(key);
    area.appendChild(div);
    wireAllOperatingItems();
    recalcEditor(key);
    return;
  }
  else if(key==='furnishing'){ 
    kindOptions = `<option selected value="fixed">Fixed</option>`;
    extraElements = `<span class="small">Per Unit</span>`;
  }
  else if(key==='otherIncome'){ 
    kindOptions = `<option selected value="fixed_month">$ (Per Month)</option><option value="fixed_year">$ (Per Year)</option>`;
    extraElements = `<span class="small">Per Building</span>`;
  }
  else {
    kindOptions = `<option selected value="fixed">Fixed</option>`;
    extraElements = `<span class="small">Per Unit</span>`;
  }
  
  div.innerHTML = `<input class="item-label" placeholder="Item"><input class="item-value small-input" value="0"><select class="item-kind">${kindOptions}</select>${extraElements}<button type="button" class="icon-btn">ğŸ—‘ï¸</button>`;
  div.querySelector('.icon-btn').onclick = () => { div.remove(); recalcEditor(key); };
  div.querySelector('.item-value').oninput = () => recalcEditor(key);
  div.querySelector('.item-label').oninput = () => recalcEditor(key);
  div.querySelector('.item-kind').onchange = () => recalcEditor(key);
  area.appendChild(div);
  
  // Wire new items
  if(key === 'purchase' || key === 'refi') {
    wireAllPurchaseAndRefiItems();
  } else if(key === 'operating') {
    wireAllOperatingItems();
  }
  
  recalcEditor(key);
}

    function recalcEditor(key){
      const items = Array.from($('editor-'+key).querySelectorAll('.item'));
      let total = 0;
      const price = unformatCurrency($('purchasePrice').value);
      const rent = unformatCurrency($('monthlyRent').value);
      const arv = unformatCurrency($('arv').value);

      // For rolled-into-loan logic
      let rolledTotal = 0;
      let upfrontTotal = 0;
      let rolledByLoan = {};

      items.forEach(i => {
        const val = unformatCurrency(i.querySelector('.item-value').value);
        const kind = i.querySelector('.item-kind').value;
        let itemTotal = 0;

        // For pct_rent items, check if "After Vacancy" is checked
        let effectiveRent = rent;
        if (key === 'operating' && kind === 'pct_rent') {
          const afterVacCheck = i.querySelector('.after-vacancy-check');
          const vacPct = (Number($('vacancy')?.value) || 0) / 100;
          if (afterVacCheck && afterVacCheck.checked) {
            effectiveRent = rent * (1 - vacPct);
          }
        }

        if(kind === 'fixed' || kind === 'fixed_month') itemTotal = val;
        else if(kind === 'fixed_year') itemTotal = (val/12);
        else if(kind === 'pct_price') itemTotal = price * (val/100);
        else if(kind === 'pct_rent') itemTotal = effectiveRent * (val/100);
        else if(kind === 'pct_arv' && key==='refi') itemTotal = arv * (val/100);
        else if(kind === 'pct_loan' && key==='purchase') {
          // Use the Total Initial Financing from Step 4 for % of Loan
          let loanAmount = 0;
          if (typeof computeAggregatedFinancedAmount === 'function') {
            loanAmount = computeAggregatedFinancedAmount();
          }
          itemTotal = loanAmount * (val/100);
        }

        // Check for rolled-into-loan
        const paySel = i.querySelector('.item-pay');
        const loanTargetSel = i.querySelector('.item-loan-target');
        if(paySel && paySel.value === 'roll' && loanTargetSel && loanTargetSel.value) {
          rolledTotal += itemTotal;
          if(!rolledByLoan[loanTargetSel.value]) rolledByLoan[loanTargetSel.value] = 0;
          rolledByLoan[loanTargetSel.value] += itemTotal;
        } else {
          upfrontTotal += itemTotal;
        }
        total += itemTotal;
      });

      if($(key+'EditorTotal')) $(key+'EditorTotal').textContent = formatCurrency(upfrontTotal);

      // Use consistent naming for editorState keys
      if(key === 'furnishing') {
        editorState.furnishingExtras = total;
      } else if(key === 'operating') {
        editorState.operatingMonthlyExtras = total;
      } else if(key === 'purchase') {
        editorState.purchaseExtrasUpfront = upfrontTotal;
        editorState.purchaseExtrasRolled = rolledTotal;
        editorState.purchaseRolledByLoan = rolledByLoan;
      } else if(key === 'refi') {
        editorState.refiExtrasUpfront = upfrontTotal;
        editorState.refiExtrasRolled = rolledTotal;
        editorState.refiRolledByLoan = rolledByLoan;
      } else if(key === 'otherIncome') {
        editorState.otherIncomeExtras = total;
      } else {
        editorState[key + 'Extras'] = total;
      }
      return total;
    }

    function saveEditor(key) {
      const total = recalcEditor(key);
      toggleEditor(key);
      const map = { purchase: 'purchaseClosing', rehab: 'repairs', operating: 'operatingExpenses', refi: 'refiClosingCosts', otherIncome: 'otherIncome', furnishing: 'furnishingCost' };
      let displayTotal = total;
      // For refi or purchase, only show upfront total in the input box
      if (key === 'refi') {
        displayTotal = editorState.refiExtrasUpfront || 0;
      } else if (key === 'purchase') {
        displayTotal = editorState.purchaseExtrasUpfront || 0;
      }
      if ($(map[key])) $(map[key]).value = displayTotal === 0 ? "" : formatCurrency(displayTotal);
      updateVisibleTotals();
    }
    function cancelEditor(key){ toggleEditor(key); updateVisibleTotals(); }

    function attachEditorInit(id){
      const root = $(id); if(!root)return;
      root.addEventListener('input', (e) => { if(e.target.matches('input, select')) recalcEditor(id.split('-')[1]); });
    }

    function recalcAllEditors(){ ['purchase','rehab','refi','operating','otherIncome','furnishing'].forEach(k => { if($('editor-'+k)) recalcEditor(k); }); }

    function updateVisibleTotals(){
      if($('furnishingBreakdown')) $('furnishingBreakdown').textContent = $('furnishingManualToggle')?.checked ? '(Manual Entry)' : `(Itemized Total: ${formatCurrency(editorState.furnishingExtras)})`;
      if($('rehabBreakdown')) $('rehabBreakdown').textContent = editorState.rehabManualOnly ? '(Manual Entry)' : `(Itemized Total: ${formatCurrency(editorState.rehabExtras)})`;
      if($('purchaseBreakdown')) {
        const purchaseUpfront = editorState.purchaseExtrasUpfront || 0;
        $('purchaseBreakdown').textContent = editorState.purchaseManualOnly ? '(Manual Entry)' : `(Itemized Total: ${formatCurrency(purchaseUpfront)})`;
        if($('purchaseClosing')) $('purchaseClosing').value = purchaseUpfront === 0 ? '' : formatCurrency(purchaseUpfront);
      }
      if($('refiBreakdown')) {
        const refiUpfront = editorState.refiExtrasUpfront || 0;
        $('refiBreakdown').textContent = editorState.refiManualOnly ? '(Manual Entry)' : `(Itemized Total: ${formatCurrency(refiUpfront)})`;
        if($('refiClosingCosts')) $('refiClosingCosts').value = refiUpfront === 0 ? '' : formatCurrency(refiUpfront);
      }
      if($('operatingBreakdown')) $('operatingBreakdown').textContent = editorState.operatingManualOnly ? '(Manual Entry)' : `(Itemized Total: ${formatCurrency(editorState.operatingMonthlyExtras)})`;
      if($('otherIncomeBreakdown')) $('otherIncomeBreakdown').textContent = $('otherIncomeManualToggle')?.checked ? `(Itemized Total: ${formatCurrency(editorState.otherIncomeExtras)})` : '(Manual Entry)';
    }

    function getRefiType(){
      const el = document.querySelector('input[name="refiType"]:checked');
      return el ? el.value : 'cashout';
    }

    function computeRefiLoanAmount(arv, ltvPct, payoffPrincipal, refiType){
      const maxLoan = arv * (ltvPct/100);
      if(refiType === 'rateterm'){
        const loanAmt = Math.min(maxLoan, payoffPrincipal);
        return { maxLoan, loanAmt, cashToBring: Math.max(0, payoffPrincipal - maxLoan), cashOut: 0 };
      }
      return { maxLoan, loanAmt: maxLoan, cashToBring: 0, cashOut: Math.max(0, maxLoan - payoffPrincipal) };
    }

    function computeAndRender(){
      recalcAllEditors();
      const price = unformatCurrency($('purchasePrice').value);
      const rehab = unformatCurrency($('repairs').value);
      const purchaseClose = unformatCurrency($('purchaseClosing').value);
      const furnishing = unformatCurrency($('furnishingCost').value);
      const initialLoanPrincipal = computeAggregatedFinancedAmount();
      const allInCost = price + rehab + purchaseClose + furnishing;
      const totalCashInvested = allInCost - initialLoanPrincipal;

      const arv = unformatCurrency($('arv').value);
      const ltv = Number($('refiLtv').value)||75;
      const refiType = getRefiType();
      const refiClose = unformatCurrency($('refiClosingCosts').value);
      const refiLoanObj = computeRefiLoanAmount(arv, ltv, initialLoanPrincipal, refiType);
      const newLoan = refiLoanObj.loanAmt;

      const netRefiProceeds = newLoan - initialLoanPrincipal - refiClose;
      const cashLeftInDeal = totalCashInvested - netRefiProceeds;

      const rent = unformatCurrency($('monthlyRent').value);
const otherInc = unformatCurrency($('otherIncome').value);

// CRITICAL: Vacancy as EXPENSE, not income reduction
const vacancyPct = (Number($('vacancy').value)||0)/100;
const vacancyAmount = rent * vacancyPct;

// Gross income does NOT deduct vacancy
const grossIncome = rent + otherInc;

const opEx = unformatCurrency($('operatingExpenses').value);
const capexType = $('capexType')?.value || 'pct_rent';
const capexVal = unformatCurrency($('capexMonthly').value);
let capex = 0;
switch(capexType) {
  case 'pct_rent':
    capex = rent * (capexVal/100);
    break;
  case 'pct_price':
    capex = (price * (capexVal/100)) / 12;
    break;
  case 'per_month':
    capex = capexVal;
    break;
  case 'per_year':
    capex = capexVal / 12;
    break;
}
      const actualLoan = newLoan + (editorState.refiExtrasRolled || 0);
      const rRate = (Number($('refiRate').value)||7)/100/12;
      const rTerm = (Number($('refiTerm').value)||30)*12;
      const mortgage = rRate > 0 ? actualLoan * (rRate * Math.pow(1+rRate, rTerm)) / (Math.pow(1+rRate, rTerm) - 1) : 0;
      
      // Add PMI if enabled and LTV > 80%
      let pmi = 0;
      if($('includePmiToggle') && $('includePmiToggle').checked) {
        const ltvRatio = (actualLoan / arv) * 100;
        if(ltvRatio > 80) {
          const pmiRate = (Number($('pmiPct').value) || 0.75) / 100 / 12;
          pmi = actualLoan * pmiRate;
        }
      }
      
      const totalExpenses = vacancyAmount + opEx + capex + mortgage + pmi;
const cashFlow = grossIncome - totalExpenses;

      const annualCashFlow = cashFlow * 12;
      const roi = cashLeftInDeal > 0 ? (annualCashFlow / cashLeftInDeal)*100 : (annualCashFlow > 0 ? 999 : 0);
      const depBasis = unformatCurrency($('depreciationBasis').value) || (price + rehab + purchaseClose);
      const annualDep = depBasis / (Number($('depreciationYears').value) || 27.5);

      // 30-Year Projection logic
      const years = 30;
      const projLabels = Array.from({length: years}, (_, i) => `Year ${i+1}`);
      let projCashFlowArr = [];
      let projEquityArr = [];
      let curRent = rent, curOtherInc = otherInc, curOpEx = opEx, curCapEx = capex, curARV = arv;
      const rentInc = Number($('annualRentIncrease').value)||0;
      const expInc = Number($('annualExpenseIncrease').value)||0;
      const appreciation = Number($('appreciation').value)||0;
      let loanBalance = actualLoan;
      const projRRate = (Number($('refiRate').value)||7)/100/12;

      for(let y=1; y<=years; y++){
  if(y>1){
      curRent *= (1 + rentInc/100);
      curOtherInc *= (1 + rentInc/100);
      curOpEx *= (1 + expInc/100);
      curCapEx *= (1 + expInc/100);
      curARV *= (1 + appreciation/100);
  }
  
  // Calculate loan paydown for the year
  for(let m=0; m<12; m++){
    const interest = loanBalance * projRRate;
    const principal = mortgage - interest;
    loanBalance = Math.max(0, loanBalance - principal);
  }
  
  const yVacancy = curRent * vacancyPct;
  const yGross = curRent + curOtherInc;
  const yExpenses = yVacancy + curOpEx + curCapEx + mortgage + pmi;
  const yCF = yGross - yExpenses;
  const equity = curARV - loanBalance;
  
  projCashFlowArr.push(Math.round(yCF * 12));
  projEquityArr.push(Math.round(equity));
}

      const html = `
  <div class="results" style="margin-bottom:12px;">
    <h3 style="margin:0 0 10px;border-bottom:1px solid #ffffff44;padding-bottom:8px">Short-Term Rental Analysis Report</h3>
    
    <!-- Project Summary -->
    <div class="line"><div>ARV</div><div>${formatCurrency(arv)}</div></div>
    <div class="line"><div>Total All-In Cost</div><div>${formatCurrency(allInCost)}</div></div>
    
    <!-- Refinance Details -->
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ffffff44"></div>
    <div style="font-weight:600;margin-bottom:6px">Refinance Summary:</div>
    <div class="line"><div>Refinance Type</div><div>${refiType==='rateterm'?'Rate & Term':'Cash-Out'}</div></div>
    <div class="line"><div>New Loan Amount (${ltv}% LTV)</div><div>${formatCurrency(actualLoan)}</div></div>
    <div class="line"><div>Interest Rate</div><div>${(Number($('refiRate').value)||7).toFixed(2)}%</div></div>
    <div class="line"><div>Monthly Payment (P&I)</div><div>${formatCurrency(mortgage)}</div></div>
    ${pmi > 0 ? `<div class="line"><div>Monthly PMI</div><div>${formatCurrency(pmi)}</div></div>` : ''}
    <div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.1)"></div>
    <div class="line"><div>Initial Loan Payoff</div><div>${formatCurrency(initialLoanPrincipal)}</div></div>
    <div class="line"><div>Refinance Closing Costs</div><div>-${formatCurrency(refiClose)}</div></div>
    ${refiLoanObj.cashOut > 0 ? `<div class="line" style="color:var(--green)"><div>Cash Out</div><div>+${formatCurrency(refiLoanObj.cashOut)}</div></div>` : ''}
    ${refiLoanObj.cashToBring > 0 ? `<div class="line" style="color:#ff6b6b"><div>Cash to Bring</div><div>-${formatCurrency(refiLoanObj.cashToBring)}</div></div>` : ''}
    <div class="line" style="font-weight:700;border-top:1px solid rgba(255,255,255,0.2);padding-top:6px;margin-top:4px"><div>Net Refinance Proceeds</div><div>${formatCurrency(netRefiProceeds)}</div></div>
    <div class="line" style="font-weight:700;color:var(--gold)"><div>Cash Left In Deal</div><div>${formatCurrency(cashLeftInDeal)}</div></div>
    
    <!-- Monthly Cash Flow Breakdown -->
    <div style="margin-top:12px;border-top:1px solid #ffffff44;padding-top:8px"></div>
    <div style="font-weight:600;margin-bottom:6px">Monthly Breakdown:</div>
    <div class="line"><div>Rental Income</div><div>${formatCurrency(rent)}</div></div>
    <div class="line"><div>Other Income</div><div>${formatCurrency(otherInc)}</div></div>
    <div class="line" style="color:#b00020"><div>Vacancy (${(vacancyPct*100).toFixed(1)}%)</div><div>-${formatCurrency(vacancyAmount)}</div></div>
    <div class="line"><div>Operating Expenses</div><div>-${formatCurrency(opEx)}</div></div>
    <div class="line"><div>CapEx Reserve</div><div>-${formatCurrency(capex)}</div></div>
    <div class="line"><div>Mortgage</div><div>-${formatCurrency(mortgage)}</div></div>
    ${pmi > 0 ? `<div class="line"><div>PMI</div><div>-${formatCurrency(pmi)}</div></div>` : ''}
    <div class="line" style="font-weight:700;color:${cashFlow >= 0 ? 'var(--green)' : '#b00020'};font-size:15px;margin-top:4px">
      <div>Net Monthly Cash Flow</div><div>${formatCurrency(cashFlow)}</div>
    </div>
    
    <!-- ROI -->
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ffffff44"></div>
    <div class="line"><div>Cash-on-Cash ROI</div><div>${roi>900 ? 'Infinite' : roi.toFixed(2)+'%'}</div></div>
    <div class="line"><div>Annual Depreciation</div><div>${formatCurrency(annualDep)}</div></div>
  </div>
  
  <div class="charts">
    <div class="chart-card"><h4>Equity vs Loan</h4><canvas id="chartEquity"></canvas></div>
    <div class="chart-card"><h4>Monthly Breakdown</h4><canvas id="chartFlow"></canvas></div>
  </div>
  <div class="chart-card" style="margin-top:16px"><h4>Cashflow Summary (30 Years)</h4><canvas id="chartProjection"></canvas></div>
  
  <button type="button" class="btn secondary" style="width:100%;margin-top:10px" onclick="downloadPdfHandler()">Download PDF Report</button>
`;
      
      $('reportContainer').innerHTML = html;
      renderCharts(newLoan, arv, totalExpenses, Math.max(0, cashFlow), projLabels, projCashFlowArr, projEquityArr);
    }

    function renderCharts(loan, arv, exp, flow, labels, cfData, eqData){

      if(window.chart1) window.chart1.destroy();
      if(window.chart2) window.chart2.destroy();
      if(window.chart3) window.chart3.destroy();


      // Reduce chart size for PDF/A4 fit
      const pieOptions = {
        plugins: { legend: { position: 'bottom' }, datalabels: { color: '#fff', formatter: v => formatCurrency(v) } },
        responsive: false,
        maintainAspectRatio: false,
        width: 120,
        height: 100
      };

      // Defensive: check canvas and data
      const chartEquityCanvas = $('chartEquity');
      const loanVal = Number(loan);
      const arvVal = Number(arv);
      if (!chartEquityCanvas) {
        console.error('chartEquity canvas not found');
      } else if (isNaN(loanVal) || isNaN(arvVal)) {
        console.error('Invalid data for Equity chart:', {loan, arv});
      } else {
        try {
          window.chart1 = new Chart(chartEquityCanvas, {
            type:'pie',
            data: { labels: ['Loan', 'Equity'], datasets: [{ data: [loanVal, Math.max(0, arvVal-loanVal)], backgroundColor:['#1a2a4f','#2E8B57'] }] },
            options: pieOptions,
            plugins: [ChartDataLabels]
          });
        } catch (e) {
          console.error('Error rendering Equity chart:', e);
        }
      }

      window.chart2 = new Chart($('chartFlow'), {
        type:'doughnut',
        data: { labels: ['Expenses', 'Cash Flow'], datasets: [{ data: [exp, Math.max(0, flow)], backgroundColor:['#b00020','#2E8B57'] }] },
        options: pieOptions,
        plugins: [ChartDataLabels]
      });

      window.chart3 = new Chart($('chartProjection'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Annual Cash Flow', data: cfData, borderColor: '#2E8B57', backgroundColor: 'rgba(46,139,87,0.1)', yAxisID: 'y' },
            { label: 'Equity', data: eqData, borderColor: '#1a2a4f', backgroundColor: 'rgba(26,42,79,0.1)', yAxisID: 'y1' }
          ]
        },
        options: {
          scales: {
            y: { type: 'linear', position: 'left', title: { display: true, text: 'Cash Flow' } },
            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Equity' } }
          }
        }
      });
      

    }

    async function downloadPdfHandler(){
      const el = $('reportContainer');
      // A4 size in jsPDF is 210mm x 297mm, but jsPDF uses points by default (1 pt = 1/72 inch)
      // We'll use mm for clarity
      const pdf = new jspdf.jsPDF({unit: 'mm', format: 'a4'});
      const pageWidth = 210;
      const pageHeight = 297;
      // Render at high scale for quality, then scale down to fit page
      const canvas = await html2canvas(el, {scale:2, backgroundColor:'#fff'});
      const img = canvas.toDataURL('image/jpeg');
      // Calculate scale to fit all content on one page
      const contentWidth = canvas.width;
      const contentHeight = canvas.height;
      // Leave a small margin
      const margin = 10;
      const maxWidth = pageWidth - margin * 2;
      const maxHeight = pageHeight - margin * 2;
      let renderWidth = maxWidth;
      let renderHeight = (contentHeight * maxWidth) / contentWidth;
      if(renderHeight > maxHeight) {
        renderHeight = maxHeight;
        renderWidth = (contentWidth * maxHeight) / contentHeight;
      }
      const x = (pageWidth - renderWidth) / 2;
      const y = (pageHeight - renderHeight) / 2;
      pdf.addImage(img, 'JPEG', x, y, renderWidth, renderHeight);
      pdf.save('Short_Term_Report.pdf');
    }

    /* ---------- Auth Logic ---------- */
    function normalizePhone(raw) { return String(raw||'').replace(/[^\d]/g, '').slice(-10); }
    async function verifyPhoneViaWorkflow(phone) {
      try {
        const res = await fetch('https://fix-flip-calculator-delta.vercel.app/api/check-phone-short-term', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({phone:normalizePhone(phone)})
        });
        let d;
        try { d = await res.json(); } catch (jsonErr) { throw new Error('Server error. Please try again.'); }
        if(d && d.valid && d.status === 'Active') return {status:'Active'};
        if(d && d.valid && d.trial && d.trialDaysLeft > 0) return {status:'Trial', daysLeft: d.trialDaysLeft};
        throw new Error('Access denied or trial expired.');
      } catch(e){ throw e; }
    }

    const unlock = () => {$('gateWrap').style.display='none'; $('calcWrap').style.display='block'; showStep(1);};
    if(sessionStorage.getItem('utahreia_calc_verified')) unlock();

    $('gateSubmitBtn').onclick = async () => {
      const p = $('gatePhone').value;
      if(p.length < 10) return alert('Invalid Phone');
      $('gateSubmitBtn').innerText = 'Verifying...';
      try {
        const res = await verifyPhoneViaWorkflow(p);
        if(res.status==='Trial') {
          alert(`You are on a 30-day free trial. Days left: ${res.daysLeft}.\nContact Utah REIA to become a member and enjoy unlimited access!`);
        }
        sessionStorage.setItem('utahreia_calc_verified', 'true');
        unlock();
        const trialReminder = document.getElementById('trialReminder');
        if (trialReminder && res.status === 'Trial') {
          trialReminder.textContent = `You are on a 30-day free trial. Days left: ${res.daysLeft}. Contact Utah REIA to become a member and enjoy unlimited access!`;
          trialReminder.style.display = 'block';
        }
      } catch(e) { alert(e.message); }
      $('gateSubmitBtn').innerText = 'Unlock Calculator';
    };
</script>
</body>
</html>