<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UTAH REIA - Rental Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, Arial; background: #f6f7f8; color: #111; margin: 0; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 20px 60px rgba(10,20,30,0.06); }
    .top { display: flex; align-items: center; gap: 16px; justify-content: center; margin-bottom: 6px; }
    .top img { height: 68px; }
    h1 { color: #1a2a4f; font-size: 20px; margin: 6px 0 2px; text-align: center; }
    .subtitle { text-align: center; color: #666; margin-bottom: 12px; }
    .btn { background: #2E8B57; color: #fff; padding: 10px 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    .btn.secondary { background: #eaeaea; color: #1a2a4f; }

    .rental-wrap { max-width: 700px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); padding: 32px 24px; font-family: Inter, Arial, sans-serif; }

    .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .25s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .25s; border-radius: 50%; }
    input:checked + .slider { background-color: #2E8B57; }
    input:checked + .slider:before { transform: translateX(20px); }

    /* IMPORTANT: prevents blank screen if JS ever fails */
    .rental-step { display: none; }
    .rental-step.active { display: block; }

    .rental-card { background: #f8fafb; border-radius: 10px; padding: 24px 18px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .rental-row { display: flex; gap: 18px; flex-wrap: wrap; }
    .rental-field { flex: 1 1 220px; min-width: 140px; margin-bottom: 14px; }
    .rental-label { display: block; font-weight: 600; color: #1a2a4f; margin-bottom: 6px; font-size: 14px; }
    .rental-input, .rental-select, .rental-textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e7e7e7; font-size: 15px; background:#fff; }
    .rental-textarea { min-height: 64px; }
    .rental-muted, .muted-small { color: #666; font-size: 13px; }
    .rental-nav { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 18px; flex-wrap: wrap; }
    .rental-btn { background: #2E8B57; color: #fff; padding: 10px 22px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; }
    .rental-btn.secondary { background: #eaeaea; color: #1a2a4f; }

    /* BRRRR-style aliases so your Step 3 markup looks like your example */
    .brrrr-card { background: #f8fafb; border-radius: 10px; padding: 24px 18px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .brrrr-field { flex: 1 1 220px; min-width: 140px; margin-bottom: 14px; }
    .brrrr-label { display: block; font-weight: 600; color: #1a2a4f; margin-bottom: 6px; font-size: 14px; }
    .brrrr-input, .brrrr-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e7e7e7; font-size: 15px; background:#fff; }
    .brrrr-muted { color: #666; font-size: 13px; }

    /* Loan list UI */
    .loan-list { margin-top: 10px; display: flex; flex-direction: column; gap: 10px; }
    .loan-item {
      background: #fff; border: 1px solid #e7e7e7; border-radius: 10px;
      padding: 12px; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .loan-item b { color:#1a2a4f; }
    .loan-item .meta { color:#666; font-size:13px; line-height:1.35; }
    .loan-item .actions { display:flex; gap:8px; align-items:center; }
    .loan-pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#f0f3f6; font-size:12px; color:#1a2a4f; }
  </style>
</head>

<body>
  <div class="wrap" id="rentalWrap">
    <div class="top">
      <img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo">
    </div>
    <h1>UTAH REIA Rental Calculator</h1>
    <div class="subtitle">Step 1: Property Information</div>

    <div class="rental-wrap">
      <form id="rentalForm" autocomplete="off">

        <!-- Step 1 (active fallback so it NEVER shows blank) -->
        <div class="rental-step active" id="step1">
          <div class="rental-card">
            <div class="rental-row">
              <div class="rental-field">
                <label class="rental-label" for="address">Property Address</label>
                <input class="rental-input" id="address" name="address" type="text" placeholder="Start typing address..." autocomplete="off">
              </div>
              <div class="rental-field">
                <label class="rental-label" for="city">City</label>
                <input class="rental-input" id="city" name="city" type="text" placeholder="City">
              </div>
              <div class="rental-field">
                <label class="rental-label" for="state">State</label>
                <input class="rental-input" id="state" name="state" type="text" placeholder="State">
              </div>
              <div class="rental-field">
                <label class="rental-label" for="zip">ZIP Code</label>
                <input class="rental-input" id="zip" name="zip" type="text" placeholder="ZIP Code">
              </div>
            </div>
          </div>
          <div class="rental-nav">
            <button class="rental-btn" type="button" id="nextStep">Next</button>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="rental-step" id="step2">
          <div class="rental-card">
            <div style="font-weight:700;color:#1a2a4f;margin-bottom:8px;">PURCHASE</div>
            <div class="rental-row">
              <div class="rental-field">
                <label class="rental-label" for="purchasePrice">Purchase Price</label>
                <input class="rental-input" id="purchasePrice" name="purchasePrice" type="text" placeholder="$0">
                <div class="muted-small">Used for financing % calculations.</div>
              </div>
            </div>
          </div>

          <div class="rental-card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div>
                <b>Itemize Purchase Costs</b><br>
                <span class="rental-muted">Enable to itemize purchase costs. Disable to enter a total amount.</span>
              </div>
              <label class="switch">
                <input type="checkbox" id="itemizePurchaseCosts" checked>
                <span class="slider"></span>
              </label>
            </div>

            <div id="purchaseCostsItemized">
              <div style="font-weight:700;color:#1a2a4f;margin-bottom:8px;">ITEMIZED PURCHASE COSTS</div>
              <div id="purchaseCostsList"></div>
              <button type="button" class="rental-btn secondary" id="addPurchaseCost" style="margin-top:10px;">+ Add</button>
              <div style="border-top:1px solid #b5d6c7;margin-top:16px;padding-top:8px;font-weight:600;">
                Total: <span id="purchaseCostsTotal">$0</span>
              </div>
            </div>

            <div id="purchaseCostsTotalInput" style="display:none;margin-top:10px;">
              <label class="rental-label" for="purchaseCostsTotalValue">Total Purchase Costs</label>
              <input class="rental-input" id="purchaseCostsTotalValue" type="text" placeholder="$0">
            </div>
          </div>

          <div class="rental-card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div>
                <b>Itemize Rehab Costs</b><br>
                <span class="rental-muted">Enable to itemize rehab costs. Disable to enter a total amount.</span>
              </div>
              <label class="switch">
                <input type="checkbox" id="itemizeRehabCosts" checked>
                <span class="slider"></span>
              </label>
            </div>

            <div id="rehabCostsItemized">
              <div style="font-weight:700;color:#1a2a4f;margin-bottom:8px;">ITEMIZED REHAB COSTS</div>
              <div id="rehabCostsList"></div>
              <button type="button" class="rental-btn secondary" id="addRehabCost" style="margin-top:10px;">+ Add</button>
              <div style="border-top:1px solid #b5d6c7;margin-top:16px;padding-top:8px;font-weight:600;">
                Total: <span id="rehabCostsTotal">$0</span>
              </div>
            </div>

            <div id="rehabCostsTotalInput" style="display:none;margin-top:10px;">
              <label class="rental-label" for="rehabCostsTotalValue">Total Rehab Costs</label>
              <input class="rental-input" id="rehabCostsTotalValue" type="text" placeholder="$0">
            </div>
          </div>

          <div class="rental-nav">
            <button class="rental-btn secondary" type="button" id="prevStep2">Back</button>
            <button class="rental-btn" type="button" id="nextStep2">Next</button>
          </div>
        </div>

        <!-- Step 3 (matches your BRRRR Financing UI) -->
        <div class="rental-step" id="step3">
          <div class="brrrr-card">
            <div class="brrrr-muted">Financing (Holding / Acquisition Loans)</div>

            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:10px 0;">
              <label class="brrrr-label" style="margin:0;">Use Financing</label>
              <label class="switch" title="Toggle financing on/off">
                <input id="useFinancing" type="checkbox" checked>
                <span class="slider"></span>
              </label>
              <div class="muted-small">Add one or more loans to model payment impact.</div>

              <a href="https://retorocapitalinvestments.com/funding"
                 target="_blank" rel="noopener"
                 class="btn" style="background:#001F3F;color:#fff;text-decoration:none;">
                Get a Loan
              </a>
            </div>

            <div id="financingArea" style="margin-top:8px;display:block;">
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div class="brrrr-field">
                  <label class="brrrr-label">Loan Label</label>
                  <input id="newLoanLabel" class="brrrr-input" type="text" placeholder="e.g., Hard Money - Lender A">
                </div>

                <div class="brrrr-field">
                  <label class="brrrr-label">Loan Based On</label>
                  <select id="newLoanTarget" class="brrrr-select">
                    <option value="purchase">% of Purchase Price</option>
                    <option value="rehab">% of Rehab Cost</option>
                    <option value="arv">% of ARV</option>
                    <option value="purchase_rehab">% of Purchase + Rehab Cost</option>
                    <option value="custom">Custom Amount</option>
                  </select>
                </div>

                <div class="brrrr-field" id="newLoanCustomAmountWrap" style="display:none;">
                  <label class="brrrr-label">Custom Loan Amount</label>
                  <input id="newLoanCustomAmount" class="brrrr-input" type="text" placeholder="$50,000">
                </div>

                <div class="brrrr-field" id="dpPurchaseWrap" style="display:none;">
                  <label class="brrrr-label">Purchase Down Payment (%)</label>
                  <input id="newLoanPriceDownPct" class="brrrr-input" type="number" min="0" max="100" step="0.1" value="10">
                </div>

                <div class="brrrr-field" id="dpRehabWrap" style="display:none;">
                  <label class="brrrr-label">Rehab Down Payment (%)</label>
                  <input id="newLoanRehabDownPct" class="brrrr-input" type="number" min="0" max="100" step="0.1" value="10">
                </div>

                <div class="brrrr-field" id="dpSingleWrap">
                  <label class="brrrr-label">Down Payment (%)</label>
                  <input id="newLoanDownPct" class="brrrr-input" type="number" min="0" max="100" step="0.1" value="10">
                </div>

                <div class="brrrr-field">
                  <label class="brrrr-label">Loan Type</label>
                  <select id="newLoanType" class="brrrr-select">
                    <option value="Interest-Only">Interest-Only</option>
                    <option value="Amortized">Amortized</option>
                  </select>
                </div>

                <div class="brrrr-field">
                  <label class="brrrr-label">Interest Rate (%)</label>
                  <input id="newLoanRate" class="brrrr-input" type="number" min="0" step="0.1" value="15">
                </div>

                <div class="brrrr-field">
                  <label class="brrrr-label">Loan Term (months)</label>
                  <input id="newLoanTerm" class="brrrr-input" type="number" min="0" step="1" value="6" placeholder="e.g., 6">
                </div>
              </div>

              <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <button type="button" class="btn" id="previewLoanBtn" style="background:#001F3F;color:#fff;">Preview Loan</button>
                <button type="button" class="btn" id="addLoanBtn">Add Loan</button>
                <div class="muted-small">Tip: Add multiple loans to model blended payment impact.</div>
              </div>

              <div id="loanPreviewNote" class="muted-small" style="display:none;margin-top:8px;"></div>
              <div class="loan-list" id="loanList"></div>

              <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                <div class="brrrr-field" style="min-width:220px">
                  <label class="brrrr-label">Total Financed Loan Amount</label>
                  <div id="computedLoanAmount" style="font-weight:900;padding:10px;background:#fff;border-radius:8px;border:1px solid #e7e7e7;">$0</div>
                </div>
              </div>
            </div>
          </div>

          <div class="rental-nav">
            <button class="rental-btn secondary" type="button" id="prevStep3">Back</button>
            <button class="rental-btn" type="button" id="nextStep3">Next</button>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="rental-step" id="step4">
          <div class="rental-card">
            <div style="font-weight:700;color:#1a2a4f;margin-bottom:8px;">VALUATION</div>
            <div class="rental-row">
              <div class="rental-field">
                <label class="rental-label" for="arv">After Repair Value (ARV)</label>
                <input class="rental-input" id="arv" name="arv" type="text" placeholder="$0">
              </div>
              <div class="rental-field">
                <label class="rental-label" for="pricePerSqFt">Price Per Square Foot</label>
                <input class="rental-input" id="pricePerSqFt" name="pricePerSqFt" type="text" placeholder="$0">
              </div>
              <div class="rental-field">
                <label class="rental-label" for="arvPerSqFt">ARV Per Square Foot</label>
                <input class="rental-input" id="arvPerSqFt" name="arvPerSqFt" type="text" placeholder="$0">
              </div>
              <div class="rental-field">
                <label class="rental-label" for="rehabPerSqFt">Rehab Per Square Foot</label>
                <input class="rental-input" id="rehabPerSqFt" name="rehabPerSqFt" type="text" placeholder="$0">
              </div>
            </div>
          </div>

          <div class="rental-nav">
            <button class="rental-btn secondary" type="button" id="prevStep4">Back</button>
            <button class="rental-btn" type="button" id="nextStep4">Next</button>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="rental-step" id="step5">
          <div class="rental-card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div>
                <b>Itemize Operating Expenses</b><br>
                <span class="rental-muted">Enable to itemize operating expenses. Disable to enter a total amount.</span>
              </div>
              <label class="switch">
                <input type="checkbox" id="itemizeOperatingExpenses" checked>
                <span class="slider"></span>
              </label>
            </div>

            <div id="operatingExpensesItemized">
              <div style="font-weight:700;color:#1a2a4f;margin-bottom:8px;">ITEMIZED OPERATING EXPENSES</div>
              <div id="operatingExpensesList"></div>
              <button type="button" class="rental-btn secondary" id="addOperatingExpense" style="margin-top:10px;">+ Add</button>
              <div style="border-top:1px solid #b5d6c7;margin-top:16px;padding-top:8px;font-weight:600;">
                Total: <span id="operatingExpensesTotal">$0</span>
              </div>
            </div>

            <div id="operatingExpensesTotalInput" style="display:none;margin-top:10px;">
              <label class="rental-label" for="operatingExpensesTotalValue">Total Operating Expenses</label>
              <input class="rental-input" id="operatingExpensesTotalValue" type="text" placeholder="$0">
            </div>
          </div>

          <div class="rental-card">
            <div class="rental-row">
              <div class="rental-field">
                <label class="rental-label" for="vacancy">Vacancy Rate (%)</label>
                <input class="rental-input" id="vacancy" name="vacancy" type="number" min="0" max="100" step="0.01" placeholder="%">
              </div>
            </div>
          </div>

          <div class="rental-nav">
            <button class="rental-btn secondary" type="button" id="prevStep5">Back</button>
            <button class="rental-btn" type="button" id="calculateBtn">Calculate</button>
          </div>
        </div>

        <!-- Results -->
        <div class="rental-step" id="resultsStep">
          <div class="rental-card">
            <div style="font-weight:700;color:#1a2a4f;margin-bottom:8px;">RESULTS SUMMARY</div>
            <div id="resultsSummary"></div>
            <canvas id="resultsChart" style="margin:24px auto 0 auto;max-width:400px;display:block;"></canvas>

            <div style="text-align:center;margin-top:24px;">
              <button class="rental-btn" id="downloadPdfBtn" type="button">Download PDF</button>
            </div>
          </div>

          <div class="rental-nav">
            <button class="rental-btn secondary" type="button" id="backToEditBtn">Back to Edit</button>
          </div>
        </div>

      </form>
    </div>

    <div style="text-align:center;margin-top:12px;color:#666;font-size:13px">Â© 2026 UTAH REIA - Estimates are educational only.</div>
  </div>

  <script>
    /* ---------- Helpers (prevents crashes) ---------- */
    const $ = (id) => document.getElementById(id);
    const on = (id, evt, fn) => { const el = $(id); if (el) el.addEventListener(evt, fn); };

    function loadScript(src, cb) {
      const s = document.createElement('script');
      s.src = src;
      s.onload = cb;
      s.onerror = function () { console.warn('Failed to load:', src); cb(); };
      document.body.appendChild(s);
    }

    /* ---------- Google Places (safe) ---------- */
    function setupAddressAutocomplete() {
      const input = $('address');
      if (!input) return;

      const GMAPS_SRC = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBv5v5ZA_pJvv_jT_ERUuXAQbG0xBqOWRY&libraries=places";
      loadScript(GMAPS_SRC, function () {
        try {
          if (!window.google || !google.maps || !google.maps.places) return;
          const autocomplete = new google.maps.places.Autocomplete(input, { types: ["address"] });

          autocomplete.addListener("place_changed", function () {
            const place = autocomplete.getPlace();
            if (!place || !place.address_components) return;

            place.address_components.forEach(function (comp) {
              if (comp.types.includes("locality") && $('city')) $('city').value = comp.long_name;
              if (comp.types.includes("administrative_area_level_1") && $('state')) $('state').value = comp.short_name;
              if (comp.types.includes("postal_code") && $('zip')) $('zip').value = comp.long_name;
            });
          });
        } catch (e) {
          console.warn("Autocomplete setup error:", e);
        }
      });
    }

    /* ---------- Money utils ---------- */
    function parseCurrency(val) {
      if (!val) return 0;
      if (typeof val === 'number') return val;
      return Number(String(val).replace(/[^0-9.-]+/g, '')) || 0;
    }
    function fmtMoney(n) {
      const num = Number(n) || 0;
      return `$${num.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
    }

    /* ---------- Step nav ---------- */
    const steps = ['step1', 'step2', 'step3', 'step4', 'step5', 'resultsStep'];
    let currentStep = 0;

    function showStep(idx) {
      steps.forEach((id, i) => {
        const el = $(id);
        if (!el) return;
        el.style.display = (i === idx) ? 'block' : 'none';
        el.classList.toggle('active', i === idx);
      });

      currentStep = idx;

      if (steps[idx] === 'step2') {
        prepopulatePurchaseCosts();
        prepopulateRehabCosts();
      }

      const subtitle = document.querySelector('.subtitle');
      if (subtitle) {
        const labelMap = {
          step1: 'Step 1: Property Information',
          step2: 'Step 2: Costs',
          step3: 'Step 3: Financing',
          step4: 'Step 4: Valuation',
          step5: 'Step 5: Operating Expenses',
          resultsStep: 'Results'
        };
        subtitle.textContent = labelMap[steps[idx]] || '';
      }
    }

    /* ---------- Itemized rows ---------- */
    function createItemRow(listId, name = '', value = '', type = 'dollar', percentType = 'ofPrice', upfront = true) {
      const list = $(listId);
      if (!list) return;

      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.gap = '8px';
      row.style.marginBottom = '8px';
      row.className = 'item-row';

      row.innerHTML = `
        <input class="rental-input item-name" style="max-width:160px;" placeholder="Name" value="${name}">
        <input class="rental-input item-value" style="max-width:120px;" placeholder="$0 or %" value="${value}">

        <select class="rental-input item-type" style="max-width:90px;">
          <option value="dollar" ${type === 'dollar' ? 'selected' : ''}>$</option>
          <option value="percent" ${type === 'percent' ? 'selected' : ''}>%</option>
        </select>

        <select class="rental-input item-percentType" style="max-width:110px; ${type === 'percent' ? '' : 'display:none;'}">
          <option value="ofPrice" ${percentType === 'ofPrice' ? 'selected' : ''}>of Price</option>
          <option value="ofLoan" ${percentType === 'ofLoan' ? 'selected' : ''}>of Loan</option>
          <option value="ofRent" ${percentType === 'ofRent' ? 'selected' : ''}>of Rent</option>
        </select>

        <div style="display:flex;align-items:center;gap:8px;margin-left:4px;">
          <span style="font-size:12px;color:#666;white-space:nowrap;">Pay Upfront</span>
          <label class="switch">
            <input type="checkbox" class="item-upfront" ${upfront ? 'checked' : ''}>
            <span class="slider"></span>
          </label>
        </div>

        <button type="button" class="rental-btn secondary removeRowBtn" title="Remove">ðŸ—‘</button>
      `;

      const typeSel = row.querySelector('.item-type');
      const percentSel = row.querySelector('.item-percentType');

      typeSel.addEventListener('change', () => {
        percentSel.style.display = typeSel.value === 'percent' ? '' : 'none';
        updateAllTotals();
      });

      row.querySelector('.removeRowBtn').addEventListener('click', () => {
        row.remove();
        updateAllTotals();
      });

      row.querySelectorAll('input, select').forEach((el) => {
        el.addEventListener('input', updateAllTotals);
        el.addEventListener('change', updateAllTotals);
      });

      list.appendChild(row);
      updateAllTotals();
    }

    function sumItemized(listId) {
      const list = $(listId);
      if (!list) return 0;

      let sum = 0;
      Array.from(list.children).forEach((row) => {
        const val = row.querySelector('.item-value')?.value || '';
        const type = row.querySelector('.item-type')?.value || 'dollar';
        if (type === 'dollar') sum += parseCurrency(val);
        // Percent calc can be added later
      });
      return sum;
    }

    function updateTotalFor(listId, totalSpanId) {
      const el = $(totalSpanId);
      if (!el) return;
      el.textContent = fmtMoney(sumItemized(listId));
    }

    function updateAllTotals() {
      if ($('itemizePurchaseCosts')?.checked) updateTotalFor('purchaseCostsList', 'purchaseCostsTotal');
      if ($('itemizeRehabCosts')?.checked) updateTotalFor('rehabCostsList', 'rehabCostsTotal');
      if ($('itemizeOperatingExpenses')?.checked) updateTotalFor('operatingExpensesList', 'operatingExpensesTotal');

      recomputeFinancingTotals();
    }

    let purchasePrepopulated = false;
    function prepopulatePurchaseCosts() {
      if (purchasePrepopulated) return;
      const list = $('purchaseCostsList');
      if (!list) return;

      list.innerHTML = '';
      createItemRow('purchaseCostsList', 'Home Inspection', '350', 'dollar', 'ofPrice', true);
      createItemRow('purchaseCostsList', 'Appraisal', '550', 'dollar', 'ofPrice', true);
      createItemRow('purchaseCostsList', 'Loan Points', '2', 'percent', 'ofLoan', true);
      createItemRow('purchaseCostsList', 'Closing Costs', '2', 'percent', 'ofPrice', true);
      createItemRow('purchaseCostsList', 'Attorney Fee', '1', 'percent', 'ofPrice', true);
      purchasePrepopulated = true;
      updateAllTotals();
    }

    let rehabPrepopulated = false;
    function prepopulateRehabCosts() {
      if (rehabPrepopulated) return;
      const list = $('rehabCostsList');
      if (!list) return;

      list.innerHTML = '';
      createItemRow('rehabCostsList', 'New Carpet', '1500', 'dollar', 'ofPrice', true);
      createItemRow('rehabCostsList', 'Interior Paint', '750', 'dollar', 'ofPrice', true);
      createItemRow('rehabCostsList', 'New Fixtures', '300', 'dollar', 'ofPrice', true);
      createItemRow('rehabCostsList', 'New Appliances', '2500', 'dollar', 'ofPrice', true);
      createItemRow('rehabCostsList', 'Landscaping', '250', 'dollar', 'ofPrice', true);
      rehabPrepopulated = true;
      updateAllTotals();
    }

    function toggleItemization(switchId, itemizedId, totalInputId) {
      const sw = $(switchId);
      const itemized = $(itemizedId);
      const totalInput = $(totalInputId);
      if (!sw || !itemized || !totalInput) return;

      const update = () => {
        if (sw.checked) {
          itemized.style.display = '';
          totalInput.style.display = 'none';
        } else {
          itemized.style.display = 'none';
          totalInput.style.display = '';
        }
        updateAllTotals();
      };

      sw.addEventListener('change', update);
      update();
    }

    /* ---------- Financing (multi-loan) ---------- */
    const loans = []; // {label,target,principal,rate,termMonths,type,monthlyPayment}

    function getPurchasePrice() { return parseCurrency($('purchasePrice')?.value); }
    function getRehabTotal() {
      return $('itemizeRehabCosts')?.checked
        ? sumItemized('rehabCostsList')
        : parseCurrency($('rehabCostsTotalValue')?.value);
    }
    function getARV() { return parseCurrency($('arv')?.value); }

    function loanMonthlyPayment(principal, annualRatePct, termMonths, loanType) {
      const P = Number(principal) || 0;
      const r = (Number(annualRatePct) || 0) / 100 / 12;
      const n = Math.max(0, Number(termMonths) || 0);

      if (P <= 0) return 0;
      if (loanType === 'Interest-Only') return P * r;
      if (n <= 0) return 0;
      if (r === 0) return P / n;

      const pow = Math.pow(1 + r, n);
      return P * (r * pow) / (pow - 1);
    }

    function computeLoanPrincipalFromUI() {
      const target = $('newLoanTarget')?.value || 'purchase';
      const customAmount = parseCurrency($('newLoanCustomAmount')?.value);
      const dpSingle = Number($('newLoanDownPct')?.value) || 0;
      const dpPurchase = Number($('newLoanPriceDownPct')?.value) || 0;
      const dpRehab = Number($('newLoanRehabDownPct')?.value) || 0;

      const purchase = getPurchasePrice();
      const rehab = getRehabTotal();
      const arv = getARV();

      const clampPct = (x) => Math.min(100, Math.max(0, x));

      if (target === 'custom') return Math.max(0, customAmount);

      if (target === 'purchase_rehab') {
        const loanPurchase = purchase * (1 - clampPct(dpPurchase) / 100);
        const loanRehab = rehab * (1 - clampPct(dpRehab) / 100);
        return Math.max(0, loanPurchase + loanRehab);
      }

      let base = 0;
      if (target === 'purchase') base = purchase;
      if (target === 'rehab') base = rehab;
      if (target === 'arv') base = arv;

      return Math.max(0, base * (1 - clampPct(dpSingle) / 100));
    }

    function refreshLoanTargetUI() {
      const target = $('newLoanTarget')?.value || 'purchase';
      if (!$('newLoanCustomAmountWrap') || !$('dpPurchaseWrap') || !$('dpRehabWrap') || !$('dpSingleWrap')) return;

      if (target === 'custom') {
        $('newLoanCustomAmountWrap').style.display = '';
        $('dpPurchaseWrap').style.display = 'none';
        $('dpRehabWrap').style.display = 'none';
        $('dpSingleWrap').style.display = 'none';
      } else if (target === 'purchase_rehab') {
        $('newLoanCustomAmountWrap').style.display = 'none';
        $('dpPurchaseWrap').style.display = '';
        $('dpRehabWrap').style.display = '';
        $('dpSingleWrap').style.display = 'none';
      } else {
        $('newLoanCustomAmountWrap').style.display = 'none';
        $('dpPurchaseWrap').style.display = 'none';
        $('dpRehabWrap').style.display = 'none';
        $('dpSingleWrap').style.display = '';
      }
    }

    function setLoanPreview(text) {
      const el = $('loanPreviewNote');
      if (!el) return;
      if (!text) { el.style.display = 'none'; el.textContent = ''; return; }
      el.style.display = '';
      el.textContent = text;
    }

    function renderLoans() {
      const list = $('loanList');
      if (!list) return;
      list.innerHTML = '';

      loans.forEach((loan, idx) => {
        const div = document.createElement('div');
        div.className = 'loan-item';
        div.innerHTML = `
          <div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <b>${loan.label || 'Loan'}</b>
              <span class="loan-pill">${loan.type}</span>
              <span class="loan-pill">${loan.rate.toFixed(2)}%</span>
              <span class="loan-pill">${loan.termMonths} mo</span>
            </div>
            <div class="meta" style="margin-top:6px;">
              Principal: <b>${fmtMoney(loan.principal)}</b><br>
              Est. Monthly Payment: <b>${fmtMoney(loan.monthlyPayment)}</b>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="btn secondary" data-remove="${idx}">Remove</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll('button[data-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.getAttribute('data-remove'));
          if (!Number.isNaN(i)) loans.splice(i, 1);
          renderLoans();
          recomputeFinancingTotals();
        });
      });
    }

    function recomputeFinancingTotals() {
      const totalEl = $('computedLoanAmount');
      if (!totalEl) return;

      if (!$('useFinancing')?.checked) {
        totalEl.textContent = '$0';
        return;
      }
      const total = loans.reduce((acc, l) => acc + (Number(l.principal) || 0), 0);
      totalEl.textContent = fmtMoney(total);
    }

    function bindFinancingUI() {
      const useFin = $('useFinancing');
      const area = $('financingArea');

      if (useFin && area) {
        const update = () => {
          area.style.display = useFin.checked ? 'block' : 'none';
          recomputeFinancingTotals();
        };
        useFin.addEventListener('change', update);
        update();
      }

      on('newLoanTarget', 'change', () => { refreshLoanTargetUI(); setLoanPreview(''); });

      const preview = () => setLoanPreview('');
      [
        'purchasePrice','arv','rehabCostsTotalValue','newLoanCustomAmount',
        'newLoanDownPct','newLoanPriceDownPct','newLoanRehabDownPct',
        'newLoanRate','newLoanTerm','newLoanType','itemizeRehabCosts'
      ].forEach(id => {
        on(id, 'input', preview);
        on(id, 'change', preview);
      });

      on('previewLoanBtn', 'click', () => {
        const principal = computeLoanPrincipalFromUI();
        const rate = Number($('newLoanRate')?.value) || 0;
        const term = Number($('newLoanTerm')?.value) || 0;
        const type = $('newLoanType')?.value || 'Interest-Only';
        const pay = loanMonthlyPayment(principal, rate, term, type);

        const purchase = getPurchasePrice();
        const rehab = getRehabTotal();
        const arv = getARV();
        const target = $('newLoanTarget')?.value || 'purchase';

        const baseText = (t) => {
          if (t === 'purchase') return `Base: Purchase ${fmtMoney(purchase)}`;
          if (t === 'rehab') return `Base: Rehab ${fmtMoney(rehab)}`;
          if (t === 'arv') return `Base: ARV ${fmtMoney(arv)}`;
          if (t === 'purchase_rehab') return `Base: Purchase+Rehab ${fmtMoney(purchase + rehab)}`;
          return `Custom`;
        };

        setLoanPreview(`${baseText(target)} â€¢ Principal ${fmtMoney(principal)} â€¢ Est. Payment ${fmtMoney(pay)}/mo`);
      });

      on('addLoanBtn', 'click', () => {
        const label = ($('newLoanLabel')?.value || '').trim() || `Loan ${loans.length + 1}`;
        const target = $('newLoanTarget')?.value || 'purchase';
        const principal = computeLoanPrincipalFromUI();
        const rate = Number($('newLoanRate')?.value) || 0;
        const termMonths = Number($('newLoanTerm')?.value) || 0;
        const type = $('newLoanType')?.value || 'Interest-Only';
        const monthlyPayment = loanMonthlyPayment(principal, rate, termMonths, type);

        loans.push({ label, target, principal, rate, termMonths, type, monthlyPayment });
        renderLoans();
        recomputeFinancingTotals();
        setLoanPreview('');
      });

      refreshLoanTargetUI();
      renderLoans();
      recomputeFinancingTotals();
    }

    /* ---------- Results + Chart + PDF ---------- */
    function calculateResults() {
      const purchaseTotal = $('itemizePurchaseCosts')?.checked
        ? sumItemized('purchaseCostsList')
        : parseCurrency($('purchaseCostsTotalValue')?.value);

      const rehabTotal = $('itemizeRehabCosts')?.checked
        ? sumItemized('rehabCostsList')
        : parseCurrency($('rehabCostsTotalValue')?.value);

      const opExTotal = $('itemizeOperatingExpenses')?.checked
        ? sumItemized('operatingExpensesList')
        : parseCurrency($('operatingExpensesTotalValue')?.value);

      if ($('resultsSummary')) {
        $('resultsSummary').innerHTML = `
          <ul style="list-style:none;padding:0;">
            <li><b>Purchase Costs:</b> ${fmtMoney(purchaseTotal)}</li>
            <li><b>Rehab Costs:</b> ${fmtMoney(rehabTotal)}</li>
            <li><b>Operating Expenses:</b> ${fmtMoney(opExTotal)}</li>
            <li><b>Total Financed Loan Amount:</b> ${$('computedLoanAmount')?.textContent || '$0'}</li>
          </ul>
        `;
      }

      drawResultsChart(purchaseTotal, rehabTotal, opExTotal);
    }

    function loadChartJs(cb) {
      if (window.Chart) return cb();
      loadScript('https://cdn.jsdelivr.net/npm/chart.js', cb);
    }

    let chartInstance = null;
    function drawResultsChart(purchase, rehab, opEx) {
      loadChartJs(() => {
        const canvas = $('resultsChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Purchase', 'Rehab', 'Operating Expenses'],
            datasets: [{
              data: [purchase, rehab, opEx],
              backgroundColor: ['#2E8B57', '#1a2a4f', '#b5d6c7']
            }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      });
    }

    function loadJsPdf(cb) {
      if (window.jspdf) return cb();
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', cb);
    }

    /* ---------- Init (everything binds AFTER DOM is ready) ---------- */
    window.addEventListener('DOMContentLoaded', () => {
      setupAddressAutocomplete();

      // Itemization toggles
      toggleItemization('itemizePurchaseCosts', 'purchaseCostsItemized', 'purchaseCostsTotalInput');
      toggleItemization('itemizeRehabCosts', 'rehabCostsItemized', 'rehabCostsTotalInput');
      toggleItemization('itemizeOperatingExpenses', 'operatingExpensesItemized', 'operatingExpensesTotalInput');

      // Buttons
      on('addPurchaseCost', 'click', () => createItemRow('purchaseCostsList'));
      on('addRehabCost', 'click', () => createItemRow('rehabCostsList'));
      on('addOperatingExpense', 'click', () => createItemRow('operatingExpensesList'));

      on('nextStep', 'click', () => showStep(1));
      on('prevStep2', 'click', () => showStep(0));
      on('nextStep2', 'click', () => showStep(2));
      on('prevStep3', 'click', () => showStep(1));
      on('nextStep3', 'click', () => showStep(3));
      on('prevStep4', 'click', () => showStep(2));
      on('nextStep4', 'click', () => showStep(4));
      on('prevStep5', 'click', () => showStep(3));

      // Calculate -> Results
      on('calculateBtn', 'click', () => { calculateResults(); showStep(5); });
      on('backToEditBtn', 'click', () => showStep(0));

      // PDF
      on('downloadPdfBtn', 'click', () => {
        loadJsPdf(() => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(18);
          doc.text('Rental Calculator Report', 14, 18);
          doc.setFontSize(12);

          let y = 30;
          const text = $('resultsSummary') ? $('resultsSummary').innerText : '';
          const summary = text.split('\n').filter(Boolean);
          summary.forEach(line => { doc.text(line, 14, y); y += 8; });

          doc.save('rental-calculator-report.pdf');
        });
      });

      // Financing logic
      bindFinancingUI();

      // Show first step (even if CSS is hiding everything)
      showStep(0);
      updateAllTotals();
    });
  </script>
</body>
</html>
