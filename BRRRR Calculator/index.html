<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UTAH REIA - BRRRR Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    @media (max-width: 700px) {
      .wrap, .brrrr-wrap { max-width: 100vw; margin: 0; padding: 8px 2vw; border-radius: 0; box-shadow: none; }
      .brrrr-card { padding: 14px 6px; margin-bottom: 12px; border-radius: 8px; }
      .brrrr-row { flex-direction: column; gap: 0; }
      .brrrr-field { min-width: 0; margin-bottom: 10px; }
      .brrrr-label { font-size: 13px; }
      .brrrr-input, .brrrr-select, .brrrr-textarea { font-size: 15px; padding: 12px 10px; border-radius: 6px; }
      .brrrr-summary { padding: 16px 6px 12px 6px; font-size: 1em; max-width: 98vw; }
      .brrrr-btn { padding: 10px 12px; font-size: 1em; border-radius: 8px; }
      .brrrr-step-indicator { font-size: 1em; }
      .brrrr-summary-list li { font-size: 1em; padding: 8px 0 6px 0; }
      .brrrr-summary-label, .brrrr-summary-value { font-size: 1em; }
      .brrrr-summary-icon { width: 18px; height: 18px; font-size: 1em; }
      .btn, .brrrr-btn { font-size: 1em; padding: 10px 12px; border-radius: 8px; }
      .loan-card { font-size: 1em; }
      .loan-info { font-size: 1em; }
    }

    body { font-family: Inter, system-ui, Arial; background: #f6f7f8; color: #111; margin: 0; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 20px 60px rgba(10,20,30,0.06); }
    .top { display: flex; align-items: center; gap: 16px; justify-content: center; margin-bottom: 6px; }
    .top img { height: 68px; }
    h1 { color: #1a2a4f; font-size: 20px; margin: 6px 0 2px; text-align: center; }
    .subtitle { text-align: center; color: #666; margin-bottom: 12px; }
    .btn { background: #2E8B57; color: #fff; padding: 10px 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
    .btn.secondary { background: #eaeaea; color: #1a2a4f; }

    /* BRRRR Calculator Styles */
    .brrrr-wrap { max-width: 700px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); padding: 32px 24px; font-family: Inter, Arial, sans-serif; }
    .brrrr-step { display: none; }
    .brrrr-step.active { display: block; animation: fadeIn 0.25s; }
    .brrrr-card { background: #f8fafb; border-radius: 10px; padding: 24px 18px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .brrrr-row { display: flex; gap: 18px; flex-wrap: wrap; }
    .brrrr-field { flex: 1 1 220px; min-width: 140px; margin-bottom: 14px; }
    .brrrr-label { display: block; font-weight: 600; color: #1a2a4f; margin-bottom: 6px; font-size: 14px; }
    .brrrr-input, .brrrr-select, .brrrr-textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e7e7e7; font-size: 15px; background:#fff; }
    .brrrr-textarea { min-height: 64px; }
    .brrrr-muted, .muted-small { color: #666; font-size: 13px; }
    .brrrr-nav { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 18px; flex-wrap: wrap; }
    .brrrr-btn { background: #2E8B57; color: #fff; padding: 10px 22px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; }
    .brrrr-btn.secondary { background: #eaeaea; color: #1a2a4f; }

    .brrrr-summary {
      background: linear-gradient(120deg, #f6f7f8 60%, #eaf6ef 100%);
      border-radius: 14px;
      padding: 28px 32px 22px 32px;
      margin-top: 24px;
      font-size: 1.13rem;
      box-shadow: 0 4px 24px rgba(46,139,87,0.08);
      border: 1.5px solid #e0e7ef;
      max-width: 540px;
      margin-left: auto;
      margin-right: auto;
    }
    .brrrr-summary-list { list-style: none; padding: 0; margin: 0; }
    .brrrr-summary-list li {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 0 8px 0; border-bottom: 1px solid #e7e7e7; font-size: 1.02em;
    }
    .brrrr-summary-list li:last-child { border-bottom: none; }
    .brrrr-summary-label {
      flex: 1 1 60%; color: #1a2a4f; font-weight: 600; letter-spacing: 0.01em;
      display: flex; align-items: center; gap: 7px;
    }
    .brrrr-summary-value { flex: 0 0 auto; font-weight: 800; color: #2E8B57; font-size: 1.02em; letter-spacing: 0.01em; }
    .brrrr-summary-value.negative { color: #b00020; }
    .brrrr-summary-icon { width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; font-size: 1.1em; opacity: 0.82; }

    .loan-list { margin-top: 12px; }
    .loan-card {
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px; padding: 12px; border-radius: 10px;
      background: #fff; border: 1px solid #e7e7e7; margin-bottom: 10px;
    }
    .loan-info { font-size: 13px; color: #222; }
    .loan-actions { display:flex; gap: 8px; flex-wrap: wrap; }

    /* One global switch style (no duplicates) */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .25s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .25s; border-radius: 50%; }
    input:checked + .slider { background-color: #2E8B57; }
    input:checked + .slider:before { transform: translateX(20px); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>

<body>
  <div class="wrap" id="brrrrWrap">
    <div class="top">
      <img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo">
    </div>

    <h1>UTAH REIA BRRRR Calculator</h1>
    <div class="subtitle">Step-by-step analysis for Buy, Rehab, Rent, Refinance, Repeat (BRRRR) investments.</div>

    <div id="brrrrCalculatorContainer"></div>

    <div style="text-align:center;margin-top:12px;color:#666;font-size:13px">
      © 2025 UTAH REIA - Estimates are educational only.
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      // ---------------------------
      // GLOBAL STATE (SAFE INIT)
      // ---------------------------
      window.brrrrData = window.brrrrData || {};

      // ---------------------------
      // HELPERS
      // ---------------------------
      function parseCurrency(val) {
        if (!val) return 0;
        if (typeof val === "number") return val;
        return Number(String(val).replace(/[^0-9.-]+/g, "")) || 0;
      }

      function formatCurrency(num) {
        const n = Number(num) || 0;
        return "$" + n.toLocaleString(undefined, { maximumFractionDigits: 2 });
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, function (m) {
          return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[m]);
        });
      }

      // Currency formatting on inputs
      function stripCurrencyOnFocus(e) { e.target.value = String(e.target.value || "").replace(/[^\d.]/g, ""); }
      function formatCurrencyInput(e) {
        let val = String(e.target.value || "").replace(/[^\d.]/g, "");
        if (!val) { e.target.value = ""; return; }
        const parts = val.split(".");
        let intPart = parts[0].replace(/^0+(?!$)/, "");
        intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const decPart = parts[1] ? "." + parts[1].slice(0, 2) : "";
        e.target.value = "$" + intPart + decPart;
      }

      function attachCurrencyFormatters(scope) {
        const ids = [
          "purchasePrice", "rehab", "arv",
          "purchaseCosts",
          "refiCosts",
          "rent", "otherIncome",
          "taxes", "insurance", "otherExpenses",
          "newLoanCustomAmount"
        ];
        ids.forEach(id => {
          const el = scope.querySelector("#" + id) || document.getElementById(id);
          if (!el) return;
          el.removeEventListener("focus", stripCurrencyOnFocus);
          el.removeEventListener("input", formatCurrencyInput);
          el.removeEventListener("blur", formatCurrencyInput);
          el.addEventListener("focus", stripCurrencyOnFocus);
          el.addEventListener("input", formatCurrencyInput);
          el.addEventListener("blur", formatCurrencyInput);
        });
      }

      // Generic script loader
      function loadScript(src, globalName, cb) {
        if (globalName && window[globalName]) { cb(); return; }
        const existing = document.querySelector('script[src="' + src + '"]');
        if (existing) {
          // Avoid duplicate callbacks turning into errors
          existing.addEventListener("load", cb, { once: true });
          // If it already loaded, cb still ok
          try { cb(); } catch (_) {}
          return;
        }
        const s = document.createElement("script");
        s.src = src;
        s.onload = cb;
        s.onerror = function () { console.warn("Failed to load:", src); cb(); };
        document.body.appendChild(s);
      }

      // ---------------------------
      // OPTIONAL: GOOGLE PLACES AUTOCOMPLETE
      // ---------------------------
      function setupAddressAutocomplete() {
        const input = document.getElementById("street");
        if (!input) return;

        const GMAPS_SRC = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBv5v5ZA_pJvv_jT_ERUuXAQbG0xBqOWRY&libraries=places";

        loadScript(GMAPS_SRC, null, function () {
          try {
            if (!window.google || !google.maps || !google.maps.places) return;
            const autocomplete = new google.maps.places.Autocomplete(input, { types: ["address"] });
            autocomplete.addListener("place_changed", function () {
              const place = autocomplete.getPlace();
              if (!place || !place.address_components) return;

              place.address_components.forEach(function (comp) {
                if (comp.types.includes("locality")) {
                  const city = document.getElementById("city"); if (city) city.value = comp.long_name;
                  window.brrrrData.city = comp.long_name;
                }
                if (comp.types.includes("administrative_area_level_1")) {
                  const st = document.getElementById("state"); if (st) st.value = comp.short_name;
                  window.brrrrData.state = comp.short_name;
                }
                if (comp.types.includes("postal_code")) {
                  const zip = document.getElementById("zip"); if (zip) zip.value = comp.long_name;
                  window.brrrrData.zip = comp.long_name;
                }
              });
            });
          } catch (e) {
            console.warn("Autocomplete setup error:", e);
          }
        });
      }

      // ---------------------------
      // UI ROOT
      // ---------------------------
      const container = document.getElementById("brrrrCalculatorContainer");
      if (!container) return;

      const root = document.createElement("div");
      root.className = "brrrr-wrap";
      root.innerHTML = `
        <form id="brrrrForm" autocomplete="off">
          <div id="brrrrSteps"></div>
        </form>

        <div id="brrrrExportArea" style="display:none;background:#fff;">
          <div id="brrrrReportHeadline" style="text-align:center;font-size:1.35em;font-weight:800;color:#1a2a4f;margin-bottom:18px;letter-spacing:0.01em;">
            UTAH REIA BRRRR CALCULATOR REPORT
          </div>
          <div id="brrrrSummary" class="brrrr-summary"></div>
          <div id="brrrrCharts" style="margin-top:24px;"></div>
        </div>

        <div style="text-align:center;">
          <button id="brrrrDownload" class="brrrr-btn" style="display:none;margin:18px auto 0 auto;" type="button">Download PDF</button>
        </div>
        <div id="brrrrPdfError" style="display:none;color:#b00020;text-align:center;margin-top:10px;font-weight:700;"></div>
      `;
      container.appendChild(root);

      const stepsArea = root.querySelector("#brrrrSteps");
      const summaryDiv = root.querySelector("#brrrrSummary");
      const exportArea = root.querySelector("#brrrrExportArea");
      const chartsDiv = root.querySelector("#brrrrCharts");
      const dlBtn = root.querySelector("#brrrrDownload");
      const pdfErr = root.querySelector("#brrrrPdfError");

      // ---------------------------
      // LOAN STATE
      // ---------------------------
      let loans = []; // holding/acquisition loans

      // ---------------------------
      // DEFAULTS + RESET (SAFE RESETS)
      // ---------------------------
      function applyDefaultData(force) {
        // Step 4 Purchase Costs defaults
        if (force || !Array.isArray(window.brrrrData.purchaseCostItems) || window.brrrrData.purchaseCostItems.length === 0) {
          window.brrrrData.purchaseCostItems = [
            { label: "Home Inspection", amount: "400", mode: "fixed" },
            { label: "Loan Points", amount: "2", mode: "pct_loan" },
            { label: "Closing Costs", amount: "2000", mode: "fixed" }
          ];
        } else {
          window.brrrrData.purchaseCostItems = window.brrrrData.purchaseCostItems.map(it => {
            if (String(it.label || "").toLowerCase().includes("loan points")) {
              return { label: it.label || "Loan Points", amount: (it.amount == null || it.amount === "") ? "2" : String(it.amount), mode: it.mode || "pct_loan" };
            }
            return { label: it.label || "", amount: it.amount || "", mode: it.mode || "fixed" };
          });
        }

        // Step 6 Refi costs defaults
        if (force || !Array.isArray(window.brrrrData.refiCostItems) || window.brrrrData.refiCostItems.length === 0) {
          window.brrrrData.refiCostItems = [
            { label: "Appraisal", amount: "750" },
            { label: "Lender Fees", amount: "1000" },
            { label: "Closing Costs", amount: "1500" },
          ];
        } else {
          const hasLand = window.brrrrData.refiCostItems.some(it => String(it.label || "").toLowerCase().includes("landscap"));
          if (!hasLand) window.brrrrData.refiCostItems.push({ label: "Landscaping (annualized)", amount: "600" });
        }

        // Step 8 expenses defaults
        if (force || !Array.isArray(window.brrrrData.expenseItems) || window.brrrrData.expenseItems.length === 0) {
          window.brrrrData.expenseItems = [
            { label: "Property Taxes", amount: "3250", period: "perYear" },
            { label: "Insurance", amount: "750", period: "perYear" },
            { label: "Property Management", amount: "8", period: "percentRent" },
            { label: "Maintenance", amount: "8", period: "percentRent" },
            { label: "Capital Reserves", amount: "2", period: "percentRent" },
            { label: "Common Utilities", amount: "75", period: "perMonth" },
            { label: "Landscaping", amount: "50", period: "perMonth" }
          ];
        }

        // Default rehab items
        if (force || !Array.isArray(window.brrrrData.rehabItems) || window.brrrrData.rehabItems.length === 0) {
          window.brrrrData.rehabItems = [
            { label: "Exterior Stucco Repair", amount: "1750" },
            { label: "New North/East Side Fence", amount: "2800" },
            { label: "Unit 1 - New Windows", amount: "1800" },
            { label: "Unit 1 - Master Bath Shower", amount: "2500" },
            { label: "Unit 2 - Stairwell Repair", amount: "2200" },
            { label: "Unit 1/2 - Full Interior Paint", amount: "1750" },
            { label: "Unit 1/2 - New Carpet", amount: "2500" },
            { label: "Unit 1/2 - New Fixtures", amount: "750" },
            { label: "Unit 1/2 - New Appliances", amount: "1800" },
            { label: "Unit 1/2 - New Water Heaters", amount: "2000" },
            { label: "Landscaping", amount: "350" },
            { label: "Trash Removal", amount: "750" }
          ];
        }
      }

      function resetAllData() {
        // Clear user-entered values and volatile state
        window.brrrrData = {};
        loans = [];

        // Re-apply defaults so UI still has prefilled line-items
        applyDefaultData(true);

        // Hide export/results and any errors
        if (exportArea) exportArea.style.display = "none";
        if (summaryDiv) summaryDiv.style.display = "none";
        if (chartsDiv) { chartsDiv.style.display = "none"; chartsDiv.innerHTML = ""; }
        if (dlBtn) dlBtn.style.display = "none";
        if (pdfErr) { pdfErr.style.display = "none"; pdfErr.textContent = ""; }
      }

      // Initialize defaults on first load
      applyDefaultData(false);

      // ---------------------------
      // STEPS (ALIGNED TO CHRIS)
      // ---------------------------
      const steps = [
        {
          title: "Property Info",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field">
                  <label class="brrrr-label">Street address</label>
                  <input class="brrrr-input" id="street" type="text" placeholder="Start typing address...">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">City</label>
                  <input class="brrrr-input" id="city" type="text" placeholder="City">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">State</label>
                  <input class="brrrr-input" id="state" type="text" placeholder="UT">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">ZIP code</label>
                  <input class="brrrr-input" id="zip" type="text" placeholder="ZIP">
                </div>
              </div>
              <div class="brrrr-field">
                <label class="brrrr-label">Property features / description</label>
                <textarea class="brrrr-textarea" id="features" placeholder="3 bed / 2 bath..."></textarea>
              </div>
              <div class="brrrr-muted">Tip: Address autocomplete may require your domain to be authorized in Google Cloud.</div>
            </div>`
        },

        {
          title: "Acquisition Numbers",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field">
                  <label class="brrrr-label">Purchase Price</label>
                  <input class="brrrr-input" id="purchasePrice" type="text" placeholder="$240,000">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">Rehab Costs</label>
                  <label class="switch" style="margin-left:8px;">
                    <input id="useRehabBreakdown" type="checkbox">
                    <span class="slider"></span>
                  </label>
                  <span class="muted-small" style="margin-left:8px;">Itemize Rehab Costs</span>
                  <input class="brrrr-input" id="rehab" type="text" placeholder="$40,000" style="margin-top:8px;">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">After Repair Value (ARV)</label>
                  <input class="brrrr-input" id="arv" type="text" placeholder="$300,000">
                </div>
              </div>

              <div id="rehabBreakdownArea" style="display:none;margin-top:12px;">
                <div style="margin-bottom:10px;font-weight:700;color:#1a2a4f;">Itemized Rehab Costs</div>
                <div id="rehabItemsList"></div>
                <button type="button" class="btn" id="addRehabItemBtn">Add Rehab Item</button>
                <div style="margin-top:10px;font-weight:800;color:#1a2a4f;">Total: <span id="rehabBreakdownTotal">$0</span></div>
              </div>

              <div class="brrrr-muted">These values are used across financing, cash flow, and summary calculations.</div>
            </div>`
        },

        {
          title: "Hold Period",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field">
                  <label class="brrrr-label">Holding Timeframe (months)</label>
                  <select class="brrrr-select" id="holdingTime">
                    <option value="0.5">0.5 (2 wks)</option>
                    <option value="1">1</option>
                    <option value="3">3</option>
                    <option value="6" selected>6</option>
                    <option value="9">9</option>
                    <option value="12">12</option>
                    <option value="24">24</option>
                  </select>
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">Notes (optional)</label>
                  <input class="brrrr-input" id="notes" type="text" placeholder="Any assumptions you want to remember">
                </div>
              </div>
              <div class="brrrr-muted">We use holding time for reference and (optional) future enhancements.</div>
            </div>`
        },

        {
          title: "Purchase Cost",
          html: `
            <div class="brrrr-card">
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                <label class="brrrr-label" style="margin:0;">Itemize Purchase Costs</label>
                <label class="switch">
                  <input id="usePurchaseCostBreakdown" type="checkbox">
                  <span class="slider"></span>
                </label>
                <div class="muted-small">Toggle to itemize purchase costs or enter one total.</div>
              </div>

              <div id="purchaseCostSimpleField">
                <div class="brrrr-row">
                  <div class="brrrr-field">
                    <label class="brrrr-label">Total Purchase Costs</label>
                    <input class="brrrr-input" id="purchaseCosts" type="text" placeholder="$10,000">
                  </div>
                </div>
              </div>

              <div id="purchaseCostBreakdownArea" style="display:none;">
                <div style="margin-bottom:10px;font-weight:700;color:#1a2a4f;">Itemized Purchase Costs</div>
                <div class="brrrr-muted" style="margin-bottom:10px;">
                  Loan Points default to <strong>2%</strong> of the financed loan amount (based on your Step 5 loans).
                </div>
                <div id="purchaseCostItemsList"></div>
                <button type="button" class="btn" id="addPurchaseCostItemBtn">Add Purchase Cost Item</button>
                <div style="margin-top:10px;font-weight:800;color:#1a2a4f;">Total: <span id="purchaseCostBreakdownTotal">$0</span></div>
              </div>
            </div>`
        },

        {
          title: "Refinance/Financing",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-muted">Financing (Holding / Acquisition Loans)</div>

              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:10px 0;">
                <label class="brrrr-label" style="margin:0;">Use Financing</label>
                <input id="useFinancing" type="checkbox" style="transform:scale(1.2);" checked>
                <div class="muted-small">Add one or more loans to model payment impact.</div>

                <a href="https://retorocapitalinvestments.com/funding"
                  target="_blank" rel="noopener"
                  class="btn" style="background:#001F3F;color:#fff;text-decoration:none;">
                  Get a Loan
                </a>
              </div>

              <div id="financingArea" style="margin-top:8px;display:block;">
                <div style="display:flex;gap:12px;flex-wrap:wrap">
                  <div class="brrrr-field">
                    <label class="brrrr-label">Loan Label</label>
                    <input id="newLoanLabel" class="brrrr-input" type="text" placeholder="e.g., Hard Money - Lender A">
                  </div>

                  <div class="brrrr-field">
                    <label class="brrrr-label">Loan Based On</label>
                    <select id="newLoanTarget" class="brrrr-select">
                      <option value="purchase">% of Purchase Price</option>
                      <option value="rehab">% of Rehab Cost</option>
                      <option value="arv">% of ARV</option>
                      <option value="purchase_rehab">% of Purchase + Rehab Cost</option>
                      <option value="custom">Custom Amount</option>
                    </select>
                  </div>

                  <div class="brrrr-field" id="newLoanCustomAmountWrap" style="display:none;">
                    <label class="brrrr-label">Custom Loan Amount</label>
                    <input id="newLoanCustomAmount" class="brrrr-input" type="text" placeholder="$50,000">
                  </div>

                  <div class="brrrr-field" id="dpPurchaseWrap" style="display:none;">
                    <label class="brrrr-label">Purchase Down Payment (%)</label>
                    <input id="newLoanPriceDownPct" class="brrrr-input" type="number" min="0" max="100" step="0.1" value="10">
                  </div>

                  <div class="brrrr-field" id="dpRehabWrap" style="display:none;">
                    <label class="brrrr-label">Rehab Down Payment (%)</label>
                    <input id="newLoanRehabDownPct" class="brrrr-input" type="number" min="0" max="100" step="0.1" value="10">
                  </div>

                  <div class="brrrr-field" id="dpSingleWrap">
                    <label class="brrrr-label">Down Payment (%)</label>
                    <input id="newLoanDownPct" class="brrrr-input" type="number" min="0" max="100" step="0.1" value="10">
                  </div>

                  <div class="brrrr-field">
                    <label class="brrrr-label">Loan Type</label>
                    <select id="newLoanType" class="brrrr-select">
                      <option value="Interest-Only">Interest-Only</option>
                      <option value="Amortized">Amortized</option>
                    </select>
                  </div>

                  <div class="brrrr-field">
                    <label class="brrrr-label">Interest Rate (%)</label>
                    <input id="newLoanRate" class="brrrr-input" type="number" min="0" step="0.1" value="15">
                  </div>

                  <div class="brrrr-field">
                    <label class="brrrr-label">Loan Term (months)</label>
                    <input
                      id="newLoanTerm"
                      class="brrrr-input"
                      type="number"
                      min="0"
                      step="1"
                      value="6"
                      placeholder="e.g., 6"
                    >
                  </div>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <button
    type="button"
    class="btn"
    id="previewLoanBtn"
    style="background:#001F3F;color:#fff;"
  >
    Preview Loan
  </button>

  <button type="button" class="btn" id="addLoanBtn">Add Loan</button>

  <div class="muted-small">Tip: Add multiple loans to model blended payment impact.</div>
</div>

<div id="loanPreviewNote" class="muted-small" style="display:none;margin-top:8px;"></div>


                <div class="loan-list" id="loanList"></div>

                <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                  <div class="brrrr-field" style="min-width:220px">
                    <label class="brrrr-label">Total Financed Loan Amount</label>
                    <div id="computedLoanAmount" style="font-weight:900;padding:10px;background:#fff;border-radius:8px;border:1px solid #e7e7e7;">$0</div>
                  </div>
                </div>
              </div>
            </div>`
        },

        {
          title: "Refinance Cost",
          html: `
            <div class="brrrr-card">
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                <label class="brrrr-label" style="margin:0;">Itemize Refinance Costs</label>
                <label class="switch">
                  <input id="useRefiCostBreakdown" type="checkbox">
                  <span class="slider"></span>
                </label>
                <div class="muted-small">Toggle to itemize refinance costs or enter one total.</div>
              </div>

              <div id="refiCostSimpleField">
                <div class="brrrr-row">
                  <div class="brrrr-field">
                    <label class="brrrr-label">Total Refinance Costs</label>
                    <input class="brrrr-input" id="refiCosts" type="text" placeholder="$3,250">
                  </div>
                </div>
              </div>

              <div id="refiCostBreakdownArea" style="display:none;">
                <div style="margin-bottom:10px;font-weight:700;color:#1a2a4f;">Itemized Refinance Costs</div>
                <div id="refiCostItemsList"></div>
                <button type="button" class="btn" id="addRefiCostItemBtn">Add Refi Cost Item</button>
                <div style="margin-top:10px;font-weight:800;color:#1a2a4f;">Total: <span id="refiCostBreakdownTotal">$0</span></div>
              </div>
            </div>`
        },

        {
          title: "Monthly Rent",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field">
                  <label class="brrrr-label">Monthly Rent</label>
                  <input class="brrrr-input" id="rent" type="text" placeholder="$1,800">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">Vacancy (%)</label>
                  <input class="brrrr-input" id="vacancy" type="number" min="0" max="100" step="0.1" placeholder="5">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">Other Income</label>
                  <input class="brrrr-input" id="otherIncome" type="text" placeholder="$0">
                </div>
                <div class="brrrr-field">
                  <label class="brrrr-label">Annual Rent Increase (%)</label>
                  <input class="brrrr-input" id="rentIncrease" type="number" min="0" step="0.1" value="3">
                </div>
              </div>
              <div class="brrrr-muted">Effective rent accounts for vacancy and other income.</div>
            </div>`
        },

        {
          title: "Operating Expenses",
          html: `
            <div class="brrrr-card">
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                <label class="brrrr-label" style="margin:0;">Use Expense Breakdown</label>
                <label class="switch">
                  <input id="useExpenseBreakdown" type="checkbox">
                  <span class="slider"></span>
                </label>
                <div class="muted-small">Toggle to itemize expenses or use simple fields.</div>
              </div>

              <div id="expenseSimpleFields">
                <div class="brrrr-row">
                  <div class="brrrr-field">
                    <label class="brrrr-label">Monthly Taxes</label>
                    <input class="brrrr-input" id="taxes" type="text" placeholder="$200">
                  </div>
                  <div class="brrrr-field">
                    <label class="brrrr-label">Monthly Insurance</label>
                    <input class="brrrr-input" id="insurance" type="text" placeholder="$100">
                  </div>
                  <div class="brrrr-field">
                    <label class="brrrr-label">Other Monthly Expenses</label>
                    <input class="brrrr-input" id="otherExpenses" type="text" placeholder="$150">
                  </div>
                </div>
                <div class="brrrr-row">
                  <div class="brrrr-field">
                    <label class="brrrr-label">Annual Expense Increase (%)</label>
                    <input class="brrrr-input" id="expenseIncrease" type="number" min="0" step="0.1" value="2">
                  </div>
                </div>
              </div>

              <div id="expenseBreakdownArea" style="display:none;">
                <div style="margin-bottom:10px;font-weight:700;color:#1a2a4f;">Itemized Operating Expenses</div>
                <div id="expenseItemsList"></div>
                <button type="button" class="btn" id="addExpenseItemBtn">Add Expense Item</button>
                <div style="margin-top:10px;font-weight:800;color:#1a2a4f;">Total (raw sum): <span id="expenseBreakdownTotal">$0</span></div>

                <div class="brrrr-row" style="margin-top:10px;">
                  <div class="brrrr-field">
                    <label class="brrrr-label">Annual Expense Increase (%)</label>
                    <input class="brrrr-input" id="expenseIncreaseBreakdown" type="number" min="0" step="0.1" value="2">
                  </div>
                </div>
              </div>
            </div>`
        },

        {
          title: "Appreciation & Selling Costs",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field">
                  <label class="brrrr-label">Annual Appreciation (%)</label>
                  <input class="brrrr-input" id="appreciation" type="number" min="0" step="0.1" value="3">
                </div>

                <div class="brrrr-field">
                  <label class="brrrr-label">Hold Years (for appreciation + exit calc)</label>
                  <input class="brrrr-input" id="holdYears" type="number" min="0" step="0.1" value="1">
                </div>

                <div class="brrrr-field">
                  <label class="brrrr-label">Selling Costs (% of sale price)</label>
                  <input class="brrrr-input" id="sellingCostPct" type="number" min="0" step="0.1" value="8">
                </div>
              </div>

              <div class="brrrr-muted">
                Selling costs can include commissions + closing costs. We apply it as a % of the projected sale price.
              </div>
            </div>`
        },

        {
          title: "Depreciation",
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field">
                  <label class="brrrr-label">Depreciation (years)</label>
                  <input class="brrrr-input" id="depreciation" type="number" min="0" step="0.1" placeholder="27.5">
                </div>
              </div>
              <div class="brrrr-muted">Depreciation is captured for reference. Tax impact is not calculated in this version.</div>
            </div>`
        }
      ];

      // ---------------------------
      // RENDER + NAV
      // ---------------------------
      let current = 0;

      function saveStepData() {
        const inputs = stepsArea.querySelectorAll("input,textarea,select");
        inputs.forEach(el => {
          if (!el.id) return;
          if (el.type === "checkbox") window.brrrrData[el.id] = el.checked;
          else window.brrrrData[el.id] = el.value;
        });
      }

      function restoreStepData() {
        const inputs = stepsArea.querySelectorAll("input,textarea,select");
        inputs.forEach(el => {
          if (!el.id) return;
          if (window.brrrrData[el.id] === undefined) return;
          if (el.type === "checkbox") el.checked = !!window.brrrrData[el.id];
          else el.value = window.brrrrData[el.id];
        });
      }

      function renderNav(n) {
        const backHidden = (n === 0) ? 'style="display:none;"' : "";
        const nextOrCalc = (n < steps.length - 1)
          ? `<button type="button" id="brrrrStepNext" class="brrrr-btn">Next →</button>`
          : `<button type="button" id="brrrrCalculate" class="brrrr-btn" style="background:#2E8B57;">Calculate</button>`;

        return `
          <div class="brrrr-nav">
            <button type="button" id="brrrrStepPrev" class="brrrr-btn secondary" ${backHidden}>← Back</button>
            ${nextOrCalc}
          </div>
        `;
      }

      function renderStep(n) {
        const stepIndicator = `
          <div class="brrrr-step-indicator" style="text-align:center;font-weight:800;margin-bottom:12px;color:#2E8B57;font-size:1.05em;">
            Step ${n + 1} of ${steps.length}: ${escapeHtml(steps[n].title)}
          </div>
        `;

        stepsArea.innerHTML = `
          ${stepIndicator}
          <div class="brrrr-step active">
            ${steps[n].html}
            ${renderNav(n)}
          </div>
        `;

        // Hide results when navigating steps
        if (exportArea) exportArea.style.display = "none";
        if (summaryDiv) summaryDiv.style.display = "none";
        if (chartsDiv) chartsDiv.style.display = "none";
        if (dlBtn) dlBtn.style.display = "none";
        if (pdfErr) { pdfErr.style.display = "none"; pdfErr.textContent = ""; }

        restoreStepData();
        attachCurrencyFormatters(stepsArea);

        // Step-specific wiring
        wireStep(n);

        if (n === 0) setupAddressAutocomplete();

        // Nav wiring
        const prev = document.getElementById("brrrrStepPrev");
        const next = document.getElementById("brrrrStepNext");
        const calc = document.getElementById("brrrrCalculate");

        if (prev) prev.onclick = function () {
          saveStepData();
          current = Math.max(0, current - 1);
          renderStep(current);
        };

        if (next) next.onclick = function () {
          saveStepData();
          current = Math.min(steps.length - 1, current + 1);
          renderStep(current);
        };

        if (calc) calc.onclick = function () {
          saveStepData();
          showResults();
        };

        // Save on change/blur
        stepsArea.querySelectorAll("input,textarea,select").forEach(el => {
          el.addEventListener("change", () => {
            if (!el.id) return;
            if (el.type === "checkbox") window.brrrrData[el.id] = el.checked;
            else window.brrrrData[el.id] = el.value;
          });
          el.addEventListener("blur", () => {
            if (!el.id) return;
            if (el.type === "checkbox") window.brrrrData[el.id] = el.checked;
            else window.brrrrData[el.id] = el.value;
          });
        });
      }

      // ---------------------------
      // REHAB BREAKDOWN
      // ---------------------------
      function wireRehabBreakdown() {
        const toggle = document.getElementById("useRehabBreakdown");
        const area = document.getElementById("rehabBreakdownArea");
        const rehabInput = document.getElementById("rehab");
        if (!toggle || !area || !rehabInput) return;

        toggle.checked = !!window.brrrrData.useRehabBreakdown;

        function toggleUI() {
          const on = toggle.checked;
          area.style.display = on ? "block" : "none";
          rehabInput.style.display = on ? "none" : "block";
          if (on) renderRehabItems();
        }

        toggle.onchange = function () {
          window.brrrrData.useRehabBreakdown = toggle.checked;
          toggleUI();
        };

        toggleUI();
      }

      function updateRehabTotal() {
        const total = (window.brrrrData.rehabItems || []).reduce((sum, item) => {
          return sum + (parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0);
        }, 0);
        const el = document.getElementById("rehabBreakdownTotal");
        if (el) el.textContent = formatCurrency(total);
        window.brrrrData.rehab = String(total);
      }

      function renderRehabItems() {
        const list = document.getElementById("rehabItemsList");
        if (!list) return;
        list.innerHTML = "";

        (window.brrrrData.rehabItems || []).forEach((item, idx) => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.gap = "8px";
          row.style.marginBottom = "6px";

          const amtFormatted = item.amount ? formatCurrency(item.amount) : "";

          row.innerHTML = `
            <input type="text" class="brrrr-input" style="width:220px;" value="${escapeHtml(item.label || "")}" placeholder="Rehab Item">
            <input type="text" class="brrrr-input" style="width:140px;" value="${escapeHtml(amtFormatted)}" placeholder="$0">
            <button type="button" class="btn secondary">Delete</button>
          `;

          row.children[0].onchange = function () {
            window.brrrrData.rehabItems[idx].label = row.children[0].value;
          };

          row.children[1].onfocus = stripCurrencyOnFocus;
          row.children[1].oninput = formatCurrencyInput;
          row.children[1].onblur = function () {
            formatCurrencyInput({ target: row.children[1] });
            const raw = row.children[1].value.replace(/[^0-9.-]+/g, "");
            window.brrrrData.rehabItems[idx].amount = raw;
            updateRehabTotal();
          };

          row.children[2].onclick = function () {
            window.brrrrData.rehabItems.splice(idx, 1);
            renderRehabItems();
            updateRehabTotal();
          };

          list.appendChild(row);
        });

        updateRehabTotal();

        const add = document.getElementById("addRehabItemBtn");
        if (add) add.onclick = function () {
          window.brrrrData.rehabItems.push({ label: "", amount: "" });
          renderRehabItems();
          updateRehabTotal();
        };
      }

      // ---------------------------
      // PURCHASE COST ITEMIZATION
      // ---------------------------
      function getTotalFinancedLoanAmount() {
        if (window.brrrrData.useFinancing === false) return 0;
        const total = loans.reduce((sum, l) => sum + (Number(l.financed) || 0), 0);
        if (total > 0) return total;
        return parseCurrency(window.brrrrData.purchasePrice);
      }

      function wirePurchaseCostBreakdown() {
        const useBreakdown = document.getElementById("usePurchaseCostBreakdown");
        const simple = document.getElementById("purchaseCostSimpleField");
        const area = document.getElementById("purchaseCostBreakdownArea");
        if (!useBreakdown || !simple || !area) return;

        useBreakdown.checked = !!window.brrrrData.usePurchaseCostBreakdown;

        function toggleUI() {
          const on = useBreakdown.checked;
          simple.style.display = on ? "none" : "block";
          area.style.display = on ? "block" : "none";
          if (on) renderPurchaseCostItems();
        }

        useBreakdown.onchange = function () {
          window.brrrrData.usePurchaseCostBreakdown = useBreakdown.checked;
          toggleUI();
        };

        toggleUI();
      }

      function computePurchaseCosts() {
        if (window.brrrrData.usePurchaseCostBreakdown) {
          const loanBase = getTotalFinancedLoanAmount();
          return (window.brrrrData.purchaseCostItems || []).reduce((sum, item) => {
            const amt = parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0;
            if (item.mode === "pct_loan") return sum + (loanBase * (amt / 100));
            return sum + amt;
          }, 0);
        }
        return parseCurrency(window.brrrrData.purchaseCosts);
      }

      function renderPurchaseCostItems() {
        const list = document.getElementById("purchaseCostItemsList");
        if (!list) return;
        list.innerHTML = "";

        const loanBase = getTotalFinancedLoanAmount();

        (window.brrrrData.purchaseCostItems || []).forEach((item, idx) => {
          if (!item.mode) item.mode = "fixed";
          if (String(item.label || "").toLowerCase().includes("loan points") && item.mode !== "pct_loan") item.mode = "pct_loan";
          if (String(item.label || "").toLowerCase().includes("loan points") && (item.amount == null || item.amount === "")) item.amount = "2";

          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.gap = "8px";
          row.style.marginBottom = "8px";
          row.style.flexWrap = "wrap";

          const isPctLoan = item.mode === "pct_loan";
          const displayAmount = isPctLoan ? String(item.amount || "2") : (item.amount ? formatCurrency(item.amount) : "");
          const computed = isPctLoan ? (loanBase * ((parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0) / 100)) : null;

          row.innerHTML = `
            <div style="flex:1 1 220px;min-width:200px;">
              <label class="muted-small" style="display:block;margin-bottom:4px;">Item</label>
              <input type="text" class="brrrr-input" value="${escapeHtml(item.label || "")}" placeholder="Cost Name">
            </div>

            <div style="flex:0 0 160px;min-width:160px;">
              <label class="muted-small" style="display:block;margin-bottom:4px;">Type</label>
              <select class="brrrr-input">
                <option value="fixed" ${item.mode === "fixed" ? "selected" : ""}>$ Fixed</option>
                <option value="pct_loan" ${item.mode === "pct_loan" ? "selected" : ""}>% of Loan</option>
              </select>
            </div>

            <div style="flex:0 0 160px;min-width:160px;">
              <label class="muted-small" style="display:block;margin-bottom:4px;">Amount</label>
              <input type="text" class="brrrr-input" value="${escapeHtml(displayAmount)}" placeholder="${isPctLoan ? "2" : "$0"}">
            </div>

            <div style="flex:0 0 120px;min-width:120px;display:flex;align-items:flex-end;">
              <button type="button" class="btn secondary" style="width:100%;">Delete</button>
            </div>

            ${isPctLoan ? `
              <div style="flex:1 1 100%;margin-top:-4px;">
                <div class="muted-small">
                  Based on loan amount: <strong>${formatCurrency(loanBase)}</strong> → Points cost: <strong>${formatCurrency(computed)}</strong>
                </div>
              </div>
            ` : ``}
          `;

          const labelEl = row.querySelectorAll("input.brrrr-input")[0];
          const typeEl  = row.querySelectorAll("select.brrrr-input")[0];
          const amtEl   = row.querySelectorAll("input.brrrr-input")[1];
          const delBtn  = row.querySelectorAll("button")[0];

          labelEl.onchange = function () {
            window.brrrrData.purchaseCostItems[idx].label = labelEl.value;
          };

          typeEl.onchange = function () {
            window.brrrrData.purchaseCostItems[idx].mode = typeEl.value;
            const isLP = String(window.brrrrData.purchaseCostItems[idx].label || "").toLowerCase().includes("loan points");
            if (typeEl.value === "pct_loan" && (window.brrrrData.purchaseCostItems[idx].amount == null || window.brrrrData.purchaseCostItems[idx].amount === "")) {
              window.brrrrData.purchaseCostItems[idx].amount = isLP ? "2" : "0";
            }
            renderPurchaseCostItems();
            updatePurchaseCostTotal();
          };

          amtEl.onfocus = function () {
            if (typeEl.value === "fixed") stripCurrencyOnFocus({ target: amtEl });
          };
          amtEl.oninput = function () {
            if (typeEl.value === "fixed") formatCurrencyInput({ target: amtEl });
          };
          amtEl.onblur = function () {
            if (typeEl.value === "fixed") {
              formatCurrencyInput({ target: amtEl });
              window.brrrrData.purchaseCostItems[idx].amount = amtEl.value.replace(/[^0-9.-]+/g, "");
            } else {
              const raw = amtEl.value.replace(/[^0-9.-]+/g, "");
              amtEl.value = raw;
              window.brrrrData.purchaseCostItems[idx].amount = raw;
            }
            updatePurchaseCostTotal();
          };

          delBtn.onclick = function () {
            window.brrrrData.purchaseCostItems.splice(idx, 1);
            renderPurchaseCostItems();
            updatePurchaseCostTotal();
          };

          list.appendChild(row);
        });

        updatePurchaseCostTotal();

        const add = document.getElementById("addPurchaseCostItemBtn");
        if (add) add.onclick = function () {
          window.brrrrData.purchaseCostItems.push({ label: "", amount: "", mode: "fixed" });
          renderPurchaseCostItems();
          updatePurchaseCostTotal();
        };
      }

      function updatePurchaseCostTotal() {
        const total = computePurchaseCosts();
        const el = document.getElementById("purchaseCostBreakdownTotal");
        if (el) el.textContent = formatCurrency(total);
      }

      // ---------------------------
      // REFI COST ITEMIZATION
      // ---------------------------
      function wireRefiCostBreakdown() {
        const useBreakdown = document.getElementById("useRefiCostBreakdown");
        const simple = document.getElementById("refiCostSimpleField");
        const area = document.getElementById("refiCostBreakdownArea");
        if (!useBreakdown || !simple || !area) return;

        useBreakdown.checked = !!window.brrrrData.useRefiCostBreakdown;

        function toggleUI() {
          const on = useBreakdown.checked;
          simple.style.display = on ? "none" : "block";
          area.style.display = on ? "block" : "none";
          if (on) renderRefiCostItems();
        }

        useBreakdown.onchange = function () {
          window.brrrrData.useRefiCostBreakdown = useBreakdown.checked;
          toggleUI();
        };

        toggleUI();
      }

      function computeRefiCosts() {
        if (window.brrrrData.useRefiCostBreakdown) {
          return (window.brrrrData.refiCostItems || []).reduce((sum, item) => {
            return sum + (parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0);
          }, 0);
        }
        return parseCurrency(window.brrrrData.refiCosts);
      }

      function renderRefiCostItems() {
        const list = document.getElementById("refiCostItemsList");
        if (!list) return;
        list.innerHTML = "";

        (window.brrrrData.refiCostItems || []).forEach((item, idx) => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.gap = "8px";
          row.style.marginBottom = "6px";

          const amtFormatted = item.amount ? formatCurrency(item.amount) : "";

          row.innerHTML = `
            <input type="text" class="brrrr-input" style="width:220px;" value="${escapeHtml(item.label || "")}" placeholder="Cost Name">
            <input type="text" class="brrrr-input" style="width:140px;" value="${escapeHtml(amtFormatted)}" placeholder="$0">
            <button type="button" class="btn secondary">Delete</button>
          `;

          row.children[0].onchange = function () {
            window.brrrrData.refiCostItems[idx].label = row.children[0].value;
          };

          row.children[1].onfocus = stripCurrencyOnFocus;
          row.children[1].oninput = formatCurrencyInput;
          row.children[1].onblur = function () {
            formatCurrencyInput({ target: row.children[1] });
            const raw = row.children[1].value.replace(/[^0-9.-]+/g, "");
            window.brrrrData.refiCostItems[idx].amount = raw;
            updateRefiCostTotal();
          };

          row.children[2].onclick = function () {
            window.brrrrData.refiCostItems.splice(idx, 1);
            renderRefiCostItems();
            updateRefiCostTotal();
          };

          list.appendChild(row);
        });

        updateRefiCostTotal();

        const add = document.getElementById("addRefiCostItemBtn");
        if (add) add.onclick = function () {
          window.brrrrData.refiCostItems.push({ label: "", amount: "" });
          renderRefiCostItems();
          updateRefiCostTotal();
        };
      }

      function updateRefiCostTotal() {
        const total = computeRefiCosts();
        const el = document.getElementById("refiCostBreakdownTotal");
        if (el) el.textContent = formatCurrency(total);
      }

      // ---------------------------
      // EXPENSE ITEMIZATION
      // ---------------------------
      function wireExpenseBreakdown() {
        const useBreakdown = document.getElementById("useExpenseBreakdown");
        const simple = document.getElementById("expenseSimpleFields");
        const area = document.getElementById("expenseBreakdownArea");
        if (!useBreakdown || !simple || !area) return;

        useBreakdown.checked = !!window.brrrrData.useExpenseBreakdown;

        function toggleUI() {
          const on = useBreakdown.checked;
          simple.style.display = on ? "none" : "block";
          area.style.display = on ? "block" : "none";
          if (on) renderExpenseItems();
        }

        useBreakdown.onchange = function () {
          window.brrrrData.useExpenseBreakdown = useBreakdown.checked;
          toggleUI();
        };

        toggleUI();
      }

      function renderExpenseItems() {
        const list = document.getElementById("expenseItemsList");
        if (!list) return;
        list.innerHTML = "";

        (window.brrrrData.expenseItems || []).forEach((item, idx) => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.gap = "8px";
          row.style.marginBottom = "6px";
          row.style.flexWrap = "wrap";

          const isMoney = (item.period === "perYear" || item.period === "perMonth");
          const amtFormatted = (item.amount && isMoney) ? formatCurrency(item.amount) : (item.amount || "");

          row.innerHTML = `
            <input type="text" class="brrrr-input" style="width:200px;" value="${escapeHtml(item.label || "")}" placeholder="Expense Name">
            <input type="text" class="brrrr-input" style="width:120px;" value="${escapeHtml(amtFormatted)}" placeholder="$0 or %">
            <select class="brrrr-input" style="width:130px;">
              <option value="perYear" ${item.period === "perYear" ? "selected" : ""}>Per Year</option>
              <option value="perMonth" ${item.period === "perMonth" ? "selected" : ""}>Per Month</option>
              <option value="percentRent" ${item.period === "percentRent" ? "selected" : ""}>% of Rent</option>
            </select>
            <button type="button" class="btn secondary">Delete</button>
          `;

          row.children[0].onchange = function () {
            window.brrrrData.expenseItems[idx].label = row.children[0].value;
          };

          row.children[1].onfocus = function () {
            const period = row.children[2].value;
            if (period === "perYear" || period === "perMonth") stripCurrencyOnFocus({ target: row.children[1] });
          };
          row.children[1].oninput = function () {
            const period = row.children[2].value;
            if (period === "perYear" || period === "perMonth") formatCurrencyInput({ target: row.children[1] });
          };
          row.children[1].onblur = function () {
            const period = row.children[2].value;
            let raw = row.children[1].value;
            if (period === "perYear" || period === "perMonth") {
              formatCurrencyInput({ target: row.children[1] });
              raw = row.children[1].value.replace(/[^0-9.-]+/g, "");
            } else {
              raw = row.children[1].value.replace(/[^0-9.-]+/g, "");
              row.children[1].value = raw;
            }
            window.brrrrData.expenseItems[idx].amount = raw;
            updateExpenseTotalRaw();
          };

          row.children[2].onchange = function () {
            window.brrrrData.expenseItems[idx].period = row.children[2].value;
            renderExpenseItems();
            updateExpenseTotalRaw();
          };

          row.children[3].onclick = function () {
            window.brrrrData.expenseItems.splice(idx, 1);
            renderExpenseItems();
            updateExpenseTotalRaw();
          };

          list.appendChild(row);
        });

        updateExpenseTotalRaw();

        const add = document.getElementById("addExpenseItemBtn");
        if (add) add.onclick = function () {
          window.brrrrData.expenseItems.push({ label: "", amount: "", period: "perMonth" });
          renderExpenseItems();
          updateExpenseTotalRaw();
        };

        const inc = document.getElementById("expenseIncreaseBreakdown");
        if (inc) {
          if (window.brrrrData.expenseIncreaseBreakdown !== undefined) inc.value = window.brrrrData.expenseIncreaseBreakdown;
          inc.onchange = function () { window.brrrrData.expenseIncreaseBreakdown = inc.value; };
        }
      }

      function updateExpenseTotalRaw() {
        const total = (window.brrrrData.expenseItems || []).reduce((sum, item) => {
          return sum + (parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0);
        }, 0);
        const el = document.getElementById("expenseBreakdownTotal");
        if (el) el.textContent = formatCurrency(total);
      }

      // ---------------------------
      // STEP WIRING
      // ---------------------------
      function wireStep(n) {
        const title = steps[n].title;

        if (title === "Acquisition Numbers") {
          wireRehabBreakdown();
          if (window.brrrrData.useRehabBreakdown) updateRehabTotal();
        }

        if (title === "Purchase Cost") {
          wirePurchaseCostBreakdown();
        }

        if (title === "Refinance/Financing") {
  const useFin = document.getElementById("useFinancing");
  const area = document.getElementById("financingArea");

  if (useFin && area) {
    useFin.checked = (window.brrrrData.useFinancing !== undefined) ? !!window.brrrrData.useFinancing : true;
    area.style.display = useFin.checked ? "block" : "none";

    useFin.onchange = function () {
      window.brrrrData.useFinancing = useFin.checked;
      area.style.display = useFin.checked ? "block" : "none";

      // Clear preview + show real totals
      updateAggregatedLoanAmountDisplay(0);

      if (window.brrrrData.usePurchaseCostBreakdown) {
        const pcList = document.getElementById("purchaseCostItemsList");
        if (pcList) renderPurchaseCostItems();
      }
    };
  }

  const targetSel = document.getElementById("newLoanTarget");
  const customWrap = document.getElementById("newLoanCustomAmountWrap");
  const dpPurchaseWrap = document.getElementById("dpPurchaseWrap");
  const dpRehabWrap = document.getElementById("dpRehabWrap");
  const dpSingleWrap = document.getElementById("dpSingleWrap");

  function refreshLoanUI() {
    if (!targetSel) return;
    const target = targetSel.value;
    if (customWrap) customWrap.style.display = (target === "custom") ? "block" : "none";
    if (dpPurchaseWrap) dpPurchaseWrap.style.display = (target === "purchase_rehab") ? "block" : "none";
    if (dpRehabWrap) dpRehabWrap.style.display = (target === "purchase_rehab") ? "block" : "none";
    if (dpSingleWrap) dpSingleWrap.style.display = (["purchase", "rehab", "arv"].includes(target)) ? "block" : "none";
  }

  if (targetSel) {
    targetSel.onchange = refreshLoanUI;
    refreshLoanUI();
  }

  function computeFinancedForLoan() {
    const purchasePrice = parseCurrency(window.brrrrData.purchasePrice);
    const rehab = parseCurrency(window.brrrrData.rehab);
    const arv = parseCurrency(window.brrrrData.arv);

    const targetEl = document.getElementById("newLoanTarget");
    const target = targetEl ? targetEl.value : "purchase";
    let financed = 0;

    if (target === "purchase_rehab") {
      const dpP = document.getElementById("newLoanPriceDownPct");
      const dpR = document.getElementById("newLoanRehabDownPct");
      const pctPriceDP = dpP ? (Number(dpP.value) || 0) : 0;
      const pctRehabDP = dpR ? (Number(dpR.value) || 0) : 0;
      financed = purchasePrice * (1 - pctPriceDP / 100) + rehab * (1 - pctRehabDP / 100);
    } else if (target === "purchase") {
      const dp = document.getElementById("newLoanDownPct");
      const down = dp ? (Number(dp.value) || 0) : 0;
      financed = purchasePrice * (1 - down / 100);
    } else if (target === "rehab") {
      const dp = document.getElementById("newLoanDownPct");
      const down = dp ? (Number(dp.value) || 0) : 0;
      financed = rehab * (1 - down / 100);
    } else if (target === "arv") {
      const dp = document.getElementById("newLoanDownPct");
      const down = dp ? (Number(dp.value) || 0) : 0;
      financed = arv * (1 - down / 100);
    } else if (target === "custom") {
      const custom = document.getElementById("newLoanCustomAmount");
      financed = custom ? parseCurrency(custom.value) : 0;
    }

    return financed;
  }

  function renderLoanList() {
    const list = document.getElementById("loanList");
    if (!list) return;
    list.innerHTML = "";

    loans.forEach(l => {
      const div = document.createElement("div");
      div.className = "loan-card";
      div.innerHTML = `
        <div class="loan-info">
          <strong>${escapeHtml(l.label)}</strong>
          <div style="margin-top:3px;">
            ${formatCurrency(l.financed)} — ${escapeHtml(l.type)} @ ${Number(l.rate).toFixed(2)}% — term ${l.term || "N/A"} mo
          </div>
        </div>
        <div class="loan-actions">
          <button type="button" class="btn secondary" data-loanid="${l.id}">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("button[data-loanid]").forEach(btn => {
      btn.onclick = function (e) {
        e.preventDefault();
        const id = btn.getAttribute("data-loanid");
        loans = loans.filter(l => String(l.id) !== String(id));

        renderLoanList();
        updateAggregatedLoanAmountDisplay(0); // clear preview note, show real total

        if (window.brrrrData.usePurchaseCostBreakdown) {
          const pcList = document.getElementById("purchaseCostItemsList");
          if (pcList) renderPurchaseCostItems();
        }
      };
    });

    updateAggregatedLoanAmountDisplay(0);
  }

  function updateAggregatedLoanAmountDisplay(previewAmount) {
    const el = document.getElementById("computedLoanAmount");
    const note = document.getElementById("loanPreviewNote");
    if (!el) return;

    const existingTotal = loans.reduce((sum, l) => sum + (Number(l.financed) || 0), 0);
    const preview = Number(previewAmount) || 0;
    const grandTotal = existingTotal + preview;

    el.textContent = formatCurrency(grandTotal);

    if (note) {
      if (preview > 0) {
        note.style.display = "block";
        note.innerHTML =
          `Preview included: <strong>${formatCurrency(preview)}</strong> (not added yet). ` +
          `Existing loans: <strong>${formatCurrency(existingTotal)}</strong>`;
      } else {
        note.style.display = "none";
        note.textContent = "";
      }
    }
  }

  // Expose if needed elsewhere
  window.__updateAggregatedLoanAmountDisplay = updateAggregatedLoanAmountDisplay;

  // ---- GHL-safe: Event delegation (bind once) ----
  if (!window.__brrrrLoanButtonsBound) {
    window.__brrrrLoanButtonsBound = true;

    stepsArea.addEventListener("click", function (e) {
      // PREVIEW
      const previewBtn = e.target && e.target.closest ? e.target.closest("#previewLoanBtn") : null;
      if (previewBtn) {
        e.preventDefault();

        if (window.brrrrData.useFinancing === false) {
          updateAggregatedLoanAmountDisplay(0);
          return;
        }

        const previewAmt = computeFinancedForLoan();
        updateAggregatedLoanAmountDisplay(previewAmt);

        if (window.brrrrData.usePurchaseCostBreakdown) {
          const pcList = document.getElementById("purchaseCostItemsList");
          if (pcList) renderPurchaseCostItems();
        }
        return;
      }

      // ADD LOAN
      const addBtn = e.target && e.target.closest ? e.target.closest("#addLoanBtn") : null;
      if (addBtn) {
        e.preventDefault();

        if (window.brrrrData.useFinancing === false) {
          updateAggregatedLoanAmountDisplay(0);
          return;
        }

        const labelEl = document.getElementById("newLoanLabel");
        const typeEl = document.getElementById("newLoanType");
        const rateEl = document.getElementById("newLoanRate");
        const termEl = document.getElementById("newLoanTerm");

        const label = labelEl ? (labelEl.value || "Loan") : "Loan";
        const type = typeEl ? typeEl.value : "Interest-Only";
        const rate = rateEl ? (Number(rateEl.value) || 0) : 0;
        const term = termEl ? (Number(termEl.value) || 0) : 0;
        const financed = computeFinancedForLoan();

        loans.push({
          id: Date.now() + Math.random(),
          label, type, rate, term, financed
        });

        // SAFE clears
        if (labelEl) labelEl.value = "";
        const customAmt = document.getElementById("newLoanCustomAmount");
        if (customAmt) customAmt.value = "";
        if (termEl) termEl.value = "6";

        renderLoanList();
        updateAggregatedLoanAmountDisplay(0); // clear preview note after adding

        if (window.brrrrData.usePurchaseCostBreakdown) {
          const pcList = document.getElementById("purchaseCostItemsList");
          if (pcList) renderPurchaseCostItems();
        }
        return;
      }
    });
  }

  // Initial render
  renderLoanList();
  updateAggregatedLoanAmountDisplay(0);
}


        if (title === "Refinance Cost") {
          wireRefiCostBreakdown();
        }

        if (title === "Operating Expenses") {
          wireExpenseBreakdown();
        }
      }

      // ---------------------------
      // CALCULATION + RESULTS
      // ---------------------------
      function computeTotalMonthlyExpenses(grossRent, collectedRentBase) {
        const useBreakdown = !!window.brrrrData.useExpenseBreakdown;

        if (!useBreakdown) {
          const taxes = parseCurrency(window.brrrrData.taxes);
          const insurance = parseCurrency(window.brrrrData.insurance);
          const other = parseCurrency(window.brrrrData.otherExpenses);
          return taxes + insurance + other;
        }

        let totalMonthly = 0;
        (window.brrrrData.expenseItems || []).forEach(item => {
          let amt = parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0;

          if (item.period === "perYear") amt = amt / 12;
          if (item.period === "percentRent") {
            const base = (Number(collectedRentBase) || 0);
            amt = base * (amt / 100);
          }

          totalMonthly += amt;
        });

        return totalMonthly;
      }

      function computeHoldingLoanMonthlyPayment() {
        if (window.brrrrData.useFinancing === false) return 0;

        let monthly = 0;
        loans.forEach(l => {
          const amt = Number(l.financed || 0);
          const rate = Number(l.rate || 0) / 100 / 12;

          if (!amt || rate < 0) return;

          if (l.type === "Interest-Only") {
            monthly += amt * rate;
          } else {
            const n = Number(l.term || 0);
            if (n > 0) {
              if (rate === 0) monthly += amt / n;
              else monthly += (amt * rate) / (1 - Math.pow(1 + rate, -n));
            }
          }
        });
        return monthly;
      }

      function computeRehabCosts() {
        if (!!window.brrrrData.useRehabBreakdown) {
          return (window.brrrrData.rehabItems || []).reduce((sum, item) => {
            return sum + (parseFloat(String(item.amount).replace(/[^0-9.-]+/g, "")) || 0);
          }, 0);
        }
        return parseCurrency(window.brrrrData.rehab);
      }

      function showResults() {
        const purchasePrice = parseCurrency(window.brrrrData.purchasePrice);
        const rehab = computeRehabCosts();
        const arv = parseCurrency(window.brrrrData.arv);

        const purchaseCosts = computePurchaseCosts();
        const refiCosts = computeRefiCosts();

        const rent = parseCurrency(window.brrrrData.rent);
        const vacancyPct = Number(window.brrrrData.vacancy) || 0;
        const otherIncome = parseCurrency(window.brrrrData.otherIncome);

        const effectiveRent = (rent * (1 - vacancyPct / 100)) + otherIncome;

        const collectedRent = rent * (1 - vacancyPct / 100);
        const baseMonthlyExpenses = computeTotalMonthlyExpenses(rent, collectedRent);

        const holdingLoanMonthly = computeHoldingLoanMonthlyPayment();
        const totalMonthlyExpenses = baseMonthlyExpenses + holdingLoanMonthly;

        const cashFlow = effectiveRent - totalMonthlyExpenses;

        const appreciation = Number(window.brrrrData.appreciation) || 0;
        const holdYears = Number(window.brrrrData.holdYears) || 1;
        const sellingCostPct = Number(window.brrrrData.sellingCostPct) || 0;

        const projectedValue = purchasePrice * Math.pow(1 + appreciation / 100, holdYears);
        const sellingCosts = projectedValue * (sellingCostPct / 100);
        const netSaleProceeds = projectedValue - sellingCosts;

        const totalInvestment = purchasePrice + rehab + purchaseCosts + refiCosts;

        const propStreet = window.brrrrData.street || "";
        const propCity = window.brrrrData.city || "";
        const propState = window.brrrrData.state || "";
        const propZip = window.brrrrData.zip || "";
        const propFeatures = window.brrrrData.features || "";

        const propInfoHtml = (propStreet || propCity || propState || propZip || propFeatures) ? `
          <div style="background:#fffbe7;border-radius:12px;padding:16px 18px;margin-bottom:14px;border:1px solid #f3e7b3;">
            <div style="font-weight:900;color:#b48a00;margin-bottom:4px;">📋 Property Info</div>
            <div style="color:#1a2a4f;font-weight:700;">${escapeHtml(propStreet)}${propStreet ? ", " : ""}${escapeHtml(propCity)}${propCity ? ", " : ""}${escapeHtml(propState)} ${escapeHtml(propZip)}</div>
            ${propFeatures ? `<div style="color:#555;margin-top:6px;">${escapeHtml(propFeatures)}</div>` : ""}
          </div>
        ` : "";

        const loanBreakdown = loans.length ? `
          <details style="margin-top:6px;">
            <summary style="cursor:pointer;font-weight:800;color:#2E8B57;">View Financing Breakdown</summary>
            <div style="margin-top:8px;">
              ${loans.map(l => `
                <div style="margin-bottom:6px;font-size:13px;">
                  <strong>${escapeHtml(l.label)}</strong> — ${formatCurrency(l.financed)} — ${escapeHtml(l.type)} @ ${Number(l.rate).toFixed(2)}% — term ${l.term || "N/A"} mo
                </div>
              `).join("")}
            </div>
          </details>
        ` : "";

        summaryDiv.innerHTML = `
          ${propInfoHtml}
          <ul class="brrrr-summary-list">
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">💰</span>Total Investment:</span><span class="brrrr-summary-value">${formatCurrency(totalInvestment)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">🧾</span>Purchase Costs:</span><span class="brrrr-summary-value">${formatCurrency(purchaseCosts)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">💳</span>Refinance Costs:</span><span class="brrrr-summary-value">${formatCurrency(refiCosts)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">🏠</span>Monthly Rent:</span><span class="brrrr-summary-value">${formatCurrency(rent)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">🛏️</span>Vacancy (%):</span><span class="brrrr-summary-value">${vacancyPct.toFixed(1)}%</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">➕</span>Other Income:</span><span class="brrrr-summary-value">${formatCurrency(otherIncome)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">✅</span>Effective Rent:</span><span class="brrrr-summary-value">${formatCurrency(effectiveRent)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">📉</span>Total Monthly Expenses:</span><span class="brrrr-summary-value">${formatCurrency(totalMonthlyExpenses)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">💸</span>Estimated Monthly Cash Flow:</span><span class="brrrr-summary-value ${cashFlow >= 0 ? "" : "negative"}">${formatCurrency(cashFlow)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">📈</span>Projected Value (${holdYears} yr):</span><span class="brrrr-summary-value">${formatCurrency(projectedValue)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">🏷️</span>Selling Costs (${sellingCostPct}%):</span><span class="brrrr-summary-value">${formatCurrency(sellingCosts)}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">🏁</span>Net Sale Proceeds:</span><span class="brrrr-summary-value">${formatCurrency(netSaleProceeds)}</span></li>
          </ul>
          ${loanBreakdown}
        `;

        exportArea.style.display = "block";
        summaryDiv.style.display = "block";

        chartsDiv.style.display = "block";
        chartsDiv.innerHTML = `<div style="display:flex;justify-content:center;"><canvas id="brrrrPie" width="520" height="360"></canvas></div>`;

        loadScript("https://cdn.jsdelivr.net/npm/chart.js", "Chart", function () {
          if (!window.Chart) return;

          const cf = cashFlow;
          const pieCash = Math.abs(cf) < 0.01 ? 0.01 : Math.abs(cf);

          const canvas = document.getElementById("brrrrPie");
          if (!canvas) return;
          const ctx = canvas.getContext("2d");

          new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["Effective Rent", "Monthly Expenses", cf >= 0 ? "Cash Flow (Positive)" : "Cash Flow (Negative)"],
              datasets: [{
                data: [effectiveRent, totalMonthlyExpenses, pieCash]
              }]
            },
            options: {
              plugins: { legend: { position: "bottom" } },
              responsive: false
            }
          });
        });

        // Replace step area with result nav (safe reset included)
        stepsArea.innerHTML = `
          <div style="text-align:center;margin:14px 0;">
            <button id="brrrrResultBack" class="brrrr-btn secondary" type="button" style="margin-right:10px;">Back</button>
            <button id="brrrrResultStartOver" class="brrrr-btn" type="button">Start Over</button>
          </div>
        `;

        document.getElementById("brrrrResultBack").onclick = function () {
          current = steps.length - 1;
          renderStep(current);
        };

        document.getElementById("brrrrResultStartOver").onclick = function () {
          resetAllData();     // ✅ SAFE RESET (clears brrrrData + loans, restores defaults)
          current = 0;
          renderStep(current);
        };

        dlBtn.style.display = "block";
      }

      // ---------------------------
      // PDF DOWNLOAD
      // ---------------------------
      function downloadPDF() {
  if (pdfErr) { pdfErr.style.display = "none"; pdfErr.textContent = ""; }

  // --- Helper: replace Chart.js canvas with an image so html2canvas captures it ---
  function replaceCanvasWithImage(rootEl) {
    const canvas = rootEl.querySelector("#brrrrPie");
    if (!canvas || !canvas.toDataURL) return null;

    const img = document.createElement("img");
    img.src = canvas.toDataURL("image/png");
    img.alt = "BRRRR Chart";
    img.style.maxWidth = "100%";
    img.style.display = "block";
    img.style.margin = "0 auto";

    const parent = canvas.parentNode;
    if (!parent) return null;

    parent.replaceChild(img, canvas);
    return { canvas, img, parent };
  }

  function restoreCanvas(replaced) {
    if (!replaced || !replaced.parent || !replaced.canvas || !replaced.img) return;
    try { replaced.parent.replaceChild(replaced.canvas, replaced.img); } catch (_) {}
  }

  loadScript("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js", "html2canvas", function () {
    loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js", "jspdf", function () {
      const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
      if (!window.html2canvas || !jsPDF) {
        if (pdfErr) {
          pdfErr.innerHTML = "PDF libraries failed to load. Try reload, or use Print (Ctrl+P) → Save as PDF.";
          pdfErr.style.display = "block";
        }
        return;
      }

      const area = document.getElementById("brrrrExportArea");
      if (!area) {
        if (pdfErr) { pdfErr.textContent = "Export area not found."; pdfErr.style.display = "block"; }
        return;
      }

      // ✅ Convert the live chart canvas to an image BEFORE cloning/export
      const replacedLive = replaceCanvasWithImage(document);

      const overlay = document.createElement("div");
      overlay.style.position = "fixed";
      overlay.style.left = "0";
      overlay.style.top = "0";
      overlay.style.width = "100vw";
      overlay.style.height = "100vh";
      overlay.style.background = "#fff";
      overlay.style.zIndex = "999999";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.overflow = "auto";

      const clone = area.cloneNode(true);
      clone.style.display = "block";
      clone.style.background = "#fff";
      clone.style.padding = "18px";
      overlay.appendChild(clone);
      document.body.appendChild(overlay);

      setTimeout(function () {
        window.html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: "#fff" })
          .then(function (canvas) {
            document.body.removeChild(overlay);

            const img = canvas.toDataURL("image/jpeg", 0.98);
            const pdf = new jsPDF("p", "pt", "a4");

            const pdfW = pdf.internal.pageSize.getWidth();
            const pdfH = pdf.internal.pageSize.getHeight();
            const margin = 20;

            let imgW = pdfW - margin * 2;
            let imgH = (canvas.height * imgW) / canvas.width;

            if (imgH > pdfH - margin * 2) {
              imgH = pdfH - margin * 2;
              imgW = (canvas.width * imgH) / canvas.height;
            }

            const x = (pdfW - imgW) / 2;
            const y = margin;

            pdf.addImage(img, "JPEG", x, y, imgW, imgH);
            pdf.save("UTAHREIA_BRRRR_Report.pdf");

            // ✅ Restore live chart canvas after export
            restoreCanvas(replacedLive);
          })
          .catch(function (e) {
            try { document.body.removeChild(overlay); } catch (_) {}
            restoreCanvas(replacedLive);
            if (pdfErr) { pdfErr.textContent = "PDF export failed: " + e.message; pdfErr.style.display = "block"; }
          });
      }, 150);
    });
  });
}

if (dlBtn) dlBtn.addEventListener("click", downloadPDF);

// ---------------------------
// INITIAL RENDER
// ---------------------------
renderStep(0);

})();

  </script>
</body>
</html>
