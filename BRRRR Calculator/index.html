<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UTAH REIA - BRRRR Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
        @media (max-width: 700px) {
          .wrap, .brrrr-wrap {
            max-width: 100vw;
            margin: 0;
            padding: 8px 2vw;
            border-radius: 0;
            box-shadow: none;
          }
          .brrrr-card {
            padding: 14px 6px;
            margin-bottom: 12px;
            border-radius: 8px;
          }
          .brrrr-row {
            flex-direction: column;
            gap: 0;
          }
          .brrrr-field {
            min-width: 0;
            margin-bottom: 10px;
          }
          .brrrr-label {
            font-size: 13px;
          }
          .brrrr-input, .brrrr-select, .brrrr-textarea {
            font-size: 15px;
            padding: 12px 10px;
            border-radius: 6px;
          }
          .brrrr-summary {
            padding: 16px 6px 12px 6px;
            font-size: 1em;
            max-width: 98vw;
          }
          .brrrr-btn {
            padding: 10px 12px;
            font-size: 1em;
            border-radius: 8px;
          }
          .brrrr-step-indicator {
            font-size: 1em;
          }
          .brrrr-summary-list li {
            font-size: 1em;
            padding: 8px 0 6px 0;
          }
          .brrrr-summary-label {
            font-size: 1em;
          }
          .brrrr-summary-value {
            font-size: 1em;
          }
          .brrrr-summary-icon {
            width: 18px;
            height: 18px;
            font-size: 1em;
          }
          .btn, .brrrr-btn {
            font-size: 1em;
            padding: 10px 12px;
            border-radius: 8px;
          }
          .field, .brrrr-field {
            min-width: 0;
            margin-bottom: 10px;
          }
          .loan-card {
            font-size: 1em;
          }
          .loan-info {
            font-size: 1em;
          }
        }
    body { font-family: Inter, system-ui, Arial; background: #f6f7f8; color: #111; margin: 0; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 20px 60px rgba(10,20,30,0.06); }
    .top { display: flex; align-items: center; gap: 16px; justify-content: center; margin-bottom: 6px; }
    .top img { height: 68px; }
    h1 { color: #1a2a4f; font-size: 20px; margin: 6px 0 2px; text-align: center; }
    .subtitle { text-align: center; color: #666; margin-bottom: 12px; }
    .card { background: #fff; padding: 16px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.03); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .field { flex: 1 1 220px; min-width: 140px; margin-bottom: 10px; }
    label { display: block; font-weight: 600; color: #1a2a4f; margin-bottom: 6px; font-size: 13px; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e7e7e7; font-size: 14px; }
    textarea { min-height: 64px; }
    .muted { color: #666; font-size: 13px; }
    .btn { background: #2E8B57; color: #fff; padding: 10px 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
    .nav { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .step { display: none; opacity: 0; transition: opacity 240ms ease; }

    /* BRRRR Calculator Styles */
    .brrrr-wrap { max-width: 700px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); padding: 32px 24px; font-family: Inter, Arial, sans-serif; }
    .brrrr-step { display: none; }
    .brrrr-step.active { display: block; animation: fadeIn 0.3s; }
    .brrrr-card { background: #f8fafb; border-radius: 10px; padding: 24px 18px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .brrrr-row { display: flex; gap: 18px; flex-wrap: wrap; }
    .brrrr-field { flex: 1 1 220px; min-width: 140px; margin-bottom: 14px; }
    .brrrr-label { display: block; font-weight: 600; color: #1a2a4f; margin-bottom: 6px; font-size: 14px; }
    .brrrr-input, .brrrr-select, .brrrr-textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e7e7e7; font-size: 15px; }
    .brrrr-textarea { min-height: 64px; }
    .brrrr-muted { color: #666; font-size: 13px; }
    .brrrr-nav { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 18px; }
    .brrrr-btn { background: #2E8B57; color: #fff; padding: 10px 22px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; }
    .brrrr-btn.secondary { background: #eaeaea; color: #1a2a4f; }
    .brrrr-summary {
      background: linear-gradient(120deg, #f6f7f8 60%, #eaf6ef 100%);
      border-radius: 14px;
      padding: 28px 32px 22px 32px;
      margin-top: 24px;
      font-size: 1.13rem;
      box-shadow: 0 4px 24px rgba(46,139,87,0.08);
      border: 1.5px solid #e0e7ef;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }
    .brrrr-summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .brrrr-summary-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0 8px 0;
      border-bottom: 1px solid #e7e7e7;
      font-size: 1.08em;
    }
    .brrrr-summary-list li:last-child {
      border-bottom: none;
    }
    .brrrr-summary-label {
      flex: 1 1 60%;
      color: #1a2a4f;
      font-weight: 600;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .brrrr-summary-value {
      flex: 0 0 auto;
      font-family: 'Inter', monospace, Arial;
      font-weight: 700;
      color: #2E8B57;
      font-size: 1.08em;
      letter-spacing: 0.01em;
    }
    .brrrr-summary-value.negative {
      color: #b00020;
    }
    .brrrr-summary-icon {
      width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      opacity: 0.82;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div class="wrap" id="brrrrWrap">
    <div class="top"><img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo"></div>
    <h1>UTAH REIA BRRRR Calculator</h1>
    <div class="subtitle">Step-by-step analysis for Buy, Rehab, Rent, Refinance, Repeat (BRRRR) investments.</div>
    <div id="brrrrCalculatorContainer"></div>
    <div style="text-align:center;margin-top:12px;color:#666;font-size:13px">Â© 2025 UTAH REIA - Estimates are educational only.</div>
  </div>
  <script>
    function loadGMaps(cb) {
  if (window.google && window.google.maps && window.google.maps.places) { cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBv5v5ZA_pJvv_jT_ERUuXAQbG0xBqOWRY&libraries=places';
  s.onload = cb; document.body.appendChild(s);
}
function setupAddressAutocomplete() {
  loadGMaps(function() {
    var input = document.getElementById('street');
    if (input && window.google && window.google.maps && window.google.maps.places) {
      var autocomplete = new google.maps.places.Autocomplete(input, { types: ['address'] });
      autocomplete.addListener('place_changed', function() {
        var place = autocomplete.getPlace();
        if (place.address_components) {
          place.address_components.forEach(function(comp) {
            if (comp.types.includes('locality')) document.getElementById('city').value = comp.long_name;
            if (comp.types.includes('administrative_area_level_1')) document.getElementById('state').value = comp.short_name;
            if (comp.types.includes('postal_code')) document.getElementById('zip').value = comp.long_name;
          });
        }
      });
    }
  });
}
setupAddressAutocomplete();
    // --- Currency Formatting Helper ---

    function formatCurrencyInput(e) {
      let val = e.target.value.replace(/[^\d.]/g, '');
      if (val === '') { e.target.value = ''; return; }
      let parts = val.split('.');
      let intPart = parts[0];
      let decPart = parts[1] ? '.' + parts[1].slice(0,2) : '';
      intPart = intPart.replace(/^0+(?!$)/, '');
      intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      e.target.value = '$' + intPart + decPart;
    }

    // Remove formatting on focus for easier editing
    function stripCurrencyOnFocus(e) {
      e.target.value = e.target.value.replace(/[^\d.]/g, '');
    }


    function attachCurrencyFormatters() {
      const ids = ['purchasePrice','rehab','refiAmount','refiCosts','rent','taxes','insurance','otherExpenses'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.removeEventListener('focus', stripCurrencyOnFocus);
          el.removeEventListener('input', formatCurrencyInput);
          el.removeEventListener('blur', formatCurrencyInput);
          el.removeEventListener('change', triggerImmediateCalc);
          el.addEventListener('focus', stripCurrencyOnFocus);
          el.addEventListener('input', formatCurrencyInput);
          el.addEventListener('blur', formatCurrencyInput);
          el.addEventListener('change', triggerImmediateCalc);
        }
      });
    }

    // For immediate feedback, recalculate on change
    function triggerImmediateCalc() {
      if (typeof calculateSummary === 'function') calculateSummary();
    }

    (function(){
      // --- HTML Structure ---
      const container = document.getElementById('brrrrCalculatorContainer');
      const root = document.createElement('div');
      root.className = 'brrrr-wrap';
      root.innerHTML = `
        <form id="brrrrForm" autocomplete="off">
          <div id="brrrrSteps"></div>
        </form>
        <div id="brrrrExportArea" style="display:none;background:#fff;">
          <div id="brrrrSummary" class="brrrr-summary"></div>
          <div id="brrrrCharts" style="margin-top:24px;"></div>
        </div>
        <div style="text-align:center;"><button id="brrrrDownload" class="brrrr-btn" style="display:none;margin:18px auto 0 auto;">Download PDF</button></div>
        <div id="brrrrPdfError" style="display:none;color:#b00020;text-align:center;margin-top:10px;font-weight:600;"></div>
      `;
              // Always re-attach download PDF event listener after render
              setTimeout(() => {
                const dlBtn = document.getElementById('brrrrDownload');
                if (dlBtn) {
                  dlBtn.removeEventListener('click', downloadPDF);
                  dlBtn.addEventListener('click', downloadPDF);
                }
              }, 60);
      container.appendChild(root);

      // --- Steps Definition ---
      const steps = [
        {
          title: 'Property Info',
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field"><label class="brrrr-label">Street address</label><input class="brrrr-input" id="street" type="text" placeholder="Start typing address..."></div>
                <div class="brrrr-field"><label class="brrrr-label">City</label><input class="brrrr-input" id="city" type="text" placeholder="City"></div>
                <div class="brrrr-field"><label class="brrrr-label">State</label><input class="brrrr-input" id="state" type="text" placeholder="UT"></div>
                <div class="brrrr-field"><label class="brrrr-label">ZIP code</label><input class="brrrr-input" id="zip" type="text" placeholder="ZIP"></div>
              </div>
              <div class="brrrr-field"><label class="brrrr-label">Property features / description</label><textarea class="brrrr-textarea" id="features" placeholder="3 bed / 2 bath..."></textarea></div>
            </div>`
        },
        {
          title: 'Purchase & Rehab & ARV',
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field"><label class="brrrr-label">Purchase Price</label><input class="brrrr-input" id="purchasePrice" type="text" placeholder="$240,000"></div>
                <div class="brrrr-field"><label class="brrrr-label">Rehab Costs</label><input class="brrrr-input" id="rehab" type="text" placeholder="$40,000"></div>
                <div class="brrrr-field"><label class="brrrr-label">After Repair Value (ARV)</label><input class="brrrr-input" id="arv" type="text" placeholder="$300,000"></div>
              </div>
            </div>`
        },
        {
          title: 'Purchase Financing',
            html: `
              <div class="brrrr-card">
                <div class="muted">Financing</div>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">
                  <label class="toggle-label">
                    Use Financing
                    <label class="switch" title="Enable financing for this property">
                      <input id="useFinancing" type="checkbox">
                      <span class="slider"></span>
                    </label>
                  </label>
                  <div class="muted-small">Default: Financing ON. Add loans to model interest and financed amounts.</div>
                  <div style="margin-top:10px; margin-bottom:15px;">
                    <a href="https://retorocapitalinvestments.com/funding" 
                       target="_blank" 
                       rel="noopener"
                       class="btn"
                       style="
                         background:#001F3F;
                         color:#fff;
                         text-decoration:none;
                         padding:10px 18px;
                         border-radius:8px;
                         font-weight:600;
                         display:inline-block;">
                       Get a Loan
                    </a>
                  </div>
                </div>
                <div id="financingArea" style="margin-top:8px;display:none">
                  <div style="display:flex;gap:12px;flex-wrap:wrap">
                    <div class="field"><label>Loan Label</label><input id="newLoanLabel" type="text" placeholder="e.g., Hard Money - Lender A"></div>
                    <div class="field">
                      <label>Loan Based On</label>
                      <select id="newLoanTarget">
                        <option value="purchase">% of Purchase Price</option>
                        <option value="rehab">% of Rehab Cost</option>
                        <option value="arv">% of ARV</option>
                        <option value="purchase_rehab">% of Purchase + Rehab Cost</option>
                        <option value="custom">Custom Amount</option>
                      </select>
                    </div>
                    <div class="field" id="newLoanCustomAmountWrap" style="display:none">
                      <label>Custom Loan Amount</label>
                      <input id="newLoanCustomAmount" type="text" placeholder="$50,000">
                    </div>
                    <div class="field" id="dpPurchaseWrap" style="display:none">
                      <label>Purchase Down Payment (%)</label>
                      <input id="newLoanPriceDownPct" type="number" min="0" max="100" step="0.1" value="10">
                    </div>
                    <div class="field" id="dpRehabWrap" style="display:none">
                      <label>Rehab Down Payment (%)</label>
                      <input id="newLoanRehabDownPct" type="number" min="0" max="100" step="0.1" value="10">
                    </div>
                    <div class="field"><label>Down Payment (%)</label><input id="newLoanDownPct" type="number" min="0" max="100" value="10" step="0.1"></div>
                    <div class="field"><label>Loan Type</label><select id="newLoanType"><option>Interest-Only</option><option>Amortized</option></select></div>
                    <div class="field"><label>Interest Rate (%)</label><input id="newLoanRate" type="number" min="0" step="0.1" value="15"></div>
                    <div class="field"><label>Loan Term (months)</label><input id="newLoanTerm" type="number" min="0" step="1" placeholder="e.g., 6"></div>
                  </div>
                  <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <button type="button" class="btn" id="calculateLoanBtn" style="background:#001F3F;color:#fff">Save</button>
                    <button type="button" class="btn" id="addLoanBtn">Add a Loan</button>
                    <div class="muted-small">Click Save to calculate financed amount, then Add a Loan to confirm.</div>
                  </div>
                  <div id="loanPreview" style="margin-top:10px;padding:12px;border-radius:8px;background:#f0f8ff;border:1px solid #d0e8ff;display:none">
                    <strong>Loan Preview:</strong>
                    <div id="loanPreviewContent" style="margin-top:6px;font-size:13px;color:#333"></div>
                  </div>
                  <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                    <div class="field" style="min-width:220px">
                      <label>Holding Timeframe (months)</label>
                      <select id="holdingTime">
                        <option value="0.5">0.5 (2 wks)</option><option value="1">1</option><option value="3">3</option>
                        <option value="6" selected>6</option><option value="9">9</option><option value="12">12</option><option value="24">24</option>
                      </select>
                    </div>
                    <div class="field" style="min-width:220px">
                      <label>Computed Financed Amount</label>
                      <div style="display:flex;gap:8px;align-items:center">
                        <div id="computedLoanAmount" style="font-weight:700;padding:10px;background:#fff;border-radius:8px;border:1px solid #e7e7e7;">$0</div>
                        <div class="muted-small">Uses added loans.</div>
                      </div>
                    </div>
                  </div>
                  <div class="loan-list" id="loanList"></div>
                </div>
              </div>`
        },
        {
          title: 'Refinance',
          html: `
            <div class="brrrr-card">
              <div class="muted">Refinance Loans</div>
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">
                <label class="toggle-label">
                  Use Refinance Loans
                  <label class="switch" title="Enable refinance loans for this property">
                    <input id="useRefiFinancing" type="checkbox">
                    <span class="slider"></span>
                  </label>
                </label>
                <div class="muted-small">Default: ON. Add loans to model refi interest and amounts.</div>
              </div>
              <div id="refiFinancingArea" style="margin-top:8px;display:none">
                <div style="display:flex;gap:12px;flex-wrap:wrap">
                  <div class="field"><label>Loan Label</label><input id="newRefiLoanLabel" type="text" placeholder="e.g., Refi - Lender B"></div>
                  <div class="field">
                    <label>Loan Based On</label>
                    <select id="newRefiLoanTarget">
                      <option value="arv">% of ARV</option>
                      <option value="custom">Custom Amount</option>
                    </select>
                  </div>
                  <div class="field" id="newRefiLoanCustomAmountWrap" style="display:none">
                    <label>Custom Loan Amount</label>
                    <input id="newRefiLoanCustomAmount" type="text" placeholder="$200,000">
                  </div>
                  <div class="field" id="refiLTVWrap">
                    <label>Loan-to-Value (LTV %)</label>
                    <input id="newRefiLoanLTV" type="number" min="0" max="100" value="75" step="0.1">
                  </div>
                  <div class="field"><label>Loan Type</label><select id="newRefiLoanType"><option>Interest-Only</option><option>Amortized</option></select></div>
                  <div class="field"><label>Interest Rate (%)</label><input id="newRefiLoanRate" type="number" min="0" step="0.1" value="6"></div>
                  <div class="field"><label>Loan Term (years)</label><input id="newRefiLoanTerm" type="number" min="0" step="1" value="30"></div>
                </div>
                <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <button type="button" class="btn" id="calculateRefiLoanBtn" style="background:#001F3F;color:#fff">Save</button>
                  <button type="button" class="btn" id="addRefiLoanBtn">Add a Loan</button>
                  <div class="muted-small">Click Save to calculate amount, then Add a Loan to confirm.</div>
                </div>
                <div id="refiLoanPreview" style="margin-top:10px;padding:12px;border-radius:8px;background:#f0f8ff;border:1px solid #d0e8ff;display:none">
                  <strong>Loan Preview:</strong>
                  <div id="refiLoanPreviewContent" style="margin-top:6px;font-size:13px;color:#333"></div>
                </div>
                <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                  <div class="field" style="min-width:220px">
                    <label>Aggregate Refi Amount</label>
                    <div style="display:flex;gap:8px;align-items:center">
                      <div id="computedRefiLoanAmount" style="font-weight:700;padding:10px;background:#fff;border-radius:8px;border:1px solid #e7e7e7;">$0</div>
                      <div class="muted-small">Uses added refi loans.</div>
                    </div>
                  </div>
                </div>
                <div class="loan-list" id="refiLoanList"></div>
              </div>
              <div class="brrrr-field"><label class="brrrr-label">Refinance Costs</label><input class="brrrr-input" id="refiCosts" type="text" placeholder="$5,000"></div>
            </div>`
        },
        {
          title: 'Rental Income',
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field"><label class="brrrr-label">Monthly Rent</label><input class="brrrr-input" id="rent" type="text" placeholder="$1,800"></div>
                <div class="brrrr-field"><label class="brrrr-label">Annual Rent Increase (%)</label><input class="brrrr-input" id="rentIncrease" type="number" min="0" step="0.1" value="3"></div>
              </div>
            </div>`
        },
        {
          title: 'Operating Expenses',
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field"><label class="brrrr-label">Monthly Taxes</label><input class="brrrr-input" id="taxes" type="text" placeholder="$200"></div>
                <div class="brrrr-field"><label class="brrrr-label">Monthly Insurance</label><input class="brrrr-input" id="insurance" type="text" placeholder="$100"></div>
                <div class="brrrr-field"><label class="brrrr-label">Other Monthly Expenses</label><input class="brrrr-input" id="otherExpenses" type="text" placeholder="$150"></div>
              </div>
              <div class="brrrr-row">
                <div class="brrrr-field"><label class="brrrr-label">Annual Expense Increase (%)</label><input class="brrrr-input" id="expenseIncrease" type="number" min="0" step="0.1" value="2"></div>
              </div>
            </div>`
        },
        {
          title: 'Appreciation & Summary',
          html: `
            <div class="brrrr-card">
              <div class="brrrr-row">
                <div class="brrrr-field"><label class="brrrr-label">Annual Appreciation (%)</label><input class="brrrr-input" id="appreciation" type="number" min="0" step="0.1" value="3"></div>
              </div>
              <div id="brrrrSummaryArea" style="margin-top:18px;"></div>
            </div>`
        }
      ];

      let current = 0;
      const stepsArea = root.querySelector('#brrrrSteps');
      const summaryDiv = root.querySelector('#brrrrSummary');
      // --- Loan State ---
      let loans = [];
      let refiLoans = [];
      function unformatCurrency(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        return Number(String(val).replace(/[^0-9.-]+/g, '')) || 0;
      }
      function formatCurrency(val) {
        val = Number(val) || 0;
        return '$' + val.toLocaleString(undefined, {maximumFractionDigits:2});
      }
      function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]); });
      }
      function clearLoanInputs() {
        const ids = ['newLoanLabel','newLoanCustomAmount','newLoanDownPct','newLoanPriceDownPct','newLoanRehabDownPct','newLoanRate','newLoanTerm'];
        ids.forEach(id => { const el = document.getElementById(id); if (el) {
          if (id==='newLoanDownPct'||id==='newLoanPriceDownPct'||id==='newLoanRehabDownPct') el.value = 10;
          else if (id==='newLoanRate') el.value = 15;
          else if (id==='newLoanTerm') el.value = '';
          else el.value = '';
        }});
        const custom = document.getElementById('newLoanCustomAmountWrap');
        const dpP = document.getElementById('dpPurchaseWrap');
        const dpR = document.getElementById('dpRehabWrap');
        if (custom) custom.style.display = 'none';
        if (dpP) dpP.style.display = 'none';
        if (dpR) dpR.style.display = 'none';
      }
      function calculateLoanPreview() {
        const label = document.getElementById('newLoanLabel').value || 'Loan';
        const target = document.getElementById('newLoanTarget').value;
        const type = document.getElementById('newLoanType').value;
        const rate = Number(document.getElementById('newLoanRate').value) || 0;
        const term = Number(document.getElementById('newLoanTerm').value) || 0;
        // Always use values from brrrrData, not DOM, for cross-step consistency
        let purchasePrice = unformatCurrency(window.brrrrData?.purchasePrice);
        let repairs = unformatCurrency(window.brrrrData?.rehab);
        let arv = unformatCurrency(window.brrrrData?.arv);
        let financed = 0;
        // Debug: log all values used for calculation
        // window.alert(`purchasePrice=${purchasePrice}, repairs=${repairs}, arv=${arv}, target=${target}`);
        if (target === 'purchase_rehab') {
          const pctPriceDP = Number(document.getElementById('newLoanPriceDownPct')?.value) || 0;
          const pctRehabDP = Number(document.getElementById('newLoanRehabDownPct')?.value) || 0;
          financed = purchasePrice * (1 - pctPriceDP / 100) + repairs * (1 - pctRehabDP / 100);
        } else if (target === 'purchase') {
          const dp = Number(document.getElementById('newLoanDownPct')?.value) || 0;
          financed = purchasePrice * (1 - dp / 100);
        } else if (target === 'rehab') {
          const dp = Number(document.getElementById('newLoanDownPct')?.value) || 0;
          financed = repairs * (1 - dp / 100);
        } else if (target === 'arv') {
          const dp = Number(document.getElementById('newLoanDownPct')?.value) || 0;
          financed = arv * (1 - dp / 100);
        } else if (target === 'custom') {
          financed = unformatCurrency(document.getElementById('newLoanCustomAmount')?.value || 0);
        }
        const preview = document.getElementById('loanPreview');
        const content = document.getElementById('loanPreviewContent');
        if (preview && content) {
          content.innerHTML = `
            <div><strong>${escapeHtml(label)}</strong></div>
            <div>Target: ${target === 'purchase_rehab' ? 'Purchase + Repair' : target.charAt(0).toUpperCase() + target.slice(1)}</div>
            <div>Financed Amount: ${formatCurrency(financed)}</div>
            <div>Type: ${type}</div>
            <div>Rate: ${rate}% | Term: ${term ? term + ' months' : 'Not Set'}</div>
            <details style="margin-top:8px;color:#444;font-size:12px;"><summary>Debug Info</summary>
              <div>purchasePrice: ${purchasePrice}</div>
              <div>repairs: ${repairs}</div>
              <div>arv: ${arv}</div>
              <div>target: ${target}</div>
              <div>rate: ${rate}</div>
              <div>term: ${term}</div>
              <div>financed: ${financed}</div>
            </details>
          `;
          preview.style.display = 'block';
        }
        return financed;
      }
      function renderLoanList() {
        const list = document.getElementById('loanList');
        if (!list) return;
        list.innerHTML = '';
        loans.forEach(l => {
          const div = document.createElement('div');
          div.className = 'loan-card';
          div.innerHTML = `
            <div class="loan-info">
              <strong>${escapeHtml(l.label)}</strong>
              <div style="font-size:12px">
                ${formatCurrency(Number(l.financed || 0))} - ${escapeHtml(l.type)} @ ${l.rate}% - term ${l.term || 'N/A'} mo
              </div>
            </div>
            <div class="loan-actions">
              <button class="btn secondary" data-loanid="${l.id}">Delete</button>
            </div>`;
          list.appendChild(div);
        });
        // Attach delete events
        Array.from(list.querySelectorAll('button[data-loanid]')).forEach(btn => {
          btn.onclick = function() {
            loans = loans.filter(l => String(l.id) !== String(btn.getAttribute('data-loanid')));
            renderLoanList();
            updateAggregatedLoanAmountDisplay();
          };
        });
        updateAggregatedLoanAmountDisplay();
      }
      function updateAggregatedLoanAmountDisplay() {
        const val = computeAggregatedFinancedAmount();
        const el = document.getElementById('computedLoanAmount');
        if (el) {
          el.innerHTML = formatCurrency(val) +
            `<details style='margin-top:4px;color:#444;font-size:12px;'><summary>Debug Info</summary>` +
            loans.map((l,i) => `<div>Loan ${i+1}: ${formatCurrency(l.financed)} (${escapeHtml(l.label)})</div>`).join('') +
            `<div>Total Loans: ${loans.length}</div>` +
            `</details>`;
        }
      }
      function computeAggregatedFinancedAmount() {
        let sum = 0;
        loans.forEach(l => sum += Number(l.financed || 0));
        return sum;
      }

      function renderStep(n) {
        let navHtml = `<div class="brrrr-nav" style="margin-top:18px;">`;
        navHtml += `<button type="button" id="brrrrStepPrev" class="brrrr-btn secondary" ${n === 0 ? 'style=\"display:none\"' : ''}>&larr; Back</button>`;
        if (n < steps.length - 1) {
          navHtml += `<button type="button" id="brrrrStepNext" class="brrrr-btn">Next &rarr;</button>`;
        } else {
          navHtml += `<button type="button" id="brrrrCalculate" class="brrrr-btn" style="background:#2E8B57">Calculate</button>`;
        }
        navHtml += `</div>`;
        // Step indicator
        const stepIndicator = `<div class=\"brrrr-step-indicator\" style=\"text-align:center;font-weight:600;margin-bottom:12px;color:#2E8B57;font-size:1.1em;\">Step ${n+1} of ${steps.length}</div>`;
        stepsArea.innerHTML = `${stepIndicator}<div class=\"brrrr-step active\">${steps[n].html}${navHtml}</div>`;
        summaryDiv.style.display = 'none';
        let chartsDiv = document.getElementById('brrrrCharts');
        if (chartsDiv) chartsDiv.style.display = 'none';
        setTimeout(() => {
          attachCurrencyFormatters();
          // Ensure ARV field uses currency formatting
          const arvInput = document.getElementById('arv');
          if (arvInput) {
            arvInput.addEventListener('input', function(e) {
              let val = arvInput.value.replace(/[^\d.]/g, '');
              if (val) {
                val = parseFloat(val).toLocaleString(undefined, {maximumFractionDigits:2});
                arvInput.value = '$' + val;
              } else {
                arvInput.value = '';
              }
              calculateLoanPreview();
            });
            arvInput.addEventListener('blur', function(e) {
              let val = arvInput.value.replace(/[^\d.]/g, '');
              if (val) {
                val = parseFloat(val).toLocaleString(undefined, {maximumFractionDigits:2});
                arvInput.value = '$' + val;
              } else {
                arvInput.value = '';
              }
              calculateLoanPreview();
            });
          }
          // --- Hide loan preview on any input change, only show on Save ---
          function attachLoanPreviewHideOnInput() {
            const ids = [
              'newLoanLabel','newLoanTarget','newLoanType','newLoanRate','newLoanTerm',
              'purchasePrice','rehab','arv','newLoanDownPct','newLoanPriceDownPct','newLoanRehabDownPct','newLoanCustomAmount'
            ];
            ids.forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener('input', function() {
                  const preview = document.getElementById('loanPreview');
                  if (preview) preview.style.display = 'none';
                });
                el.addEventListener('change', function() {
                  const preview = document.getElementById('loanPreview');
                  if (preview) preview.style.display = 'none';
                });
              }
            });
          }
          attachLoanPreviewHideOnInput();
          // Pre-fill fields from brrrrData
          const allInputs = stepsArea.querySelectorAll('input,textarea');
          allInputs.forEach(input => {
            if (window.brrrrData && brrrrData[input.id] !== undefined) {
              input.value = brrrrData[input.id];
            }
            // Save on change
            input.addEventListener('change', function() {
              brrrrData[input.id] = input.value;
            });
            input.addEventListener('blur', function() {
              brrrrData[input.id] = input.value;
            });
          });
          // --- Loan UI logic ---
          if (n === 2) { // Financing step
            // Show/hide financing area
            const useFin = document.getElementById('useFinancing');
            const area = document.getElementById('financingArea');
            if (useFin && area) {
              useFin.checked = true;
              area.style.display = 'block';
              useFin.onchange = function() {
                area.style.display = useFin.checked ? 'block' : 'none';
              };
            }
            // Show/hide custom amount and down payment fields
            const targetSel = document.getElementById('newLoanTarget');
            const customWrap = document.getElementById('newLoanCustomAmountWrap');
            const dpPurchaseWrap = document.getElementById('dpPurchaseWrap');
            const dpRehabWrap = document.getElementById('dpRehabWrap');
            if (targetSel) {
              targetSel.onchange = function() {
                if (targetSel.value === 'custom') {
                  if (customWrap) customWrap.style.display = 'block';
                } else { if (customWrap) customWrap.style.display = 'none'; }
                if (targetSel.value === 'purchase_rehab') {
                  if (dpPurchaseWrap) dpPurchaseWrap.style.display = 'block';
                  if (dpRehabWrap) dpRehabWrap.style.display = 'block';
                } else {
                  if (dpPurchaseWrap) dpPurchaseWrap.style.display = 'none';
                  if (dpRehabWrap) dpRehabWrap.style.display = 'none';
                }
                // Always show Down Payment % for purchase, rehab, arv
                const dpField = document.getElementById('newLoanDownPct');
                if (dpField) {
                  if (["purchase","rehab","arv"].includes(targetSel.value)) {
                    dpField.parentElement.style.display = 'block';
                  } else {
                    dpField.parentElement.style.display = 'none';
                  }
                }
                calculateLoanPreview();
              };
              // Trigger once on load
              targetSel.onchange();
            }
            // Calculate loan preview
            const calcBtn = document.getElementById('calculateLoanBtn');
            if (calcBtn) calcBtn.onclick = function() {
              // Always recalculate and show preview
              const preview = document.getElementById('loanPreview');
              if (preview) preview.style.display = 'block';
              calculateLoanPreview();
            };
            // Add loan
            const addBtn = document.getElementById('addLoanBtn');
            if (addBtn) addBtn.onclick = function() {
              const label = document.getElementById('newLoanLabel').value || 'Loan';
              const target = document.getElementById('newLoanTarget').value;
              const type = document.getElementById('newLoanType').value;
              const rate = Number(document.getElementById('newLoanRate').value) || 0;
              const term = Number(document.getElementById('newLoanTerm').value) || 0;
              const purchasePrice = unformatCurrency(window.brrrrData?.purchasePrice);
              const repairs = unformatCurrency(window.brrrrData?.rehab);
              const arv = unformatCurrency(window.brrrrData?.arv);
              let financed = 0;
              if (target === 'purchase_rehab') {
                const pctPriceDP = Number(document.getElementById('newLoanPriceDownPct').value) || 0;
                const pctRehabDP = Number(document.getElementById('newLoanRehabDownPct').value) || 0;
                financed = purchasePrice * (1 - pctPriceDP / 100) + repairs * (1 - pctRehabDP / 100);
              } else if (target === 'purchase') {
                const dp = Number(document.getElementById('newLoanDownPct').value) || 0;
                financed = purchasePrice * (1 - dp / 100);
              } else if (target === 'rehab') {
                const dp = Number(document.getElementById('newLoanDownPct').value) || 0;
                financed = repairs * (1 - dp / 100);
              } else if (target === 'arv') {
                const dp = Number(document.getElementById('newLoanDownPct').value) || 0;
                financed = arv * (1 - dp / 100);
              } else if (target === 'custom') {
                financed = unformatCurrency(document.getElementById('newLoanCustomAmount').value || 0);
              }
              loans.push({
                id: Date.now() + Math.random(),
                label, target, type, rate, term, financed, baseFinanced: financed
              });
              renderLoanList();
              clearLoanInputs();
              // Do not hide the preview after adding a loan
              // const preview = document.getElementById('loanPreview');
              // if (preview) preview.style.display = 'none';
              updateAggregatedLoanAmountDisplay();
            };
            // Render loan list and computed amount
            renderLoanList();
            updateAggregatedLoanAmountDisplay();
          }
          // --- Refi Loan UI logic ---
          if (n === 3) { // Refinance step
            const useRefiFin = document.getElementById('useRefiFinancing');
            const area = document.getElementById('refiFinancingArea');
            if (useRefiFin && area) {
              useRefiFin.checked = true;
              area.style.display = 'block';
              useRefiFin.onchange = function() {
                area.style.display = useRefiFin.checked ? 'block' : 'none';
              };
            }
            // Show/hide custom amount field
            const targetSel = document.getElementById('newRefiLoanTarget');
            const customWrap = document.getElementById('newRefiLoanCustomAmountWrap');
            const ltvWrap = document.getElementById('refiLTVWrap');
            if (targetSel) {
              targetSel.onchange = function() {
                if (targetSel.value === 'custom') {
                  if (customWrap) customWrap.style.display = 'block';
                  if (ltvWrap) ltvWrap.style.display = 'none';
                } else {
                  if (customWrap) customWrap.style.display = 'none';
                  if (ltvWrap) ltvWrap.style.display = 'block';
                }
                calculateRefiLoanPreview();
              };
              targetSel.onchange();
            }
            // Calculate loan preview
            const calcBtn = document.getElementById('calculateRefiLoanBtn');
            if (calcBtn) calcBtn.onclick = function() {
              const preview = document.getElementById('refiLoanPreview');
              if (preview) preview.style.display = 'block';
              calculateRefiLoanPreview();
            };
            // Add loan
            const addBtn = document.getElementById('addRefiLoanBtn');
            if (addBtn) addBtn.onclick = function() {
              const label = document.getElementById('newRefiLoanLabel').value || 'Refi Loan';
              const target = document.getElementById('newRefiLoanTarget').value;
              const type = document.getElementById('newRefiLoanType').value;
              const rate = Number(document.getElementById('newRefiLoanRate').value) || 0;
              const term = Number(document.getElementById('newRefiLoanTerm').value) || 0;
              const arv = unformatCurrency(window.brrrrData?.arv);
              let financed = 0;
              if (target === 'arv') {
                const ltv = Number(document.getElementById('newRefiLoanLTV').value) || 0;
                financed = arv * (ltv / 100);
              } else if (target === 'custom') {
                financed = unformatCurrency(document.getElementById('newRefiLoanCustomAmount').value || 0);
              }
              refiLoans.push({
                id: Date.now() + Math.random(),
                label, target, type, rate, term, financed, baseFinanced: financed
              });
              renderRefiLoanList();
              clearRefiLoanInputs();
              updateAggregatedRefiLoanAmountDisplay();
            };
            renderRefiLoanList();
            updateAggregatedRefiLoanAmountDisplay();
          }
              function clearRefiLoanInputs() {
                const ids = ['newRefiLoanLabel','newRefiLoanCustomAmount','newRefiLoanLTV','newRefiLoanRate','newRefiLoanTerm'];
                ids.forEach(id => { const el = document.getElementById(id); if (el) {
                  if (id==='newRefiLoanLTV') el.value = 75;
                  else if (id==='newRefiLoanRate') el.value = 6;
                  else if (id==='newRefiLoanTerm') el.value = 30;
                  else el.value = '';
                }});
                const custom = document.getElementById('newRefiLoanCustomAmountWrap');
                if (custom) custom.style.display = 'none';
              }

              function calculateRefiLoanPreview() {
                const label = document.getElementById('newRefiLoanLabel').value || 'Refi Loan';
                const target = document.getElementById('newRefiLoanTarget').value;
                const type = document.getElementById('newRefiLoanType').value;
                const rate = Number(document.getElementById('newRefiLoanRate').value) || 0;
                const term = Number(document.getElementById('newRefiLoanTerm').value) || 0;
                let arv = unformatCurrency(window.brrrrData?.arv);
                let financed = 0;
                if (target === 'arv') {
                  const ltv = Number(document.getElementById('newRefiLoanLTV').value) || 0;
                  financed = arv * (ltv / 100);
                } else if (target === 'custom') {
                  financed = unformatCurrency(document.getElementById('newRefiLoanCustomAmount').value || 0);
                }
                const preview = document.getElementById('refiLoanPreview');
                const content = document.getElementById('refiLoanPreviewContent');
                if (preview && content) {
                  content.innerHTML = `
                    <div><strong>${label}</strong></div>
                    <div>Target: ${target === 'arv' ? 'ARV' : 'Custom'}</div>
                    <div>Financed Amount: $${financed.toLocaleString()}</div>
                    <div>Type: ${type}</div>
                    <div>Rate: ${rate}% | Term: ${term ? term + ' years' : 'Not Set'}</div>
                  `;
                  preview.style.display = 'block';
                }
                return financed;
              }

              function renderRefiLoanList() {
                const list = document.getElementById('refiLoanList');
                if (!list) return;
                list.innerHTML = '';
                refiLoans.forEach(l => {
                  const div = document.createElement('div');
                  div.className = 'loan-card';
                  div.innerHTML = `
                    <div class="loan-info">
                      <strong>${l.label}</strong>
                      <div style="font-size:12px">
                        $${Number(l.financed || 0).toLocaleString()} - ${l.type} @ ${l.rate}% - term ${l.term || 'N/A'} yrs
                      </div>
                    </div>
                    <div class="loan-actions">
                      <button class="btn secondary" data-refiloanid="${l.id}">Delete</button>
                    </div>`;
                  list.appendChild(div);
                });
                // Attach delete events
                Array.from(list.querySelectorAll('button[data-refiloanid]')).forEach(btn => {
                  btn.onclick = function() {
                    refiLoans = refiLoans.filter(l => String(l.id) !== String(btn.getAttribute('data-refiloanid')));
                    renderRefiLoanList();
                    updateAggregatedRefiLoanAmountDisplay();
                  };
                });
                updateAggregatedRefiLoanAmountDisplay();
              }

              function updateAggregatedRefiLoanAmountDisplay() {
                const val = computeAggregatedRefiFinancedAmount();
                const el = document.getElementById('computedRefiLoanAmount');
                if (el) {
                  el.innerHTML = '$' + val.toLocaleString() +
                    `<details style='margin-top:4px;color:#444;font-size:12px;'><summary>Debug Info</summary>` +
                    refiLoans.map((l,i) => `<div>Loan ${i+1}: $${Number(l.financed).toLocaleString()} (${l.label})</div>`).join('') +
                    `<div>Total Loans: ${refiLoans.length}</div>` +
                    `</details>`;
                }
              }

              function computeAggregatedRefiFinancedAmount() {
                let sum = 0;
                refiLoans.forEach(l => sum += Number(l.financed || 0));
                return sum;
              }
        }, 50);
        // Step navigation
        const navBack = document.getElementById('brrrrStepPrev');
        const navNext = document.getElementById('brrrrStepNext');
        const navCalcBtn = document.getElementById('brrrrCalculate');
        if (navBack) navBack.onclick = () => { saveStepData(); if (current > 0) { current--; renderStep(current); } };
        if (navNext) navNext.onclick = () => { saveStepData(); if (current < steps.length - 1) { current++; renderStep(current); } };
        if (navCalcBtn) navCalcBtn.onclick = () => {
  saveStepData();
  // Hide the step area (inputs and nav) when showing results
  stepsArea.innerHTML = '';
  // Add result navigation buttons
  const resultNav = document.createElement('div');
  resultNav.style.textAlign = 'center';
  resultNav.style.margin = '18px 0 10px 0';
  resultNav.innerHTML = `
    <button id="brrrrResultBack" class="brrrr-btn secondary" style="margin-right:12px;">Back</button>
    <button id="brrrrResultStartOver" class="brrrr-btn">Start Over</button>
  `;
  stepsArea.appendChild(resultNav);
  calculateSummary();
  // Add event listeners for result nav
  setTimeout(() => {
    const backBtn = document.getElementById('brrrrResultBack');
    const startOverBtn = document.getElementById('brrrrResultStartOver');
    if (backBtn) backBtn.onclick = () => {
      // Hide download PDF button and summary/chart when going back
      const dlBtn = document.getElementById('brrrrDownload');
      if (dlBtn) dlBtn.style.display = 'none';
      summaryDiv.style.display = 'none';
      let chartsDiv = document.getElementById('brrrrCharts');
      if (chartsDiv) chartsDiv.style.display = 'none';
      current = steps.length - 2;
      renderStep(current);
    };
    if (startOverBtn) startOverBtn.onclick = () => {
      // Hide download PDF button and summary/chart when starting over
      const dlBtn = document.getElementById('brrrrDownload');
      if (dlBtn) dlBtn.style.display = 'none';
      summaryDiv.style.display = 'none';
      let chartsDiv = document.getElementById('brrrrCharts');
      if (chartsDiv) chartsDiv.style.display = 'none';
      stepsArea.innerHTML = '';
      current = 0;
      renderStep(current);
    };
  }, 10);
  if (n === 0) setupAddressAutocomplete();
};

      // Store all user input here
      window.brrrrData = window.brrrrData || {};
      function saveStepData() {
        // Save all current step's input values to brrrrData
        const allInputs = stepsArea.querySelectorAll('input,textarea');
        allInputs.forEach(input => {
          brrrrData[input.id] = input.value;
        });
      }
      }

      function parseCurrency(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        return Number(String(val).replace(/[^0-9.-]+/g, '')) || 0;
      }

      function calculateSummary() {
        // Use values from brrrrData, not DOM
        const purchasePrice = parseCurrency(brrrrData['purchasePrice']);
        const rehab = parseCurrency(brrrrData['rehab']);
        // Use loans if any, otherwise fallback to old fields
        let totalFinanced = 0, purchaseRate = 0, purchaseTerm = 0, purchaseMonthly = 0;
        if (typeof loans !== 'undefined' && loans.length > 0) {
          totalFinanced = loans.reduce((sum, l) => sum + Number(l.financed || 0), 0);
          // Use weighted average for rate and max term
          let total = 0, weight = 0, maxTerm = 0;
          loans.forEach(l => {
            const amt = Number(l.financed || 0);
            if (amt > 0) {
              total += amt * (Number(l.rate || 0) / 100);
              weight += amt;
            }
            if (Number(l.term || 0) > maxTerm) maxTerm = Number(l.term || 0);
            // Calculate monthly payment for each loan
            if (l.type === 'Interest-Only') {
              purchaseMonthly += amt * (Number(l.rate || 0) / 100) / 12;
            } else if (l.type === 'Amortized') {
              const n = Number(l.term || 0);
              const r = Number(l.rate || 0) / 100 / 12;
              if (amt > 0 && r > 0 && n > 0) {
                purchaseMonthly += r === 0 ? amt / n : (amt * r) / (1 - Math.pow(1 + r, -n));
              }
            }
          });
          purchaseRate = weight > 0 ? (total / weight) * 100 : 0;
          purchaseTerm = maxTerm;
        } else {
          purchaseRate = Number(brrrrData['purchaseRate']) || 0;
          purchaseTerm = Number(brrrrData['purchaseTerm']) || 0;
          totalFinanced = purchasePrice; // fallback
          // Fallback single loan monthly payment
          if (totalFinanced > 0 && purchaseRate > 0 && purchaseTerm > 0) {
            const n = purchaseTerm;
            const r = purchaseRate / 100 / 12;
            purchaseMonthly = r === 0 ? totalFinanced / n : (totalFinanced * r) / (1 - Math.pow(1 + r, -n));
          }
        }
        // Use aggregate of all refi loans if present, else fallback to old field
        let refiAmount = 0, refiRate = 0, refiTerm = 0;
        if (typeof refiLoans !== 'undefined' && refiLoans.length > 0) {
          refiAmount = refiLoans.reduce((sum, l) => sum + Number(l.financed || 0), 0);
          // Use weighted average for rate and max term
          let total = 0, weight = 0, maxTerm = 0;
          refiLoans.forEach(l => {
            const amt = Number(l.financed || 0);
            if (amt > 0) {
              total += amt * (Number(l.rate || 0) / 100);
              weight += amt;
            }
            if (Number(l.term || 0) > maxTerm) maxTerm = Number(l.term || 0);
          });
          refiRate = weight > 0 ? (total / weight) * 100 : 0;
          refiTerm = maxTerm;
        } else {
          refiAmount = parseCurrency(brrrrData['refiAmount']);
          refiRate = Number(brrrrData['refiRate']) || 0;
          refiTerm = Number(brrrrData['refiTerm']) || 0;
        }
        const refiCosts = parseCurrency(brrrrData['refiCosts']);
        const rent = parseCurrency(brrrrData['rent']);
        const rentIncrease = Number(brrrrData['rentIncrease']) || 0;
        const taxes = parseCurrency(brrrrData['taxes']);
        const insurance = parseCurrency(brrrrData['insurance']);
        const otherExpenses = parseCurrency(brrrrData['otherExpenses']);
        const expenseIncrease = Number(brrrrData['expenseIncrease']) || 0;
        const appreciation = Number(brrrrData['appreciation']) || 0;

        // Calculations
        const totalInvestment = purchasePrice + rehab + refiCosts;
        // totalLoanMonthly is now purchaseMonthly (from above)
        let totalLoanMonthly = purchaseMonthly;
        // Correct refi monthly payment calculation (standard amortization)
        let refiMonthly = 0;
        if (typeof refiLoans !== 'undefined' && refiLoans.length > 0) {
          refiLoans.forEach(l => {
            const amt = Number(l.financed || 0);
            const rate = Number(l.rate || 0);
            const term = Number(l.term || 0);
            if (l.type === 'Interest-Only') {
              refiMonthly += amt * (rate / 100) / 12;
            } else if (l.type === 'Amortized') {
              const n = term * 12;
              const r = rate / 100 / 12;
              if (amt > 0 && r > 0 && n > 0) {
                refiMonthly += r === 0 ? amt / n : (amt * r) / (1 - Math.pow(1 + r, -n));
              }
            }
          });
        } else if (refiAmount > 0 && refiRate > 0 && refiTerm > 0) {
          const n = refiTerm * 12;
          const r = refiRate / 100 / 12;
          refiMonthly = r === 0 ? refiAmount / n : (refiAmount * r) / (1 - Math.pow(1 + r, -n));
        }
        const totalMonthlyExpenses = taxes + insurance + otherExpenses + totalLoanMonthly;
        const cashFlow = rent - totalMonthlyExpenses - refiMonthly;

        // Appreciation (simple, 1 year)
        const appreciatedValue = purchasePrice * Math.pow(1 + appreciation/100, 1);

        // Output
        // Property Info block
        const propStreet = brrrrData['street'] || '';
        const propCity = brrrrData['city'] || '';
        const propState = brrrrData['state'] || '';
        const propZip = brrrrData['zip'] || '';
        const propFeatures = brrrrData['features'] || '';
        let propInfoHtml = '';
        if (propStreet || propCity || propState || propZip || propFeatures) {
          propInfoHtml = `
            <div class="brrrr-summary-prop" style="background:#fffbe7;border-radius:10px;padding:16px 18px 10px 18px;margin-bottom:18px;box-shadow:0 2px 8px rgba(255,200,40,0.07);border:1.2px solid #f3e7b3;">
              <div style="font-weight:700;color:#b48a00;font-size:1.08em;margin-bottom:2px;display:flex;align-items:center;gap:7px;"><span style='font-size:1.2em;'>ð</span>Property Info</div>
              <div style="color:#1a2a4f;font-weight:600;">${propStreet ? propStreet : ''}${(propStreet && (propCity||propState||propZip)) ? ', ' : ''}${propCity ? propCity+', ' : ''}${propState ? propState+' ' : ''}${propZip ? propZip : ''}</div>
              ${propFeatures ? `<div style='color:#555;margin-top:4px;font-size:0.98em;'>${propFeatures}</div>` : ''}
            </div>
          `;
        }
        let purchaseLoanBreakdown = '';
        if (typeof loans !== 'undefined' && loans.length > 0) {
          purchaseLoanBreakdown = `<details style='margin:6px 0 0 0;'><summary style='cursor:pointer;font-size:0.98em;color:#2E8B57;'>View Purchase Loan Breakdown</summary><div style='padding:6px 0 0 10px;'>` +
            loans.map((l,i) => `<div style='font-size:0.97em;margin-bottom:2px;'><strong>${l.label}</strong>: $${Number(l.financed).toLocaleString()} - ${l.type} @ ${l.rate}% - term ${l.term || 'N/A'} mo</div>`).join('') +
            `</div></details>`;
        }
        let refiLoanBreakdown = '';
        if (typeof refiLoans !== 'undefined' && refiLoans.length > 0) {
          refiLoanBreakdown = `<details style='margin:6px 0 0 0;'><summary style='cursor:pointer;font-size:0.98em;color:#1a2a4f;'>View Refinance Loan Breakdown</summary><div style='padding:6px 0 0 10px;'>` +
            refiLoans.map((l,i) => `<div style='font-size:0.97em;margin-bottom:2px;'><strong>${l.label}</strong>: $${Number(l.financed).toLocaleString()} - ${l.type} @ ${l.rate}% - term ${l.term || 'N/A'} yrs</div>`).join('') +
            `</div></details>`;
        }
        summaryDiv.innerHTML = `
          ${propInfoHtml}
          <ul class="brrrr-summary-list">
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ð°</span>Total Investment:</span> <span class="brrrr-summary-value">$${totalInvestment.toLocaleString()}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ðµ</span>Purchase Loan Amount:</span> <span class="brrrr-summary-value">$${totalFinanced.toLocaleString()}</span></li>
            ${purchaseLoanBreakdown ? `<li style='background:#f8fafb;'>${purchaseLoanBreakdown}</li>` : ''}
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ð¦</span>Refinance Loan Amount:</span> <span class="brrrr-summary-value">$${refiAmount.toLocaleString()}</span></li>
            ${refiLoanBreakdown ? `<li style='background:#f8fafb;'>${refiLoanBreakdown}</li>` : ''}
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ð </span>Monthly Rent:</span> <span class="brrrr-summary-value">$${rent.toLocaleString()}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ð§¾</span>Total Monthly Expenses:</span> <span class="brrrr-summary-value">$${totalMonthlyExpenses.toLocaleString()}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ð¸</span>Estimated Monthly Cash Flow:</span> <span class="brrrr-summary-value${cashFlow>=0?'':' negative'}">$${cashFlow.toLocaleString()}</span></li>
            <li><span class="brrrr-summary-label"><span class="brrrr-summary-icon">ð</span>Appreciated Value (1yr):</span> <span class="brrrr-summary-value">$${appreciatedValue.toLocaleString()}</span></li>
          </ul>
        `;
        // Show export area
        const exportArea = document.getElementById('brrrrExportArea');
        summaryDiv.style.display = 'block';
        if (exportArea) exportArea.style.display = 'block';

        // --- Charts ---
        let chartsDiv = document.getElementById('brrrrCharts');
        if (!chartsDiv) return;
        chartsDiv.innerHTML = `<div style="display:flex;justify-content:center;"><canvas id="brrrrPie" width="600" height="400"></canvas></div>`;
        chartsDiv.style.display = 'block';

        // Load Chart.js if not present
        function loadScript(src, cb) {
          if (window.Chart) { cb(); return; }
          if (document.querySelector(`script[src='${src}']`)) { document.querySelector(`script[src='${src}']`).addEventListener('load', cb); return; }
          const s = document.createElement('script');
          s.src = src; s.onload = cb; document.body.appendChild(s);
        }
        loadScript('https://cdn.jsdelivr.net/npm/chart.js', function() {
          new Chart(document.getElementById('brrrrPie').getContext('2d'), {
            type: 'pie',
            data: {
              labels: ['Rent', 'Expenses', 'Refi Payment', 'Cash Flow'],
              datasets: [{
                data: [rent, totalMonthlyExpenses, refiMonthly, cashFlow],
                backgroundColor: ['#2E8B57', '#b00020', '#1a2a4f', cashFlow >= 0 ? '#2E8B57' : '#b00020']
              }]
            },
            options: {
              plugins: { legend: { position: 'bottom' } },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        });

        // Show download button and clear any previous error
        const dlBtn = document.getElementById('brrrrDownload');
        const pdfErr = document.getElementById('brrrrPdfError');
        if (dlBtn) dlBtn.style.display = 'block';
        if (pdfErr) { pdfErr.style.display = 'none'; pdfErr.textContent = ''; }
      }

      // Download PDF logic

      function downloadPDF() {
        const pdfErr = document.getElementById('brrrrPdfError');
        if (pdfErr) { pdfErr.style.display = 'none'; pdfErr.textContent = ''; }
        // Helper to load scripts with retry
        function loadScript(src, globalName, cb, retry) {
          if (window[globalName]) { cb(); return; }
          let script = document.querySelector('script[src="'+src+'"]');
          if (!script) {
            script = document.createElement('script');
            script.src = src;
            script.onload = function() { setTimeout(cb, 50); };
            script.onerror = function() {
              if (retry) setTimeout(() => loadScript(src, globalName, cb, false), 400);
              else if (pdfErr) { pdfErr.textContent = 'Failed to load PDF library: '+src; pdfErr.style.display = 'block'; }
            };
            document.body.appendChild(script);
          } else {
            script.addEventListener('load', function handler() { script.removeEventListener('load', handler); setTimeout(cb, 50); });
          }
        }
        loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js', 'html2canvas', function() {
          // Assign html2canvas globally for GHL and fallback
          if (window.html2canvas) window.html2canvas = window.html2canvas;
          if (!window.html2canvas && window.parent && window.parent.html2canvas) window.html2canvas = window.parent.html2canvas;
          if (!window.html2canvas && window.top && window.top.html2canvas) window.html2canvas = window.top.html2canvas;
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', 'jspdf', function() {
            // GHL sometimes puts jsPDF in window.jspdf.jsPDF
            var jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : (window.jsPDF || (window.jspdf ? window.jspdf : null));
            // Assign jsPDF globally for GHL and fallback
            if (window.jspdf && window.jspdf.jsPDF) window.jsPDF = window.jspdf.jsPDF;
            if (!jsPDF && window.parent && window.parent.jspdf && window.parent.jspdf.jsPDF) window.jsPDF = window.parent.jspdf.jsPDF;
            if (!jsPDF && window.top && window.top.jspdf && window.top.jspdf.jsPDF) window.jsPDF = window.top.jspdf.jsPDF;
            if (!window.html2canvas || !jsPDF) {
              if (pdfErr) {
                pdfErr.innerHTML = 'PDF libraries failed to load. <br>Please try again, reload the page, or use your browser\'s <b>Print</b> (Ctrl+P) and choose <b>Save as PDF</b> as a fallback.';
                pdfErr.style.display = 'block';
              }
              return;
            }
            // Only export the summary+chart area, not the whole page, and guarantee no background bleed
            const exportArea = document.getElementById('brrrrExportArea');
            if (!exportArea) {
              if (pdfErr) {
                pdfErr.innerHTML = 'Export area not found.';
                pdfErr.style.display = 'block';
              }
              return;
            }
            // Clone export area into a fixed overlay with white background and high z-index
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = '#fff';
            overlay.style.zIndex = '999999';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.overflow = 'auto';
            // Center the clone inside overlay
            const clone = exportArea.cloneNode(true);
            clone.style.display = 'block';
            clone.style.background = '#fff';
            clone.style.boxShadow = '0 0 32px rgba(0,0,0,0.08)';
            overlay.appendChild(clone);
            document.body.appendChild(overlay);
            // Copy chart canvas image into the clone
            const origCanvas = document.getElementById('brrrrPie');
            if (origCanvas) {
              const origImg = origCanvas.toDataURL('image/png');
              // Find the canvas in the clone
              const cloneCanvas = clone.querySelector('#brrrrPie');
              if (cloneCanvas && cloneCanvas.getContext) {
                const ctx = cloneCanvas.getContext('2d');
                const img = new window.Image();
                img.onload = function() {
                  ctx.clearRect(0, 0, cloneCanvas.width, cloneCanvas.height);
                  ctx.drawImage(img, 0, 0, cloneCanvas.width, cloneCanvas.height);
                };
                img.src = origImg;
              }
            }
            // Expand all <details> elements in the clone before generating PDF
            setTimeout(function() {
              Array.from(clone.querySelectorAll('details')).forEach(function(d) { d.open = true; });
              window.html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#fff' }).then(function(canvas) {
                document.body.removeChild(overlay);
                const img = canvas.toDataURL('image/jpeg', 0.98);
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = pdf.internal.pageSize.getHeight();
                const margin = 20;
                let imgW = pdfW - margin * 2;
                let imgH = (canvas.height * imgW) / canvas.width;
                if (imgH > pdfH - margin * 2) {
                  imgH = pdfH - margin * 2;
                  imgW = (canvas.width * imgH) / canvas.height;
                }
                const x = (pdfW - imgW) / 2;
                const y = margin;
                pdf.addImage(img, 'JPEG', x, y, imgW, imgH);
                pdf.save('UTAHREIA_BRRRR_Report.pdf');
              });
            }, 200);
          }, true);
        }, true);
      }

      // (No-op: event listener now attached after each render)

      // Initial render
      renderStep(current);

    })();
  </script>
</body>
</html>